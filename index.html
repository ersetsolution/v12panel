<!DOCTYPE html>
<HTML LANG="id">
  <HEAD>
    <META CHARSET="UTF-8">
    <META NAME="viewport" CONTENT=
    "width=device-width, initial-scale=1.0">
    <TITLE>
      V12 Panel - Modern Tracking System
    </TITLE>
    <SCRIPT SRC="https://js.pusher.com/8.2.0/pusher.min.js">
    </SCRIPT>
    <STYLE>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Clean Modern Colors */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border: #334155;
            --border-light: #475569;
            
            /* Accent Colors */
            --blue: #3b82f6;
            --green: #10b981;
            --red: #ef4444;
            --orange: #f59e0b;
            --purple: #8b5cf6;
            
            /* Spacing */
            --radius: 8px;
            --radius-lg: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            z-index: 1000;
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            transform: translateX(-260px);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            margin-bottom: 0.25rem;
            padding: 0 0.75rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .nav-link:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: var(--blue);
            color: white;
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .nav-text {
            flex: 1;
        }

        .nav-badge {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            font-size: 0.6875rem;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .nav-badge.info { background: var(--blue); color: white; }
        .nav-badge.success { background: var(--green); color: white; }

        /* ===== MOBILE TOGGLE ===== */
        .mobile-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.5rem;
            color: var(--text-primary);
            cursor: pointer;
            display: none;
        }

        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        /* ===== MAIN LAYOUT ===== */
        .main-layout {
            margin-left: 260px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-layout.expanded {
            margin-left: 0;
        }

        .main-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-content {
            padding: 1.5rem;
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-compact {
            padding: 1rem;
            margin-bottom: 1rem;
        }

        /* ===== SCAN SECTION ===== */
        .scan-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .scan-title {
            margin-bottom: 1rem;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scan-input-wrapper {
            position: relative;
            margin-bottom: 0.75rem;
        }

        .scan-input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 0.9375rem;
            transition: border-color 0.2s;
        }

        .scan-input:focus {
            outline: none;
            border-color: var(--blue);
        }

        .scan-input::placeholder {
            color: var(--text-muted);
        }

        .scan-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--blue);
        }

        .scan-hint {
            color: var(--text-secondary);
            font-size: 0.8125rem;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 500;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-primary {
            background: var(--green);
            color: white;
        }

        .btn-primary:hover {
            background: #059669;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
        }

        .btn-danger {
            background: var(--red);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-info {
            background: var(--blue);
            color: white;
        }

        .btn-info:hover {
            background: #2563eb;
        }

        /* ===== TABS ===== */
        .tabs-nav {
            display: flex;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 0.25rem;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-btn.active {
            background: var(--blue);
            color: white;
        }

        .tab-btn:hover:not(.active) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab-badge {
            background: rgba(255, 255, 255, 0.2);
            color: inherit;
            padding: 0.125rem 0.375rem;
            border-radius: 8px;
            font-size: 0.6875rem;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        /* ===== CONTROLS BAR ===== */
        .controls-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--blue);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        /* ===== TABLES ===== */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
    .table td {
    padding: 0.375rem 0.5rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
    font-size: 0.8125rem;
    vertical-align: middle;
    line-height: 1.3;
    }

        .table th {
            background: var(--bg-primary);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            white-space: nowrap;
        }

        .table tr:hover {
            background: var(--bg-primary);
        }

        .table-checkbox {
            width: 16px;
            height: 16px;
            accent-color: var(--blue);
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    display: inline-block;
    text-align: center;
    min-width: 75px;
    white-space: nowrap;
    }

        .status-pending {
            background: var(--blue);
            color: white;
        }

        .status-delivered {
            background: var(--green);
            color: white;
        }

        .status-return {
            background: var(--red);
            color: white;
        }

        .status-error {
            background: var(--orange);
            color: white;
        }

        /* ===== COURIER BADGES ===== */
        .courier-badge {
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius);
            font-size: 0.6875rem;
            font-weight: 600;
            color: white;
            text-align: center;
            white-space: nowrap;
            display: inline-block;
            min-width: 60px;
            line-height: 1.2;
        }

        .courier-jnt { background: #EE1D23; }
        .courier-jne { background: #003168; }
        .courier-sicepat { background: #DA1F26; }
        .courier-sap { background: #6A1B9A; }
        .courier-shopee { background: #FB641B; }
        .courier-ninja { background: #D71920; }
        .courier-anteraja { background: #E91E63; }  
        .courier-unknown { background: var(--text-muted); }

        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);  /* 2 kolom equal */
            gap: 0.75rem;  /* lebih rapat */
            margin-bottom: 1.5rem;
        }

        .stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1rem;  /* dikurangin dari 1.25rem */
    position: relative;
    }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--blue);
            border-radius: 3px 0 0 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.8125rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .stat-value {
    font-size: 1.5rem;  /* dikurangin dari 2rem */
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    line-height: 1;
    }

        .stat-change {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* ===== MODALS ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            width: 90%;
            max-width: 600px;
            border: 1px solid var(--border);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--blue);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: var(--radius);
        }

        .close-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .bulk-textarea {
            width: 100%;
            min-height: 150px;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            resize: vertical;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .bulk-textarea:focus {
            outline: none;
            border-color: var(--blue);
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1rem;
            min-width: 300px;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success { border-left: 4px solid var(--green); }
        .toast-error { border-left: 4px solid var(--red); }
        .toast-info { border-left: 4px solid var(--blue); }

        /* ===== FORMS ===== */
       .settings-grid {
    display: grid;
    gap: 1.5rem;
    max-width: 100%;
    width: 100%;
    grid-template-columns: 1fr;
    }

    /* Desktop: 2 columns */
    @media (min-width: 1024px) {
    .settings-grid {
        grid-template-columns: 1fr 1fr;
        max-width: 1400px;
        margin: 0 auto;
    }
    }

    /* Large Desktop: 3 columns */
    @media (min-width: 1400px) {
    .settings-grid {
        grid-template-columns: repeat(3, 1fr);
        max-width: 1600px;
    }
    }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            color: var(--text-primary);
            margin-bottom: 0.375rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--blue);
        }

        .form-help {
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: 0.25rem;
            flex-wrap: nowrap;
            justify-content: center;
        }

        .action-buttons .btn {
            flex: none;
            min-width: 32px;
            justify-content: center;
            padding: 0.25rem 0.5rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            min-width: 32px;
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden { display: none !important; }
        .section { display: none; }
        .section.active { display: block; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .mobile-toggle { display: block; }
            .sidebar { transform: translateX(-260px); }
            .sidebar.open { transform: translateX(0); }
            .mobile-overlay.show { display: block; }
            .main-layout { margin-left: 0; }
            .main-header { padding-left: 3.5rem; }
            .main-content { padding: 1rem; }
            
            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input { min-width: auto; }
            .stats-grid { grid-template-columns: 1fr; }
            
            .table-container { overflow-x: auto; }
            .table { min-width: 630px; }
            
            .table th,
            .table td {
                padding: 0.375rem 0.4rem;
                font-size: 0.8125rem;
            }
            
            .action-buttons {
                flex-direction: row;
                gap: 0.25rem;
            }
            
            .action-buttons .btn {
                flex: none;
                min-width: 28px;
                padding: 0.25rem;
            }
            
            .courier-badge {
                font-size: 0.625rem;
                padding: 0.2rem 0.4rem;
                min-width: 50px;
            }
            
            .stats-grid { 
        grid-template-columns: 1fr;  /* balik ke 1 kolom di mobile */
    }
    }
        

        @media (max-width: 480px) {
            .main-content { padding: 0.75rem; }
            .card, .card-compact { padding: 1rem; }
            .stat-value { font-size: 1.5rem; }
            .modal-content { padding: 1rem; }
            
            .table { min-width: 750px; }
            .table th,
            .table td {
                padding: 0.3rem 0.35rem;
                font-size: 0.75rem;
            }
            
            .courier-badge {
                font-size: 0.5625rem;
                padding: 0.15rem 0.3rem;
                min-width: 45px;
            }
            
            .action-buttons .btn {
                min-width: 24px;
                padding: 0.2rem;
                font-size: 0.6875rem;
            }
        }

        /* ===== DETAIL MODAL SPECIFIC ===== */
        .detail-modal-content {
            max-width: 900px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
        }

        .detail-label {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 0.5rem;
            letter-spacing: 0.025em;
        }

        .detail-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .tracking-history {
            position: relative;
            padding-left: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .tracking-history::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .tracking-item {
            position: relative;
            margin-bottom: 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
        }

        .tracking-item::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 1rem;
            width: 8px;
            height: 8px;
            background: var(--blue);
            border-radius: 50%;
            border: 2px solid var(--bg-card);
        }

        .tracking-item:first-child::before {
            background: var(--green);
        }

        .tracking-date {
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 600;
            font-family: monospace;
            margin-bottom: 0.25rem;
        }

        .tracking-location {
            color: var(--blue);
            font-weight: 600;
            font-size: 0.8125rem;
            margin-bottom: 0.25rem;
        }

        .tracking-desc {
            color: var(--text-secondary);
            font-size: 0.8125rem;
            line-height: 1.4;
        }
        
       /* Top Ekspedisi Ranking */
    .ekspedisi-ranking {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    }

    .ranking-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    transition: all 0.2s ease;
    }

    .ranking-item:hover {
    background: var(--bg-tertiary);
    transform: translateX(5px);
    }

    .ranking-number {
    width: 30px;
    height: 30px;
    background: var(--blue);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.8rem;
    margin-right: 1rem;
    }

    .ranking-number.gold { background: #f59e0b; }
    .ranking-number.silver { background: #6b7280; }
    .ranking-number.bronze { background: #d97706; }

    .ranking-info {
    flex: 1;
    }

    .ekspedisi-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
    }

    .ekspedisi-count {
    color: var(--text-secondary);
    font-size: 0.8rem;
    }

    .ranking-percentage {
    color: var(--blue);
    font-weight: 600;
    font-size: 0.9rem;

    }

    /* Modern Card Styles */
    .modern-card {
    transition: all 0.3s ease;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    }

    .modern-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    .modern-card:hover::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.1);
    border-radius: inherit;
    pointer-events: none;
    }
    </STYLE>
    <SCRIPT SRC=
    "https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js">
    </SCRIPT>
  </HEAD>
  <BODY>
    <!-- ===== MOBILE TOGGLE ===== -->
     <BUTTON CLASS="mobile-toggle" ONCLICK=
    "toggleSidebar()"><SVG WIDTH="20" HEIGHT="20" VIEWBOX=
    "0 0 24 24" FILL="currentColor">
    <PATH D="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"></PATH>
    </SVG></BUTTON> <!-- ===== MOBILE OVERLAY ===== -->
    <DIV CLASS="mobile-overlay" ONCLICK="closeSidebar()"></DIV>
    
      
      
      <!-- ===== SIDEBAR ===== -->
    <ASIDE CLASS="sidebar" ID="sidebar">
      <DIV CLASS="sidebar-header">
        <DIV CLASS="logo">
          <SPAN>üöÄ</SPAN> <SPAN>CHEMZ SHOP</SPAN>
        </DIV>
      </DIV>
      <NAV CLASS="sidebar-nav">
        <DIV CLASS="nav-item">
          <BUTTON CLASS="nav-link active" DATA-SECTION=
          "scan"><SVG CLASS="nav-icon" VIEWBOX="0 0 24 24" FILL=
          "currentColor">
          <PATH D=
          "M3 7V5C3 3.89 3.89 3 5 3H7V5H5V7H3M17 3H19C20.11 3 21 3.89 21 5V7H19V5H17V3M21 17V19C21 20.11 20.11 21 19 21H17V19H19V17H21M7 21H5C3.89 21 3 20.11 3 19V17H5V19H7V21M9 7V9H15V7H9M11 11V13H13V11H11M9 15V17H15V15H9Z"></PATH>
          </SVG> <SPAN CLASS="nav-text">Scan Resi</SPAN></BUTTON>
        </DIV>
        <DIV CLASS="nav-item">
          <BUTTON CLASS="nav-link" DATA-SECTION=
          "tracking"><SVG CLASS="nav-icon" VIEWBOX="0 0 24 24"
          FILL="currentColor">
          <PATH D=
          "M18 8C18.34 8 18.67 8.04 19 8.09V2H5V22H12.81C12.28 21.09 12 20.05 12 19C12 15.69 14.69 13 18 13C18.34 13 18.67 13.04 19 13.09V11H5V13H10V15H5V17H9.09C9.04 17.33 9 17.66 9 18H5V20H10.09C10.89 21.28 12.28 22.09 13.81 22H19V16.91C18.67 16.96 18.34 17 18 17C14.69 17 12 14.31 12 11S14.69 5 18 5 24 7.69 24 11 21.31 17 18 17Z"></PATH>
          </SVG> <SPAN CLASS="nav-text">Tracking Resi</SPAN>
          <SPAN CLASS="nav-badge info" ID=
          "totalResiCount">0</SPAN></BUTTON>
        </DIV>
        <DIV CLASS="nav-item">
          <BUTTON CLASS="nav-link" DATA-SECTION=
          "dashboard"><SVG CLASS="nav-icon" VIEWBOX="0 0 24 24"
          FILL="currentColor">
          <PATH D=
          "M3 3H11V11H3V3M13 3H21V11H13V3M3 13H11V21H3V13M13 13H21V21H13V13Z"></PATH>
          </SVG> <SPAN CLASS="nav-text">Dashboard</SPAN></BUTTON>
        </DIV>
        <DIV CLASS="nav-item">
          <BUTTON CLASS="nav-link" DATA-SECTION=
          "inventory"><SVG CLASS="nav-icon" VIEWBOX="0 0 24 24"
          FILL="currentColor">
          <PATH D=
          "M20 8H4V6C4 4.89 4.89 4 6 4H18C19.11 4 20 4.89 20 6V8M5 10V19H19V10H5M12 12C13.11 12 14 12.89 14 14S13.11 16 12 16 10 15.11 10 14 10.89 12 12 12Z"></PATH>
          </SVG> <SPAN CLASS="nav-text">Inventory</SPAN>
          <SPAN CLASS="nav-badge" ID=
          "lowStockCount">0</SPAN></BUTTON>
        </DIV>
        <DIV CLASS="nav-item">
          <BUTTON CLASS="nav-link" DATA-SECTION=
          "ai-intelligence"><SPAN CLASS="nav-icon">ü§ñ</SPAN>
          <SPAN CLASS="nav-text">AI Intelligence</SPAN>
          <SPAN CLASS="nav-badge info" ID=
          "autoCheckStatus">OFF</SPAN></BUTTON>
        </DIV>
        <!-- TAMBAH INI SETELAH AI Intelligence -->
        <DIV CLASS="nav-item">
          <BUTTON CLASS="nav-link" DATA-SECTION=
          "auto-reports"><SVG CLASS="nav-icon" VIEWBOX="0 0 24 24"
          FILL="currentColor">
          <PATH D=
          "M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></PATH>
          </SVG> <SPAN CLASS="nav-text">Auto Reports</SPAN>
          <SPAN CLASS="nav-badge" ID=
          "autoReportsStatus">OFF</SPAN></BUTTON>
        </DIV>
        <!-- SETELAH AUTO REPORTS MENU -->
        <DIV CLASS="nav-item">
          <BUTTON CLASS="nav-link" DATA-SECTION="customer-engagement">
            <SVG CLASS="nav-icon" VIEWBOX="0 0 24 24" FILL="currentColor">
              <PATH D="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25Z"/>
            </SVG>
            <SPAN CLASS="nav-text">Customer Engagement</SPAN>
            <SPAN CLASS="nav-badge" ID="customerEngagementCount">0</SPAN>
          </BUTTON>
        </DIV>
        <DIV CLASS="nav-item" STYLE=
        "margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem;">
          <BUTTON CLASS="nav-link" DATA-SECTION=
          "settings"><SVG CLASS="nav-icon" VIEWBOX="0 0 24 24"
          FILL="currentColor">
          <PATH D=
          "M12 8C9.79 8 8 9.79 8 12S9.79 16 12 16 16 14.21 16 12 14.21 8 12 8M12 14C10.9 14 10 13.11 10 12S10.9 10 12 10 14 10.9 14 12 13.11 14 12 14M19.43 12.98C19.47 12.66 19.5 12.34 19.5 12S19.47 11.34 19.43 11.02L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.96 19.05 5.05L16.56 6.05C16.04 5.65 15.5 5.32 14.87 5.07L14.5 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.5 2.42L9.13 5.07C8.5 5.32 7.96 5.65 7.44 6.05L4.95 5.05C4.73 4.96 4.46 5.05 4.34 5.27L2.34 8.73C2.22 8.95 2.27 9.22 2.46 9.37L4.57 11.02C4.53 11.34 4.5 11.66 4.5 12S4.53 12.66 4.57 12.98L2.46 14.63C2.27 14.78 2.22 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.04 4.95 18.95L7.44 17.95C7.96 18.35 8.5 18.68 9.13 18.93L9.5 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.5 21.58L14.87 18.93C15.5 18.68 16.04 18.35 16.56 17.95L19.05 18.95C19.27 19.04 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.98Z"></PATH>
          </SVG> <SPAN CLASS="nav-text">Settings</SPAN></BUTTON>
        </DIV>
      </NAV>
    </ASIDE><!-- ===== MAIN LAYOUT ===== -->
    <DIV CLASS="main-layout" ID="mainLayout">
      <!-- ===== MAIN HEADER ===== -->
      <HEADER CLASS="main-header">
        <H1 CLASS="page-title" ID="pageTitle">
          <SVG WIDTH="24" HEIGHT="24" VIEWBOX="0 0 24 24" FILL=
          "currentColor">
          <PATH D=
          "M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l4.27 4.27-1.41 1.41-4.27-4.27A6.45 6.45 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7.01 5 5 7.01 5 9.5S7.01 14 9.5 14 14 11.99 14 9.5 11.99 5 9.5 5Z"></PATH>
          </SVG> Scan Resi
        </H1>
      </HEADER>
      
      
      
      
      
      
      <!-- ===== MAIN CONTENT ===== -->
      <MAIN CLASS="main-content">
        <!-- ===== SCAN RESI SECTION ===== -->
        <SECTION ID="scan" CLASS="section active">
          <DIV CLASS="scan-container">
            <H2 CLASS="scan-title">
              <SVG CLASS="nav-icon" VIEWBOX="0 0 24 24" FILL=
              "currentColor">
              <PATH D=
              "M18 8C18.34 8 18.67 8.04 19 8.09V2H5V22H12.81C12.28 21.09 12 20.05 12 19C12 15.69 14.69 13 18 13C18.34 13 18.67 13.04 19 13.09V11H5V13H10V15H5V17H9.09C9.04 17.33 9 17.66 9 18H5V20H10.09C10.89 21.28 12.28 22.09 13.81 22H19V16.91C18.67 16.96 18.34 17 18 17C14.69 17 12 14.31 12 11S14.69 5 18 5 24 7.69 24 11 21.31 17 18 17Z"></PATH>
              </SVG> SCAN RESI DISINI (ENTER UNTUK SIMPAN)
            </H2>
            <DIV CLASS="scan-input-wrapper">
              <INPUT TYPE="text" ID="scanInput" CLASS="scan-input"
              PLACEHOLDER="Scan atau ketik nomor resi..."
              AUTOCOMPLETE="off"> <SVG CLASS="scan-icon" VIEWBOX=
              "0 0 24 24" FILL="currentColor">
              <PATH D=
              "M4 4h6v2H4V4zm0 14h6v2H4v-2zm16-8h-2V4h-6v2h6v6zm-2 8v-6h-6v-2h6v6h2v2z"></PATH>
              </SVG>
            </DIV>
            <DIV CLASS="scan-hint">
              üí° Tips: Scan barcode atau ketik manual. Ekspedisi
              akan terdeteksi otomatis.
            </DIV>
          </DIV><!-- Bulk Import Button -->
          <DIV STYLE="margin-bottom: 1.5rem;">
            <BUTTON CLASS="btn btn-secondary" ONCLICK=
            "openBulkImport()"><SVG WIDTH="16" HEIGHT="16" VIEWBOX=
            "0 0 24 24" FILL="currentColor">
            <PATH D=
            "M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></PATH>
            </SVG> Import Resi Bulk</BUTTON>
          </DIV><!-- Scan Results Preview -->
          <DIV ID="scanResults" CLASS="table-container hidden">
            <TABLE CLASS="table">
              <THEAD>
                <TR>
                  <TH>
                    No
                  </TH>
                  <TH>
                    Tanggal
                  </TH>
                  <TH>
                    No Resi
                  </TH>
                  <TH>
                    Ekspedisi
                  </TH>
                  <TH>
                    Jam
                  </TH>
                  <TH>
                    Status
                  </TH>
                  <TH>
                    Action
                  </TH>
                </TR>
              </THEAD>
              <TBODY ID="scanTableBody"></TBODY>
            </TABLE>
          </DIV>
        </SECTION><!-- ===== TRACKING SECTION ===== -->
        <SECTION ID="tracking" CLASS="section">
          <DIV CLASS="tabs-nav">
            <BUTTON CLASS="tab-btn active" DATA-TAB=
            "proses"><SVG WIDTH="16" HEIGHT="16" VIEWBOX=
            "0 0 24 24" FILL="currentColor">
            <PATH D=
            "M12,1L3,5V11C3,16.55 6.84,21.74 12,22C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V14.5C14.8,16.9 13.4,18.5 12,18.5C10.6,18.5 9.2,16.9 9.2,14.5V10C9.2,8.6 10.6,7 12,7Z"></PATH>
            </SVG> Proses <SPAN CLASS="tab-badge" ID=
            "prosesCount">0</SPAN></BUTTON> <BUTTON CLASS="tab-btn"
            DATA-TAB="delivered"><SVG WIDTH="16" HEIGHT="16"
            VIEWBOX="0 0 24 24" FILL="currentColor">
            <PATH D=
            "M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></PATH>
            </SVG> Delivered <SPAN CLASS="tab-badge" ID=
            "deliveredCount">0</SPAN></BUTTON> <BUTTON CLASS=
            "tab-btn" DATA-TAB="return"><SVG WIDTH="16" HEIGHT="16"
            VIEWBOX="0 0 24 24" FILL="currentColor">
            <PATH D=
            "M12,6V9L16,5L12,1V4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12H18A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6Z"></PATH>
            </SVG> Return <SPAN CLASS="tab-badge" ID=
            "returnCount">0</SPAN></BUTTON>
          </DIV><!-- Controls Bar -->
          <DIV CLASS="controls-bar">
            <INPUT TYPE="text" CLASS="search-input" PLACEHOLDER=
            "üîç Cari no resi, nama, ekspedisi..." ID="searchInput">
            <BUTTON CLASS="btn btn-primary" ONCLICK=
            "checkSelectedResi()"><SVG WIDTH="16" HEIGHT="16"
            VIEWBOX="0 0 24 24" FILL="currentColor">
            <PATH D=
            "M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></PATH>
            </SVG> Cek Terpilih</BUTTON> <BUTTON CLASS=
            "btn btn-info" ONCLICK="checkAllPending()"><SVG WIDTH=
            "16" HEIGHT="16" VIEWBOX="0 0 24 24" FILL=
            "currentColor">
            <PATH D=
            "M12,6V9L16,5L12,1V4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12H18A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6Z"></PATH>
            </SVG> Cek Semua</BUTTON> <SELECT CLASS="form-input"
            ID="filterStatus" STYLE="width: auto; padding: 0.5rem;"
            ONCHANGE="applyFilters()">
              <OPTION VALUE="">
                Semua Status
              </OPTION>
              <OPTION VALUE="Pending">
                Pending
              </OPTION>
              <OPTION VALUE="DELIVERED">
                Delivered
              </OPTION>
              <OPTION VALUE="Error">
                Error
              </OPTION>
            </SELECT> <SELECT CLASS="form-input" ID="filterCourier"
            STYLE="width: auto; padding: 0.5rem;" ONCHANGE=
            "applyFilters()">
              <OPTION VALUE="">
                Semua Kurir
              </OPTION>
              <OPTION VALUE="J&amp;T Express">
                J&amp;T Express
              </OPTION>
              <OPTION VALUE="JNE">
                JNE
              </OPTION>
              <OPTION VALUE="SiCepat Express">
                SiCepat Express
              </OPTION>
              <OPTION VALUE="SAP Express">
                SAP Express
              </OPTION>
              <OPTION VALUE="Shopee Express">
                Shopee Express
              </OPTION>
              <OPTION VALUE="Ninja Express">
                Ninja Express
              </OPTION>
            </SELECT>
          </DIV><!-- Tab Content -->
          <DIV CLASS="tab-content">
            <DIV ID="proses-tab" CLASS="tab-panel active">
              <DIV CLASS="table-container">
                <TABLE CLASS="table">
                  <THEAD>
                    <TR>
                      <TH STYLE="width: 40px;">
                        <INPUT TYPE="checkbox" CLASS=
                        "table-checkbox" ID="selectAllProses">
                      </TH>
                      <TH STYLE="width: 50px;">
                        No
                      </TH>
                      <TH STYLE="width: 110px;">
                        Tanggal
                      </TH>
                      <TH STYLE="width: 130px;">
                        No Resi
                      </TH>
                      <TH STYLE="width: 110px;">
                        Ekspedisi
                      </TH>
                      <TH STYLE="width: 80px;">
                        Jam
                      </TH>
                      <TH STYLE="width: 90px;">
                        Status
                      </TH>
                      <TH STYLE="width: 120px;">
                        Action
                      </TH>
                    </TR>
                  </THEAD>
                  <TBODY ID="prosesTableBody"></TBODY>
                </TABLE>
              </DIV>
            </DIV>
            <DIV ID="delivered-tab" CLASS="tab-panel">
              <DIV CLASS="table-container">
                <TABLE CLASS="table">
                  <THEAD>
                    <TR>
                      <TH STYLE="width: 40px;">
                        <INPUT TYPE="checkbox" CLASS=
                        "table-checkbox" ID="selectAllDelivered">
                      </TH>
                      <TH STYLE="width: 50px;">
                        No
                      </TH>
                      <TH STYLE="width: 110px;">
                        Tanggal
                      </TH>
                      <TH STYLE="width: 130px;">
                        No Resi
                      </TH>
                      <TH STYLE="width: 110px;">
                        Ekspedisi
                      </TH>
                      <TH STYLE="width: 90px;">
                        Status
                      </TH>
                      <TH STYLE="width: 130px;">
                        Penerima
                      </TH>
                      <TH STYLE="width: 110px;">
                        Tgl Diterima
                      </TH>
                      <TH STYLE="width: 100px;">
                        Action
                      </TH>
                    </TR>
                  </THEAD>
                  <TBODY ID="deliveredTableBody"></TBODY>
                </TABLE>
              </DIV>
            </DIV>
            <DIV ID="return-tab" CLASS="tab-panel">
              <DIV CLASS="table-container">
                <TABLE CLASS="table">
                  <THEAD>
                    <TR>
                      <TH STYLE="width: 40px;">
                        <INPUT TYPE="checkbox" CLASS=
                        "table-checkbox" ID="selectAllReturn">
                      </TH>
                      <TH STYLE="width: 50px;">
                        No
                      </TH>
                      <TH STYLE="width: 110px;">
                        Tanggal
                      </TH>
                      <TH STYLE="width: 130px;">
                        No Resi
                      </TH>
                      <TH STYLE="width: 100px;">
                        Ekspedisi
                      </TH>
                      <TH STYLE="width: 120px;">
                        Status
                      </TH>
                      <TH STYLE="width: 80px;">
                        Action
                      </TH>
                    </TR>
                  </THEAD>
                  <TBODY ID="returnTableBody"></TBODY>
                </TABLE>
              </DIV>
            </DIV>
          </DIV>
        </SECTION><!-- ===== DASHBOARD SECTION ===== -->
        <SECTION ID="dashboard" CLASS="section">
          <DIV STYLE=
          "display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
            <H2 STYLE=
            "color: var(--text-primary); font-size: 1.25rem; font-weight: 600;">
              Dashboard Bulanan
            </H2><SELECT ID="monthSelector" CLASS="form-input"
            STYLE="width: auto;">
              <OPTION VALUE="2025-07">
                Juli 2025
              </OPTION>
              <OPTION VALUE="2025-06">
                Juni 2025
              </OPTION>
              <OPTION VALUE="2025-05">
                Mei 2025
              </OPTION>
            </SELECT>
          </DIV><!-- Stats Cards -->
          <DIV CLASS="stats-grid">
            <DIV CLASS="stat-card">
              <DIV CLASS="stat-label">
                üì¶ TOTAL PENGIRIMAN
              </DIV>
              <DIV CLASS="stat-value" ID="totalPengiriman">
                0
              </DIV>
              <DIV CLASS="stat-change">
                Dari database
              </DIV>
            </DIV>
            <DIV CLASS="stat-card">
              <DIV CLASS="stat-label">
                ‚úÖ SUCCESS RATE
              </DIV>
              <DIV CLASS="stat-value" ID="successRate">
                0<SPAN STYLE="font-size: 1rem;">%</SPAN>
              </DIV>
              <DIV CLASS="stat-change">
                Delivered packages
              </DIV>
            </DIV>
            <DIV CLASS="stat-card">
              <DIV CLASS="stat-label">
                üîÅ RETURN RATE
              </DIV>
              <DIV CLASS="stat-value" ID="returnRate">
                0<SPAN STYLE="font-size: 1rem;">%</SPAN>
              </DIV>
              <DIV CLASS="stat-change">
                Return packages
              </DIV>
            </DIV>
            <DIV CLASS="stat-card" ID="pendingCard">
              <DIV CLASS="stat-label">
                üìä SEDANG DALAM PERJALANAN
              </DIV>
              <DIV CLASS="stat-value" ID="pendingCount">
                0
              </DIV>
              <DIV CLASS="stat-change" ID="pendingBreakdown">
                Sedang diproses
              </DIV>
            </DIV>
          </DIV><!-- 2 Column Grid -->
          <DIV STYLE=
          "display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <!-- Chart Section (Left - Wider) -->
            <DIV CLASS="card">
              <DIV STYLE=
              "display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                <H3 STYLE=
                "color: var(--text-primary); font-size: 1.125rem; font-weight: 600;">
                  üìà Grafik Pengiriman - Juli 2025
                </H3>
                <DIV STYLE="display: flex; gap: 0.5rem;">
                  <BUTTON CLASS="btn btn-sm btn-secondary" ONCLICK=
                  "switchChart('daily')">Harian</BUTTON>
                  <BUTTON CLASS="btn btn-sm btn-secondary" ONCLICK=
                  "switchChart('weekly')">Mingguan</BUTTON>
                  <BUTTON CLASS="btn btn-sm btn-secondary active"
                  ONCLICK="switchChart('courier')">Per
                  Ekspedisi</BUTTON>
                </DIV>
              </DIV>
              <DIV STYLE="height: 300px; padding: 10px;">
                <CANVAS ID="dashboardChart"></CANVAS>
              </DIV>
            </DIV><!-- Right Column -->
            <DIV STYLE=
            "display: flex; flex-direction: column; gap: 1rem;">
              <!-- Target Harian Mini Widget -->
              <DIV CLASS="card card-compact">
                <H4 STYLE=
                "color: var(--blue); font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                  üéØ Target Harian
                </H4>
                <DIV ID="targetHarianWidget">
                  <!-- Target harian akan muncul di sini -->
                </DIV>
              </DIV><!-- Top 5 Ekspedisi -->
              <DIV CLASS="card">
                <H3 STYLE=
                "color: var(--text-primary); font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                  üèÜ Top 5 Ekspedisi - Juli 2025
                </H3>
                <DIV ID="topExpedisiWidget">
                  <!-- Ranking akan muncul di sini -->
                </DIV>
              </DIV>
            </DIV>
          </DIV>
        </SECTION><!-- ===== INVENTORY SECTION ===== -->
        <SECTION ID="inventory" CLASS="section">
          <DIV CLASS="tabs-nav">
            <BUTTON CLASS="tab-btn active" DATA-TAB=
            "master"><SVG WIDTH="16" HEIGHT="16" VIEWBOX=
            "0 0 24 24" FILL="currentColor">
            <PATH D=
            "M12,3C7.58,3 4,4.79 4,7C4,9.21 7.58,11 12,11C16.42,11 20,9.21 20,7C20,4.79 16.42,3 12,3M4,9V12C4,14.21 7.58,16 12,16C16.42,16 20,14.21 20,12V9C20,11.21 16.42,13 12,13C7.58,13 4,11.21 4,9M4,14V17C4,19.21 7.58,21 12,21C16.42,21 20,19.21 20,17V14C20,16.21 16.42,18 12,18C7.58,18 4,16.21 4,14Z"></PATH>
            </SVG> Master Produk</BUTTON> <BUTTON CLASS="tab-btn"
            DATA-TAB="movement"><SVG WIDTH="16" HEIGHT="16"
            VIEWBOX="0 0 24 24" FILL="currentColor">
            <PATH D=
            "M11,4H13V16L18.5,10.5L19.92,11.92L12,19.84L4.08,11.92L5.5,10.5L11,16V4Z"></PATH>
            </SVG> Stock Movement</BUTTON> <BUTTON CLASS="tab-btn"
            DATA-TAB="laporan"><SVG WIDTH="16" HEIGHT="16" VIEWBOX=
            "0 0 24 24" FILL="currentColor">
            <PATH D=
            "M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V5H19V19Z"></PATH>
            </SVG> Laporan Stock</BUTTON> <BUTTON CLASS="tab-btn"
            DATA-TAB="report"><SVG WIDTH="16" HEIGHT="16" VIEWBOX=
            "0 0 24 24" FILL="currentColor">
            <PATH D=
            "M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"></PATH>
            </SVG> Report</BUTTON>
          </DIV><!-- Tab Content -->
          <DIV CLASS="tab-content">
            <!-- TAB 1: MASTER PRODUK -->
            <DIV ID="master-tab" CLASS="tab-panel active">
              <DIV STYLE=
              "display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <H3 STYLE=
                "color: var(--text-primary); font-size: 1.125rem; font-weight: 600;">
                  üì¶ Master Produk
                </H3><BUTTON CLASS="btn btn-primary" ONCLICK=
                "openAddProduct()"><SVG WIDTH="16" HEIGHT="16"
                VIEWBOX="0 0 24 24" FILL="currentColor">
                <PATH D=
                "M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"></PATH>
                </SVG> Tambah Produk</BUTTON>
              </DIV>
              <DIV CLASS="card">
                <DIV STYLE=
                "display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 1rem;">
                  <!-- LEFT: Modern Search Box -->
                  <DIV STYLE=
                  "position: relative; flex: 1; max-width: 350px;">
                    <INPUT TYPE="text" CLASS="search-input"
                    PLACEHOLDER="Cari produk..." ID="productSearch"
                    STYLE=
                    "width: 100%; padding-left: 2.5rem; border-radius: 8px; border: 1px solid var(--border-light);">
                    <SVG STYLE=
                    "position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-muted); pointer-events: none;"
                    VIEWBOX="0 0 24 24" FILL="currentColor">
                    <PATH D=
                    "M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20.49,19.78L19.78,20.49L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7.01,5 5,7.01 5,9.5C5,11.99 7.01,14 9.5,14C11.99,14 14,11.99 14,9.5C14,7.01 11.99,5 9.5,5Z"></PATH>
                    </SVG>
                  </DIV><!-- CENTER: Last Updated Info -->
                  <DIV ID="lastUpdatedInfo" STYLE=
                  " background: var(--bg-primary); border: 1px solid var(--border-light); border-radius: 8px; padding: 0.75rem 1rem; color: var(--text-secondary); font-size: 0.8rem; white-space: nowrap; min-width: 200px;">
                    <DIV STYLE=
                    "display: flex; align-items: center; gap: 0.5rem;">
                      <SVG WIDTH="14" HEIGHT="14" VIEWBOX=
                      "0 0 24 24" FILL="currentColor" STYLE=
                      "color: var(--blue);">
                      <PATH D=
                      "M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"></PATH>
                      </SVG> <SPAN>Loading...</SPAN>
                    </DIV>
                  </DIV><!-- RIGHT: Modern Button Group -->
                  <DIV STYLE="display: flex; gap: 0.5rem;">
                    <BUTTON CLASS="btn btn-secondary btn-sm"
                    ONCLICK="refreshProducts()" TITLE=
                    "Refresh Data"><SVG WIDTH="16" HEIGHT="16"
                    VIEWBOX="0 0 24 24" FILL="currentColor">
                    <PATH D=
                    "M12,6V9L16,5L12,1V4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12H18A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6Z"></PATH>
                    </SVG></BUTTON> <BUTTON CLASS=
                    "btn btn-info btn-sm" ONCLICK=
                    "exportProducts()" TITLE=
                    "Export Data"><SVG WIDTH="16" HEIGHT="16"
                    VIEWBOX="0 0 24 24" FILL="currentColor">
                    <PATH D=
                    "M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></PATH>
                    </SVG></BUTTON>
                  </DIV>
                </DIV><!-- Helper Info -->
                <DIV STYLE=
                "text-align: center; color: var(--text-muted); font-size: 0.75rem; margin-bottom: 1rem; padding: 0.5rem; background: rgba(59,130,246,0.1); border-radius: 6px; border-left: 3px solid var(--blue);">
                  üí° <STRONG>Tips:</STRONG> Tekan Tombol Refresh
                  Jika Data Tidak Muncul
                </DIV>
                <DIV CLASS="table-container">
                  <TABLE CLASS="table">
                    <THEAD>
                      <TR>
                        <TH>
                          SKU
                        </TH>
                        <TH>
                          Nama Barang
                        </TH>
                        <TH>
                          Unit
                        </TH>
                        <TH>
                          Stok Awal
                        </TH>
                        <TH>
                          Harga
                        </TH>
                        <TH>
                          Action
                        </TH>
                      </TR>
                    </THEAD>
                    <TBODY ID="masterProductTableBody">
                      <TR>
                        <TD COLSPAN="6" STYLE=
                        "text-align: center; color: var(--text-muted); padding: 2rem;">
                          Belum ada produk. Klik "Tambah Produk"
                          untuk menambah.
                        </TD>
                      </TR>
                    </TBODY>
                  </TABLE>
                </DIV>
              </DIV>
            </DIV><!-- TAB 2: STOCK MOVEMENT -->
            <DIV ID="movement-tab" CLASS="tab-panel">
              <H3 STYLE=
              "color: var(--text-primary); font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                üì¶ Stock Movement
              </H3><!-- Toggle Button untuk Form -->
              <DIV STYLE="margin-bottom: 1.5rem;">
                <BUTTON CLASS="btn btn-primary" ONCLICK=
                "toggleMovementForm()" ID=
                "toggleFormBtn"><SVG WIDTH="16" HEIGHT="16"
                VIEWBOX="0 0 24 24" FILL="currentColor">
                <PATH D=
                "M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"></PATH>
                </SVG> Tambah Movement Baru</BUTTON>
              </DIV><!-- Movement Form (Hidden by default) -->
              <DIV CLASS="card" STYLE=
              "margin-bottom: 1.5rem; display: none;" ID=
              "movementFormCard">
                <H4 STYLE=
                "color: var(--blue); font-size: 1rem; margin-bottom: 1rem;">
                  Input Movement
                </H4>
                <DIV STYLE=
                "display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                  <DIV CLASS="form-group">
                    <LABEL CLASS="form-label">Type</LABEL>
                    <SELECT CLASS="form-input" ID="movementType">
                      <OPTION VALUE="in">
                        Stock IN (Masuk)
                      </OPTION>
                      <OPTION VALUE="out">
                        Stock OUT (Keluar)
                      </OPTION>
                    </SELECT>
                  </DIV>
                  <DIV CLASS="form-group">
                    <LABEL CLASS="form-label">Produk</LABEL>
                    <SELECT CLASS="form-input" ID=
                    "movementProduct">
                      <OPTION VALUE="">
                        Pilih Produk
                      </OPTION>
                    </SELECT>
                  </DIV>
                  <DIV CLASS="form-group">
                    <LABEL CLASS="form-label">Qty</LABEL>
                    <INPUT TYPE="number" CLASS="form-input" ID=
                    "movementQty" PLACEHOLDER="0" MIN="1">
                  </DIV>
                  <DIV CLASS="form-group">
                    <LABEL CLASS="form-label">Tanggal</LABEL>
                    <INPUT TYPE="date" CLASS="form-input" ID=
                    "movementDate">
                  </DIV>
                </DIV>
                <DIV CLASS="form-group" STYLE=
                "margin-bottom: 1rem;">
                  <LABEL CLASS="form-label">Notes</LABEL>
                  <INPUT TYPE="text" CLASS="form-input" ID=
                  "movementNotes" PLACEHOLDER=
                  "Catatan movement...">
                </DIV>
                <DIV STYLE="display: flex; gap: 1rem;">
                  <BUTTON CLASS="btn btn-primary" ONCLICK=
                  "saveMovement()"><SVG WIDTH="16" HEIGHT="16"
                  VIEWBOX="0 0 24 24" FILL="currentColor">
                  <PATH D=
                  "M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"></PATH>
                  </SVG> Simpan Movement</BUTTON> <BUTTON CLASS=
                  "btn btn-secondary" ONCLICK=
                  "closeMovementForm()">Batal</BUTTON>
                </DIV>
              </DIV><!-- Movement History -->
              <DIV CLASS="card">
                <DIV STYLE=
                "display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <H4 STYLE=
                  "color: var(--blue); font-size: 1rem; margin: 0;">
                    History Movement
                  </H4>
                  <DIV ID="movementLastUpdatedInfo" STYLE=
                  " background: var(--bg-primary); border: 1px solid var(--border-light); border-radius: 8px; padding: 0.5rem 0.75rem; color: var(--text-secondary); font-size: 0.8rem; white-space: nowrap;">
                    <DIV STYLE=
                    "display: flex; align-items: center; gap: 0.5rem;">
                      <SVG WIDTH="14" HEIGHT="14" VIEWBOX=
                      "0 0 24 24" FILL="currentColor" STYLE=
                      "color: var(--blue);">
                      <PATH D=
                      "M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"></PATH>
                      </SVG> <SPAN>Loading...</SPAN>
                    </DIV>
                  </DIV>
                </DIV>
                <DIV CLASS="table-container">
                  <TABLE CLASS="table">
                    <THEAD>
                      <TR>
                        <TH>
                          Tanggal
                        </TH>
                        <TH>
                          SKU
                        </TH>
                        <TH>
                          Nama Barang
                        </TH>
                        <TH>
                          Type
                        </TH>
                        <TH>
                          Qty
                        </TH>
                        <TH>
                          Notes
                        </TH>
                        <TH>
                          Created By
                        </TH>
                        <TH>
                          Action
                        </TH>
                      </TR>
                    </THEAD>
                    <TBODY ID="movementHistoryBody">
                      <TR>
                        <TD COLSPAN="8" STYLE=
                        "text-align: center; color: var(--text-muted); padding: 2rem;">
                          Belum ada movement.
                        </TD>
                      </TR>
                    </TBODY>
                  </TABLE>
                </DIV>
              </DIV>
            </DIV><!-- TAB 3: LAPORAN STOCK -->
            <DIV ID="laporan-tab" CLASS="tab-panel">
              <DIV STYLE=
              "display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <H3 STYLE=
                "color: var(--text-primary); font-size: 1.125rem; font-weight: 600; margin: 0;">
                  üìã Laporan Stock
                </H3>
                <DIV ID="laporanLastUpdatedInfo" STYLE=
                " background: var(--bg-primary); border: 1px solid var(--border-light); border-radius: 8px; padding: 0.5rem 0.75rem; color: var(--text-secondary); font-size: 0.8rem; white-space: nowrap;">
                  <DIV STYLE=
                  "display: flex; align-items: center; gap: 0.5rem;">
                    <SVG WIDTH="14" HEIGHT="14" VIEWBOX="0 0 24 24"
                    FILL="currentColor" STYLE=
                    "color: var(--blue);">
                    <PATH D=
                    "M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"></PATH>
                    </SVG> <SPAN>Loading...</SPAN>
                  </DIV>
                </DIV>
              </DIV><!-- Helper Info -->
              <DIV STYLE=
              "text-align: center; color: var(--text-muted); font-size: 0.75rem; margin-bottom: 1rem; padding: 0.5rem; background: rgba(59,130,246,0.1); border-radius: 6px; border-left: 3px solid var(--blue);">
                üí° <STRONG>Tips:</STRONG> Tekan Tombol Refresh Jika
                Data Tidak Muncul
              </DIV>
              <DIV CLASS="card">
                <DIV STYLE=
                "display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap: 1rem; flex-wrap: wrap;">
                  <!-- LEFT SIDE - Search & Filters -->
                  <DIV STYLE=
                  "display: flex; gap: 0.75rem; align-items: center; flex: 1; min-width: 300px;">
                    <!-- Search Box -->
                    <DIV STYLE="position: relative; width: 250px;">
                      <INPUT TYPE="text" CLASS="search-input"
                      PLACEHOLDER="üîç Cari produk..." STYLE=
                      "width: 100%; padding-left: 2.5rem; border-radius: 8px; border: 1px solid var(--border-light);">
                      <SVG STYLE=
                      "position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-muted); pointer-events: none;"
                      VIEWBOX="0 0 24 24" FILL="currentColor">
                      <PATH D=
                      "M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L20.49,19.78L19.78,20.49L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7.01,5 5,7.01 5,9.5C5,11.99 7.01,14 9.5,14C11.99,14 14,11.99 14,9.5C14,7.01 11.99,5 9.5,5Z"></PATH>
                      </SVG>
                    </DIV><!-- Smart Filters -->
                    <SELECT CLASS="form-input" ID=
                    "stockStatusFilter" STYLE=
                    "width: 140px; padding: 0.5rem;" ONCHANGE=
                    "applyStockFilters()">
                      <OPTION VALUE="">
                        All Status
                      </OPTION>
                      <OPTION VALUE="AMAN">
                        ‚úÖ Aman
                      </OPTION>
                      <OPTION VALUE="WARNING">
                        ‚ö†Ô∏è Warning
                      </OPTION>
                      <OPTION VALUE="LOW STOCK">
                        üî∂ Low Stock
                      </OPTION>
                      <OPTION VALUE="HABIS">
                        üö® Habis
                      </OPTION>
                    </SELECT> <SELECT CLASS="form-input" ID=
                    "stockRangeFilter" STYLE=
                    "width: 120px; padding: 0.5rem;" ONCHANGE=
                    "applyStockFilters()">
                      <OPTION VALUE="">
                        All Range
                      </OPTION>
                      <OPTION VALUE="0">
                        0 pcs
                      </OPTION>
                      <OPTION VALUE="1-5">
                        1-5 pcs
                      </OPTION>
                      <OPTION VALUE="6-10">
                        6-10 pcs
                      </OPTION>
                      <OPTION VALUE="11+">
                        11+ pcs
                      </OPTION>
                    </SELECT>
                  </DIV><!-- RIGHT SIDE - Action Buttons -->
                  <DIV STYLE="display: flex; gap: 0.5rem;">
                    <BUTTON CLASS="btn btn-secondary btn-sm"
                    ONCLICK="refreshStockReport()" TITLE=
                    "Refresh Data"><SVG WIDTH="16" HEIGHT="16"
                    VIEWBOX="0 0 24 24" FILL="currentColor">
                    <PATH D=
                    "M12,6V9L16,5L12,1V4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12H18A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6Z"></PATH>
                    </SVG> Refresh</BUTTON> <BUTTON CLASS=
                    "btn btn-info btn-sm" ONCLICK=
                    "exportStockReport()" TITLE=
                    "Export Data"><SVG WIDTH="16" HEIGHT="16"
                    VIEWBOX="0 0 24 24" FILL="currentColor">
                    <PATH D=
                    "M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"></PATH>
                    </SVG> Export</BUTTON>
                  </DIV>
                </DIV>
                <DIV CLASS="table-container">
                  <TABLE CLASS="table">
                    <THEAD>
                      <TR>
                        <TH>
                          SKU
                        </TH>
                        <TH>
                          Nama Barang
                        </TH>
                        <TH>
                          Unit
                        </TH>
                        <TH>
                          Stok Awal
                        </TH>
                        <TH>
                          Stock IN
                        </TH>
                        <TH>
                          Stock OUT
                        </TH>
                        <TH>
                          Current Stock
                        </TH>
                        <TH>
                          Status
                        </TH>
                      </TR>
                    </THEAD>
                    <TBODY ID="laporanStockBody">
                      <TR>
                        <TD COLSPAN="8" STYLE=
                        "text-align: center; color: var(--text-muted); padding: 2rem;">
                          Belum ada data stock.
                        </TD>
                      </TR>
                    </TBODY>
                  </TABLE>
                </DIV>
              </DIV>
            </DIV><!-- TAB 4: REPORT -->
            <DIV ID="report-tab" CLASS="tab-panel">
              <H3 STYLE=
              "color: var(--text-primary); font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                üìä Report & Analytics
              </H3><!-- Stats Cards -->
              <DIV CLASS="stats-grid" STYLE=
              "margin-bottom: 1.5rem;">
                <!-- TOTAL PRODUK CARD -->
                <DIV CLASS="stat-card modern-card" STYLE=
                "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; position: relative; overflow: hidden;">
                  <DIV STYLE=
                  "position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; opacity: 0.1;">
                    <SVG WIDTH="80" HEIGHT="80" VIEWBOX="0 0 24 24"
                    FILL="white">
                    <PATH D=
                    "M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4Z"></PATH>
                    </SVG>
                  </DIV>
                  <DIV STYLE=
                  "display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1rem;">
                    <DIV STYLE=
                    "background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px; backdrop-filter: blur(10px);">
                      <SVG WIDTH="24" HEIGHT="24" VIEWBOX=
                      "0 0 24 24" FILL="white">
                      <PATH D=
                      "M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z"></PATH>
                      </SVG>
                    </DIV>
                    <DIV STYLE=
                    "color: rgba(255,255,255,0.7); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">
                      TOTAL PRODUK
                    </DIV>
                  </DIV>
                  <DIV STYLE=
                  "color: white; font-size: 2.5rem; font-weight: 900; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                  ID="reportTotalProducts">
                    0
                  </DIV>
                  <DIV STYLE=
                  "color: rgba(255,255,255,0.8); font-size: 0.875rem; font-weight: 500;">
                    Terdaftar
                  </DIV>
                </DIV><!-- LOW STOCK CARD -->
                <DIV CLASS="stat-card modern-card" STYLE=
                "background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); border: none; position: relative; overflow: hidden;">
                  <DIV STYLE=
                  "position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; opacity: 0.1;">
                    <SVG WIDTH="80" HEIGHT="80" VIEWBOX="0 0 24 24"
                    FILL="white">
                    <PATH D="M1,21H23L12,2L1,21Z"></PATH></SVG>
                  </DIV>
                  <DIV STYLE=
                  "display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1rem;">
                    <DIV STYLE=
                    "background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px; backdrop-filter: blur(10px);">
                      <SVG WIDTH="24" HEIGHT="24" VIEWBOX=
                      "0 0 24 24" FILL="white">
                      <PATH D="M1,21H23L12,2L1,21Z"></PATH>
                      <PATH D="M13,14H11V10H13M13,18H11V16H13"
                      FILL="#ff6b6b"></PATH></SVG>
                    </DIV>
                    <DIV STYLE=
                    "color: rgba(255,255,255,0.7); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">
                      LOW STOCK
                    </DIV>
                  </DIV>
                  <DIV STYLE=
                  "color: white; font-size: 2.5rem; font-weight: 900; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                  ID="reportLowStock">
                    0
                  </DIV>
                  <DIV STYLE=
                  "color: rgba(255,255,255,0.8); font-size: 0.875rem; font-weight: 500;">
                    Perlu restock
                  </DIV>
                </DIV><!-- TOTAL VALUE CARD -->
                <DIV CLASS="stat-card modern-card" STYLE=
                "background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; position: relative; overflow: hidden;">
                  <DIV STYLE=
                  "position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; opacity: 0.1;">
                    <SVG WIDTH="80" HEIGHT="80" VIEWBOX="0 0 24 24"
                    FILL="white">
                    <PATH D=
                    "M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z"></PATH>
                    </SVG>
                  </DIV>
                  <DIV STYLE=
                  "display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1rem;">
                    <DIV STYLE=
                    "background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px; backdrop-filter: blur(10px);">
                      <SVG WIDTH="24" HEIGHT="24" VIEWBOX=
                      "0 0 24 24" FILL="white">
                      <PATH D=
                      "M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z"></PATH>
                      </SVG>
                    </DIV>
                    <DIV STYLE=
                    "color: rgba(255,255,255,0.7); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">
                      TOTAL VALUE
                    </DIV>
                  </DIV>
                  <DIV STYLE=
                  "color: white; font-size: 2.5rem; font-weight: 900; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                  ID="reportTotalValue">
                    Rp 0
                  </DIV>
                  <DIV STYLE=
                  "color: rgba(255,255,255,0.8); font-size: 0.875rem; font-weight: 500;">
                    Nilai inventory
                  </DIV>
                </DIV><!-- MOVEMENT CARD -->
                <DIV CLASS="stat-card modern-card" STYLE=
                "background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; position: relative; overflow: hidden;">
                  <DIV STYLE=
                  "position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; opacity: 0.1;">
                    <SVG WIDTH="80" HEIGHT="80" VIEWBOX="0 0 24 24"
                    FILL="white">
                    <PATH D=
                    "M13,20H11V8L5.5,13.5L4.08,12.08L12,4.16L19.92,12.08L18.5,13.5L13,8V20Z"></PATH>
                    </SVG>
                  </DIV>
                  <DIV STYLE=
                  "display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 1rem;">
                    <DIV STYLE=
                    "background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px; backdrop-filter: blur(10px);">
                      <SVG WIDTH="24" HEIGHT="24" VIEWBOX=
                      "0 0 24 24" FILL="white">
                      <PATH D=
                      "M13,20H11V8L5.5,13.5L4.08,12.08L12,4.16L19.92,12.08L18.5,13.5L13,8V20Z"></PATH>
                      </SVG>
                    </DIV>
                    <DIV STYLE=
                    "color: rgba(255,255,255,0.7); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">
                      MOVEMENT
                    </DIV>
                  </DIV>
                  <DIV STYLE=
                  "color: white; font-size: 2.5rem; font-weight: 900; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                  ID="reportMovements">
                    0
                  </DIV>
                  <DIV STYLE=
                  "color: rgba(255,255,255,0.8); font-size: 0.875rem; font-weight: 500;">
                    Bulan ini
                  </DIV>
                </DIV>
              </DIV><!-- Quick Reports -->
              <DIV STYLE=
              "display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <DIV CLASS="card">
                  <H4 STYLE=
                  "color: #ff6b6b; font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                    üî• Fast Moving Items
                  </H4>
                  <DIV ID="fastMovingList">
                    <P STYLE=
                    "color: var(--text-muted); text-align: center; padding: 1rem;">
                      Belum ada data
                    </P>
                  </DIV>
                </DIV>
                <DIV CLASS="card">
                  <H4 STYLE=
                  "color: #ff4757; font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                    ‚ö†Ô∏è Low Stock Alert
                  </H4>
                  <DIV ID="lowStockList">
                    <P STYLE=
                    "color: var(--text-muted); text-align: center; padding: 1rem;">
                      Semua stock aman
                    </P>
                  </DIV>
                </DIV>
              </DIV>
            </DIV>
          </DIV>
        </SECTION><!-- ===== AI INTELLIGENCE SECTION ===== -->
        <SECTION ID="ai-intelligence" CLASS="section">
          <DIV CLASS="tabs-nav">
            <BUTTON CLASS="tab-btn active" DATA-TAB="monitoring">üîç
            Auto Check Monitor</BUTTON> <BUTTON CLASS="tab-btn"
            DATA-TAB="predictions">üîÆ AI Predictions</BUTTON>
          </DIV><!-- Tab Content -->
          <DIV CLASS="tab-content">
            <!-- TAB 1: AUTO CHECK MONITORING -->
            <DIV ID="monitoring-tab" CLASS="tab-panel active">
              <!-- Real-time Status Card -->
              <DIV CLASS="card" STYLE=
              "background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border: 1px solid var(--blue); color: white; margin-bottom: 1.5rem;">
                <H3 STYLE=
                "color: white; font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                  ü§ñ Auto Check Status - LIVE
                </H3>
                <DIV STYLE=
                "display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                  <DIV STYLE=
                  "background: rgba(59,130,246,0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(59,130,246,0.2);">
                    <DIV STYLE=
                    "color: rgba(255,255,255,0.8); font-size: 0.8rem; margin-bottom: 0.5rem;">
                      STATUS
                    </DIV>
                    <DIV STYLE=
                    "font-size: 1.2rem; font-weight: 700;" ID=
                    "autoCheckStatusLive">
                      STOPPED
                    </DIV>
                  </DIV>
                  <DIV STYLE=
                  "background: rgba(16,185,129,0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(16,185,129,0.2);">
                    <DIV STYLE=
                    "color: rgba(255,255,255,0.8); font-size: 0.8rem; margin-bottom: 0.5rem;">
                      INTERVAL
                    </DIV>
                    <DIV STYLE=
                    "font-size: 1.2rem; font-weight: 700;" ID=
                    "checkIntervalLive">
                      Manual Only
                    </DIV>
                  </DIV>
                  <DIV STYLE=
                  "background: rgba(245,158,11,0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(245,158,11,0.2);">
                    <DIV STYLE=
                    "color: rgba(255,255,255,0.8); font-size: 0.8rem; margin-bottom: 0.5rem;">
                      API COST TODAY
                    </DIV>
                    <DIV STYLE=
                    "font-size: 1.2rem; font-weight: 700;" ID=
                    "costTodayLive">
                      Rp 0
                    </DIV>
                  </DIV>
                </DIV>
              </DIV><!-- Daily Summary Stats -->
              <DIV CLASS="stats-grid" STYLE=
              "margin-bottom: 1.5rem;">
                <DIV CLASS="stat-card" STYLE=
                "background: var(--bg-secondary); border: 1px solid var(--green); color: white;">
                  <DIV CLASS="stat-label" STYLE=
                  "color: var(--green);">
                    ‚úÖ DELIVERED TODAY
                  </DIV>
                  <DIV CLASS="stat-value" STYLE=
                  "color: var(--green);" ID="deliveredToday">
                    0
                  </DIV>
                  <DIV CLASS="stat-change" STYLE=
                  "color: var(--text-secondary);">
                    packages delivered
                  </DIV>
                </DIV>
                <DIV CLASS="stat-card" STYLE=
                "background: var(--bg-secondary); border: 1px solid var(--blue); color: white;">
                  <DIV CLASS="stat-label" STYLE=
                  "color: var(--blue);">
                    üîÑ TOTAL CHECKS
                  </DIV>
                  <DIV CLASS="stat-value" STYLE=
                  "color: var(--blue);" ID="totalChecksToday">
                    0
                  </DIV>
                  <DIV CLASS="stat-change" STYLE=
                  "color: var(--text-secondary);">
                    API calls made
                  </DIV>
                </DIV>
                <DIV CLASS="stat-card" STYLE=
                "background: var(--bg-secondary); border: 1px solid var(--red); color: white;">
                  <DIV CLASS="stat-label" STYLE=
                  "color: var(--red);">
                    üîÅ RETURNS TODAY
                  </DIV>
                  <DIV CLASS="stat-value" STYLE=
                  "color: var(--red);" ID="returnsToday">
                    0
                  </DIV>
                  <DIV CLASS="stat-change" STYLE=
                  "color: var(--text-secondary);">
                    returned packages
                  </DIV>
                </DIV>
                <DIV CLASS="stat-card" STYLE=
                "background: var(--bg-secondary); border: 1px solid var(--orange); color: white;">
                  <DIV CLASS="stat-label" STYLE=
                  "color: var(--orange);">
                    üìä SUCCESS RATE
                  </DIV>
                  <DIV CLASS="stat-value" STYLE=
                  "color: var(--orange);" ID="successRateToday">
                    0%
                  </DIV>
                  <DIV CLASS="stat-change" STYLE=
                  "color: var(--text-secondary);">
                    auto check accuracy
                  </DIV>
                </DIV>
              </DIV><!-- Auto Check History Table -->
              <DIV CLASS="card">
                <H3 STYLE=
                "color: var(--text-primary); font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                  üìã Auto Check History (Today)
                </H3>
                <DIV CLASS="table-container">
                  <TABLE CLASS="table">
                    <THEAD>
                      <TR>
                        <TH>
                          Time
                        </TH>
                        <TH>
                          Resi
                        </TH>
                        <TH>
                          Courier
                        </TH>
                        <TH>
                          Before ‚Üí After
                        </TH>
                        <TH>
                          Cost
                        </TH>
                        <TH>
                          Result
                        </TH>
                        <TH>
                          Action
                        </TH>
                      </TR>
                    </THEAD>
                    <TBODY ID="autoCheckHistoryBody">
                      <TR>
                        <TD COLSPAN="7" STYLE=
                        "text-align: center; color: var(--text-muted); padding: 2rem;">
                          Belum ada history auto check hari ini
                        </TD>
                      </TR>
                    </TBODY>
                  </TABLE>
                </DIV>
              </DIV>
            </DIV><!-- TAB 2: AI PREDICTIONS -->
            <DIV ID="predictions-tab" CLASS="tab-panel">
              <!-- 2 Column Grid (ATAS) -->
              <DIV STYLE=
              "display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                <!-- 1Ô∏è‚É£ COURIER SLA RANKING (GRID KIRI) -->
                <DIV CLASS="card">
                  <H3 STYLE=
                  "color: var(--green); font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                    üèÜ Courier SLA Ranking
                  </H3>
                  <DIV ID="courierRankingWidget">
                    <DIV STYLE=
                    "text-align: center; color: var(--text-muted); padding: 2rem;">
                      üìà Data ranking belum tersedia
                    </DIV>
                  </DIV>
                </DIV><!-- 2Ô∏è‚É£ COST EFFICIENCY (GRID KANAN) -->
                <DIV CLASS="card">
                  <H3 STYLE=
                  "color: var(--orange); font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                    üí∞ Cost Efficiency
                  </H3>
                  <DIV ID="costEfficiencyWidget">
                    <DIV STYLE=
                    "text-align: center; color: var(--text-muted); padding: 2rem;">
                      üìä Data cost efficiency belum tersedia
                    </DIV>
                  </DIV>
                </DIV>
              </DIV>
              <!-- 3Ô∏è‚É£ STUCK PROBABILITY PREDICTOR (FULL WIDTH) -->
              <DIV CLASS="card" STYLE="margin-bottom: 1.5rem;">
                <H3 STYLE=
                "color: var(--red); font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                  üéØ Stuck Probability Predictor
                </H3>
                <DIV ID="stuckProbabilityWidget">
                  <DIV STYLE=
                  "text-align: center; color: var(--text-muted); padding: 2rem;">
                    üéØ Loading probability analysis...
                  </DIV>
                </DIV>
              </DIV>
              <!-- 4Ô∏è‚É£ PACKAGE STATUS SUMMARY (FULL WIDTH) -->
              <DIV CLASS="card">
                <H3 STYLE=
                "color: var(--blue); font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                  üì¶ Package Status Summary
                </H3>
                <DIV ID="packageStatusWidget">
                  <DIV STYLE=
                  "text-align: center; color: var(--text-muted); padding: 2rem;">
                    üîÑ Loading package data...
                  </DIV>
                </DIV>
              </DIV>
            </DIV>
          </DIV>
        </SECTION>
       
       <!-- ===== AUTO REPORTS SECTION ===== -->
<SECTION ID="auto-reports" CLASS="section">
  <DIV CLASS="tabs-nav">
    <BUTTON CLASS="tab-btn active" DATA-TAB="history">üìã History Reports</BUTTON> 
    <BUTTON CLASS="tab-btn" DATA-TAB="preview">üìã Report Preview</BUTTON>
  </DIV>
  
  <DIV CLASS="tab-content">
    <!-- TAB 1: HISTORY -->
    <DIV ID="history-tab" CLASS="tab-panel active">
      <DIV STYLE="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <H3 STYLE="color: var(--text-primary); margin: 0;">üìä Riwayat Auto Reports</H3>
        <DIV STYLE="display: flex; gap: 0.5rem;">
          <BUTTON CLASS="btn btn-secondary" ONCLICK="loadAutoReportHistory()">
            üîÑ Refresh History
          </BUTTON>
          <BUTTON CLASS="btn btn-primary" ONCLICK="openAutoReportModal()">
            <SVG WIDTH="16" HEIGHT="16" VIEWBOX="0 0 24 24" FILL="currentColor">
              <PATH D="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.98C19.47,12.66 19.5,12.34 19.5,12C19.5,11.66 19.47,11.34 19.43,11.02L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.65 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.65 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.02C4.53,11.34 4.5,11.66 4.5,12C4.5,12.34 4.53,12.66 4.57,12.98L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.04 4.95,18.95L7.44,17.95C7.96,18.35 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.35 16.56,17.95L19.05,18.95C19.27,19.04 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.98Z"/>
            </SVG>
            ‚öôÔ∏è Configure Auto Reports
          </BUTTON>
        </DIV>
      </DIV>

      <!-- History Table -->
      <DIV CLASS="card">
        <DIV CLASS="table-container">
          <TABLE CLASS="table">
            <THEAD>
              <TR>
                <TH>Tanggal</TH>
                <TH>Waktu</TH>
                <TH>Target</TH>
                <TH>Type</TH>
                <TH>Status</TH>
                <TH>Preview</TH>
                <TH>Action</TH>
              </TR>
            </THEAD>
            <TBODY ID="autoReportHistoryBody">
              <TR>
                <TD COLSPAN="7" STYLE="text-align: center; color: var(--text-muted); padding: 2rem;">
                  Belum ada riwayat auto reports
                </TD>
              </TR>
            </TBODY>
          </TABLE>
        </DIV>
      </DIV>
    </DIV>

    <!-- TAB 2: PREVIEW -->
    <DIV ID="preview-tab" CLASS="tab-panel">
      <H3 STYLE="color: var(--text-primary); margin-bottom: 1rem;">üìã Preview Laporan</H3>
      <DIV CLASS="card">
        <BUTTON CLASS="btn btn-secondary" ONCLICK="generatePreviewReport()">üîÑ Generate Preview</BUTTON>
        <DIV ID="reportPreviewContainer" STYLE="background: var(--bg-primary); padding: 1rem; border-radius: 8px; font-family: monospace; white-space: pre-line; margin-top: 1rem; min-height: 200px;">
          Klik "Generate Preview" untuk melihat laporan...
        </DIV>
      </DIV>
    </DIV>
  </DIV>
</SECTION>

<!-- ===== AUTO REPORT MODAL ===== -->
<DIV ID="autoReportModal" CLASS="modal">
  <DIV CLASS="modal-content">
    <DIV CLASS="modal-header">
      <H3 CLASS="modal-title">‚öôÔ∏è Configure Auto Reports</H3>
      <BUTTON CLASS="close-btn" ONCLICK="closeAutoReportModal()">√ó</BUTTON>
    </DIV>
    <DIV>
      <!-- Enable/Disable Toggle -->
      <DIV CLASS="form-group">
        <LABEL CLASS="form-label">
          <INPUT TYPE="checkbox" ID="enableAutoReports" STYLE="margin-right: 0.5rem;">
          Enable Auto Reports
        </LABEL>
      </DIV>

      <DIV CLASS="form-group">
        <LABEL CLASS="form-label">Grup WhatsApp ID</LABEL>
        <INPUT TYPE="text" CLASS="form-input" ID="modalReportGroupId" PLACEHOLDER="120363xxxxxxxxx@g.us">
      </DIV>

      <DIV CLASS="form-group">
        <LABEL CLASS="form-label">Admin WhatsApp</LABEL>
        <INPUT TYPE="text" CLASS="form-input" ID="modalReportAdminWA" PLACEHOLDER="628123456789">
      </DIV>

      <DIV CLASS="form-group">
        <LABEL CLASS="form-label">Waktu Kirim</LABEL>
        <INPUT TYPE="time" CLASS="form-input" ID="modalReportTime" VALUE="17:00">
      </DIV>

      <DIV STYLE="margin-top: 1.5rem; display: flex; gap: 1rem;">
        <BUTTON CLASS="btn btn-primary" ONCLICK="saveAutoReportModalSettings()">
          <SVG WIDTH="16" HEIGHT="16" VIEWBOX="0 0 24 24" FILL="currentColor">
            <PATH D="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/>
          </SVG>
          Simpan & Enable
        </BUTTON>
        <BUTTON CLASS="btn btn-danger" ONCLICK="stopAutoReports()">
          <SVG WIDTH="16" HEIGHT="16" VIEWBOX="0 0 24 24" FILL="currentColor">
            <PATH D="M8.27,3L3,8.27V15.73L8.27,21H15.73L21,15.73V8.27L15.73,3M8.41,7L12,10.59L15.59,7L17,8.41L13.41,12L17,15.59L15.59,17L12,13.41L8.41,17L7,15.59L10.59,12L7,8.41"/>
          </SVG>
          Stop & Disable
        </BUTTON>
        <BUTTON CLASS="btn btn-secondary" ONCLICK="closeAutoReportModal()">Batal</BUTTON>
      </DIV>
    </DIV>
  </DIV>
</DIV>
       
       <!-- ===== CUSTOMER ENGAGEMENT SECTION ===== -->
        <SECTION ID="customer-engagement" CLASS="section">
          <DIV CLASS="tabs-nav">
            <BUTTON CLASS="tab-btn active" DATA-TAB="dashboard">üìä Dashboard</BUTTON>
            <BUTTON CLASS="tab-btn" DATA-TAB="orders">üì¶ Orders</BUTTON>
            <BUTTON CLASS="tab-btn" DATA-TAB="customers">üë• Customers</BUTTON>
            <BUTTON CLASS="tab-btn" DATA-TAB="abtesting">üß™ A/B Testing</BUTTON>
          </DIV>

          <!-- Tab Content -->
          <DIV CLASS="tab-content">
            <!-- TAB 1: DASHBOARD -->
            <DIV ID="dashboard-tab" CLASS="tab-panel active">
              <DIV STYLE="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <H3 STYLE="color: var(--text-primary); margin: 0;">üìä Customer Engagement Dashboard</H3>
                <SELECT ID="engagementMonthSelector" CLASS="form-input" STYLE="width: auto;">
                  <OPTION VALUE="2025-07">Juli 2025</OPTION>
                  <OPTION VALUE="2025-06">Juni 2025</OPTION>
                  <OPTION VALUE="2025-05">Mei 2025</OPTION>
                </SELECT>
              </DIV>

              <!-- Stats Cards -->
              <DIV CLASS="stats-grid">
                <DIV CLASS="stat-card">
                  <DIV CLASS="stat-label">üí∞ MONTHLY PROFIT</DIV>
                  <DIV CLASS="stat-value" ID="monthlyProfit">Rp 0</DIV>
                  <DIV CLASS="stat-change">Total profit bulan ini</DIV>
                </DIV>
                <DIV CLASS="stat-card">
                  <DIV CLASS="stat-label">üì¶ TODAY'S ORDERS</DIV>
                  <DIV CLASS="stat-value" ID="todayOrders">0</DIV>
                  <DIV CLASS="stat-change">Orders hari ini</DIV>
                </DIV>
                <DIV CLASS="stat-card">
                  <DIV CLASS="stat-label">üõçÔ∏è TIKTOK ORDERS</DIV>
                  <DIV CLASS="stat-value" ID="tiktokOrders">0</DIV>
                  <DIV CLASS="stat-change">TikTok Shop orders</DIV>
                </DIV>
                <DIV CLASS="stat-card">
                  <DIV CLASS="stat-label">üõí SHOPEE ORDERS</DIV>
                  <DIV CLASS="stat-value" ID="shopeeOrders">0</DIV>
                  <DIV CLASS="stat-change">Shopee orders</DIV>
                </DIV>
              </DIV>

              <!-- Platform Comparison -->
              <DIV CLASS="card">
                <H4 STYLE="color: var(--text-primary); margin-bottom: 1rem;">üìà Platform Performance Comparison</H4>
                <DIV ID="platformComparisonWidget">
                  <P STYLE="text-align: center; color: var(--text-muted); padding: 2rem;">Loading platform data...</P>
                </DIV>
              </DIV>
            </DIV>

            <!-- TAB 2: ORDERS -->
            <DIV ID="orders-tab" CLASS="tab-panel">
              <DIV STYLE="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <H3 STYLE="color: var(--text-primary); margin: 0;">üì¶ Orders Management</H3>
                <BUTTON CLASS="btn btn-primary" ONCLICK="toggleOrderForm()" ID="toggleOrderBtn">
                  <SVG WIDTH="16" HEIGHT="16" VIEWBOX="0 0 24 24" FILL="currentColor">
                    <PATH D="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                  </SVG>
                  Tambah Order Baru
                </BUTTON>
              </DIV>

              <!-- Order Form (Hidden by default) -->
<DIV CLASS="card" STYLE="margin-bottom: 1.5rem; display: none;" ID="orderFormCard">
  <!-- CUSTOMER INFO SECTION -->
  <H4 STYLE="color: var(--blue); font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
    üë• Customer Info
  </H4>
  <DIV STYLE="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid var(--blue);">
    <DIV CLASS="form-group">
      <LABEL CLASS="form-label">Nama Customer *</LABEL>
      <INPUT TYPE="text" CLASS="form-input" ID="customerNama" PLACEHOLDER="Nama lengkap customer">
    </DIV>
    <DIV CLASS="form-group">
      <LABEL CLASS="form-label">No HP *</LABEL>
      <INPUT TYPE="text" CLASS="form-input" ID="customerHP" PLACEHOLDER="08123456789">
    </DIV>
    <DIV CLASS="form-group">
      <LABEL CLASS="form-label">Alamat</LABEL>
      <INPUT TYPE="text" CLASS="form-input" ID="customerAlamat" PLACEHOLDER="Alamat lengkap (opsional)">
    </DIV>
  </DIV>

  <!-- ORDER DETAILS SECTION -->
  <H4 STYLE="color: var(--green); font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
    üì¶ Order Details
  </H4>
  <DIV STYLE="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid var(--green);">
    <DIV CLASS="form-group">
      <LABEL CLASS="form-label">Platform *</LABEL>
      <SELECT CLASS="form-input" ID="orderPlatform">
        <OPTION VALUE="">Pilih Platform</OPTION>
        <OPTION VALUE="tiktok">üõçÔ∏è TikTok Shop</OPTION>
        <OPTION VALUE="shopee">üõí Shopee</OPTION>
      </SELECT>
    </DIV>
    <DIV CLASS="form-group">
      <LABEL CLASS="form-label">Tanggal Order</LABEL>
      <INPUT TYPE="date" CLASS="form-input" ID="orderTanggal">
    </DIV>
    <DIV CLASS="form-group">
      <LABEL CLASS="form-label">No Resi (opsional)</LABEL>
      <INPUT TYPE="text" CLASS="form-input" ID="orderResi" PLACEHOLDER="JX1234567890">
    </DIV>
  </DIV>

  <!-- PRODUCTS SECTION -->
  <H4 STYLE="color: var(--orange); font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
    üõçÔ∏è Products
    <BUTTON TYPE="button" CLASS="btn btn-sm btn-secondary" ONCLICK="addProductRow()" STYLE="margin-left: auto;">
      <SVG WIDTH="14" HEIGHT="14" VIEWBOX="0 0 24 24" FILL="currentColor">
        <PATH D="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
      </SVG>
      Tambah Produk
    </BUTTON>
  </H4>
  
  <!-- Products Container -->
  <DIV ID="productsContainer" STYLE="margin-bottom: 1.5rem;">
    <!-- Product rows will be added here dynamically -->
  </DIV>

  <!-- TOTAL CALCULATION -->
  <DIV STYLE="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--purple);">
    <H5 STYLE="color: var(--purple); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
      üí∞ Total Calculation
    </H5>
    <DIV ID="totalCalculation" STYLE="font-family: monospace; font-size: 0.9rem; color: var(--text-primary);">
      Total Items: 0 | Total HPP: Rp 0 | Total Harga Jual: Rp 0 | Total Profit: Rp 0 | Avg Margin: 0%
    </DIV>
  </DIV>

  <!-- BUTTONS -->
  <DIV STYLE="display: flex; gap: 1rem;">
    <BUTTON CLASS="btn btn-primary" ONCLICK="saveMultipleOrder()">
      <SVG WIDTH="16" HEIGHT="16" VIEWBOX="0 0 24 24" FILL="currentColor">
        <PATH D="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/>
      </SVG>
      Simpan Order
    </BUTTON>
    <BUTTON CLASS="btn btn-secondary" ONCLICK="closeOrderForm()">
      ‚ùå Batal
    </BUTTON>
  </DIV>
</DIV>

              <!-- Orders Table -->
              <DIV CLASS="card">
                <DIV STYLE="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <H4 STYLE="color: var(--blue); font-size: 1rem; margin: 0;">Daftar Orders</H4>
                  <INPUT TYPE="text" CLASS="search-input" PLACEHOLDER="üîç Search..." ID="orderSearch" STYLE="width: 160px; max-width: 160px;">
                </DIV>
                <DIV CLASS="table-container">
                  <TABLE CLASS="table">
                    <THEAD>
                      <TR>
                        <TH>Tanggal</TH>
                        <TH>Platform</TH>
                        <TH>Customer</TH>
                        <TH>Produk</TH>
                        <TH>Qty</TH>
                        <TH>Harga Jual</TH>
                        <TH>Profit</TH>
                        <TH>Margin</TH>
                        <TH>Resi</TH>
                        <TH>Status</TH>
                        <TH>Action</TH>
                      </TR>
                    </THEAD>
                    <TBODY ID="ordersTableBody">
                      <TR>
                        <TD COLSPAN="11" STYLE="text-align: center; color: var(--text-muted); padding: 2rem;">
                          Belum ada orders. Klik "Tambah Order Baru" untuk memulai.
                        </TD>
                      </TR>
                    </TBODY>
                  </TABLE>
                </DIV>
              </DIV>
            </DIV>

            <!-- TAB 3: CUSTOMERS -->
            <DIV ID="customers-tab" CLASS="tab-panel">
              <DIV STYLE="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <H3 STYLE="color: var(--text-primary); margin: 0;">üë• Customer Database</H3>
                <BUTTON CLASS="btn btn-primary" ONCLICK="openAddCustomer()">
                  <SVG WIDTH="16" HEIGHT="16" VIEWBOX="0 0 24 24" FILL="currentColor">
                    <PATH D="M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z"/>
                  </SVG>
                  Tambah Customer
                </BUTTON>
              </DIV>

              <DIV CLASS="card">
                <DIV STYLE="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <H4 STYLE="color: var(--blue); font-size: 1rem; margin: 0;">Database Customer</H4>
                  <INPUT TYPE="text" CLASS="search-input" PLACEHOLDER="üîç Cari customer..." ID="customerSearch" STYLE="width: 250px;">
                </DIV>
                <DIV CLASS="table-container">
                  <TABLE CLASS="table">
                    <THEAD>
                      <TR>
                        <TH>Nama</TH>
                        <TH>Telepon</TH>
                        <TH>Platform</TH>
                        <TH>Total Orders</TH>
                        <TH>Total Spent</TH>
                        <TH>Segment</TH>
                        <TH>Last Order</TH>
                        <TH>Action</TH>
                      </TR>
                    </THEAD>
                    <TBODY ID="customersTableBody">
                      <TR>
                        <TD COLSPAN="8" STYLE="text-align: center; color: var(--text-muted); padding: 2rem;">
                          Belum ada customer. Klik "Tambah Customer" untuk memulai.
                        </TD>
                      </TR>
                    </TBODY>
                  </TABLE>
                </DIV>
              </DIV>
            </DIV>

            <!-- TAB 4: A/B TESTING -->
            <DIV ID="abtesting-tab" CLASS="tab-panel">
              <H3 STYLE="color: var(--text-primary); margin-bottom: 1rem;">üß™ A/B Testing WhatsApp Messages</H3>
              
              <DIV CLASS="card">
                <H4 STYLE="color: var(--blue); margin-bottom: 1rem;">Generate Message Variants</H4>
                <DIV CLASS="form-group">
                  <LABEL CLASS="form-label">Base Message Template</LABEL>
                  <TEXTAREA CLASS="form-input" ID="baseMessageTemplate" ROWS="4" PLACEHOLDER="Halo {nama}, pesanan {produk} sudah dikirim via {kurir}! Resi: {resi}"></TEXTAREA>
                </DIV>
                <DIV CLASS="form-group">
                  <LABEL CLASS="form-label">Message Type</LABEL>
                  <SELECT CLASS="form-input" ID="messageType">
                    <OPTION VALUE="shipping">Shipping Notification</OPTION>
                    <OPTION VALUE="delivered">Delivery Confirmation</OPTION>
                    <OPTION VALUE="return">Return Notification</OPTION>
                    <OPTION VALUE="promotional">Promotional Message</OPTION>
                  </SELECT>
                </DIV>
                <BUTTON CLASS="btn btn-primary" ONCLICK="generateMessageVariants()">
                  <SVG WIDTH="16" HEIGHT="16" VIEWBOX="0 0 24 24" FILL="currentColor">
                    <PATH D="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.98C19.47,12.66 19.5,12.34 19.5,12C19.5,11.66 19.47,11.34 19.43,11.02L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.65 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.65 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.02C4.53,11.34 4.5,11.66 4.5,12C4.5,12.34 4.53,12.66 4.57,12.98L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.04 4.95,18.95L7.44,17.95C7.96,18.35 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.35 16.56,17.95L19.05,18.95C19.27,19.04 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.98Z"/>
                  </SVG>
                  Generate dengan Claude AI
                </BUTTON>
              </DIV>

              <DIV CLASS="card" ID="variantsResult" STYLE="display: none;">
                <H4 STYLE="color: var(--green); margin-bottom: 1rem;">Generated Message Variants</H4>
                <DIV ID="messageVariants">
                  <!-- Variants akan muncul di sini -->
                </DIV>
              </DIV>

              <DIV CLASS="card">
                <H4 STYLE="color: var(--orange); margin-bottom: 1rem;">A/B Test Results</H4>
                <DIV CLASS="table-container">
                  <TABLE CLASS="table">
                    <THEAD>
                      <TR>
                        <TH>Campaign</TH>
                        <TH>Message Type</TH>
                        <TH>Variant A</TH>
                        <TH>Variant B</TH>
                        <TH>Variant C</TH>
                        <TH>Winner</TH>
                        <TH>Status</TH>
                        <TH>Action</TH>
                      </TR>
                    </THEAD>
                    <TBODY ID="abTestResultsBody">
                      <TR>
                        <TD COLSPAN="8" STYLE="text-align: center; color: var(--text-muted); padding: 2rem;">
                          Belum ada A/B test campaign.
                        </TD>
                      </TR>
                    </TBODY>
                  </TABLE>
                </DIV>
              </DIV>
            </DIV>
          </DIV>
        </SECTION>
       
       
       
        <!-- ===== SETTINGS SECTION ===== -->
        <SECTION ID="settings" CLASS="section">
          <!-- MODERN HEADER -->
          <DIV STYLE="margin-bottom: 2rem; text-align: center;">
            <DIV STYLE=
            " display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem 2rem; border-radius: 16px; margin-bottom: 1rem; box-shadow: 0 8px 25px rgba(102,126,234,0.3);">
              <H1 STYLE=
              "color: white; font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.75rem; justify-content: center;">
                <SPAN STYLE="font-size: 2rem;">‚öôÔ∏è</SPAN> System
                Configuration
              </H1>
            </DIV>
            <P STYLE=
            "color: var(--text-secondary); font-size: 0.95rem; max-width: 600px; margin: 0 auto;">
              Konfigurasi lengkap sistem tracking, API, preferensi
              user, dan pengaturan aplikasi
            </P>
          </DIV>
          <DIV CLASS="settings-grid">
            <!-- 1. API CONFIGURATION -->
            <DIV CLASS="card" STYLE=
            "border-left: 4px solid #3b82f6; background: linear-gradient(135deg, rgba(59,130,246,0.05) 0%, rgba(59,130,246,0.02) 100%);">
              <DIV STYLE=
              "display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <DIV STYLE=
                " width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(59,130,246,0.3);">
                  <SPAN STYLE="font-size: 1.5rem;">üîë</SPAN>
                </DIV>
                <DIV>
                  <H3 STYLE=
                  "color: var(--text-primary); font-size: 1.125rem; font-weight: 700; margin: 0;">
                    API & Integrations
                  </H3>
                  <P STYLE=
                  "color: var(--text-secondary); font-size: 0.875rem; margin: 0;">
                    Konfigurasi API key untuk tracking dan
                    notifikasi
                  </P>
                </DIV>
              </DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Binderbyte API
                Key</LABEL> <INPUT TYPE="password" CLASS=
                "form-input" ID="binderbyte_api" PLACEHOLDER=
                "Masukkan API key Binderbyte">
                <DIV CLASS="form-help">
                  API key untuk tracking resi via Binderbyte
                </DIV>
              </DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Fonnte API Key
                (WhatsApp)</LABEL> <INPUT TYPE="password" CLASS=
                "form-input" ID="fonnte_api" PLACEHOLDER=
                "Masukkan API key Fonnte">
                <DIV CLASS="form-help">
                  API key untuk kirim notifikasi WhatsApp
                </DIV>
              </DIV><BUTTON CLASS="btn btn-primary" ONCLICK=
              "saveApiSettings()"><SVG WIDTH="16" HEIGHT="16"
              VIEWBOX="0 0 24 24" FILL="currentColor">
              <PATH D=
              "M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"></PATH>
              </SVG> Simpan API Settings</BUTTON>
            </DIV><!-- 2. TARGET CONFIGURATION -->
            <DIV CLASS="card" STYLE=
            "border-left: 4px solid #10b981; background: linear-gradient(135deg, rgba(16,185,129,0.05) 0%, rgba(16,185,129,0.02) 100%);">
              <DIV STYLE=
              "display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <DIV STYLE=
                " width: 50px; height: 50px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(16,185,129,0.3);">
                  <SPAN STYLE="font-size: 1.5rem;">üéØ</SPAN>
                </DIV>
                <DIV>
                  <H3 STYLE=
                  "color: var(--text-primary); font-size: 1.125rem; font-weight: 700; margin: 0;">
                    Target & Goals
                  </H3>
                  <P STYLE=
                  "color: var(--text-secondary); font-size: 0.875rem; margin: 0;">
                    Set target performance dan KPI delivery
                  </P>
                </DIV>
              </DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Target Success Rate
                (%)</LABEL> <INPUT TYPE="number" CLASS="form-input"
                ID="target_success" PLACEHOLDER="90" MIN="0" MAX=
                "100">
                <DIV CLASS="form-help">
                  Target persentase delivered dari total pengiriman
                </DIV>
              </DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Target Return Rate
                (%)</LABEL> <INPUT TYPE="number" CLASS="form-input"
                ID="target_return" PLACEHOLDER="5" MIN="0" MAX=
                "100">
                <DIV CLASS="form-help">
                  Maksimal persentase return yang dapat diterima
                </DIV>
              </DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Target Pengiriman per
                Hari</LABEL> <INPUT TYPE="number" CLASS=
                "form-input" ID="target_daily" PLACEHOLDER="100"
                MIN="0">
                <DIV CLASS="form-help">
                  Target jumlah paket yang dikirim per hari
                </DIV>
              </DIV><BUTTON CLASS="btn btn-primary" ONCLICK=
              "saveTargetSettings()"><SVG WIDTH="16" HEIGHT="16"
              VIEWBOX="0 0 24 24" FILL="currentColor">
              <PATH D=
              "M12,2A3,3 0 0,1 15,5A3,3 0 0,1 12,8A3,3 0 0,1 9,5A3,3 0 0,1 12,2"></PATH>
              </SVG> Simpan Target Settings</BUTTON>
            </DIV><!-- 3. USER PREFERENCES -->
            <DIV CLASS="card" STYLE=
            "border-left: 4px solid #8b5cf6; background: linear-gradient(135deg, rgba(139,92,246,0.05) 0%, rgba(139,92,246,0.02) 100%);">
              <DIV STYLE=
              "display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <DIV STYLE=
                " width: 50px; height: 50px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(139,92,246,0.3);">
                  <SPAN STYLE="font-size: 1.5rem;">üë§</SPAN>
                </DIV>
                <DIV>
                  <H3 STYLE=
                  "color: var(--text-primary); font-size: 1.125rem; font-weight: 700; margin: 0;">
                    User Preferences
                  </H3>
                  <P STYLE=
                  "color: var(--text-secondary); font-size: 0.875rem; margin: 0;">
                    Pengaturan user dan auto check system
                  </P>
                </DIV>
              </DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Nama User</LABEL>
                <INPUT TYPE="text" CLASS="form-input" ID=
                "user_name" PLACEHOLDER="Masukkan nama user">
                <DIV CLASS="form-help">
                  Nama untuk logging dan tracking activity
                </DIV>
              </DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Device Name</LABEL>
                <INPUT TYPE="text" CLASS="form-input" ID=
                "device_name" PLACEHOLDER="Laptop Kantor">
                <DIV CLASS="form-help">
                  Nama device untuk identifikasi session
                </DIV>
              </DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Auto Check Interval
                (menit)</LABEL> <INPUT TYPE="number" CLASS=
                "form-input" ID="check_interval" PLACEHOLDER="5"
                MIN="0" MAX="60">
                <DIV CLASS="form-help">
                  Interval auto check status resi (0 = manual only)
                </DIV>
              </DIV><BUTTON CLASS="btn btn-primary" ONCLICK=
              "saveUserSettings()"><SVG WIDTH="16" HEIGHT="16"
              VIEWBOX="0 0 24 24" FILL="currentColor">
              <PATH D=
              "M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"></PATH>
              </SVG> Simpan User Settings</BUTTON>
            </DIV>
          </DIV>
        </SECTION><!-- ===== BULK IMPORT MODAL ===== -->
        <DIV ID="bulkImportModal" CLASS="modal">
          <DIV CLASS="modal-content">
            <DIV CLASS="modal-header">
              <H3 CLASS="modal-title">
                üì¶ Import Resi Bulk
              </H3><BUTTON CLASS="close-btn" ONCLICK=
              "closeBulkImport()">√ó</BUTTON>
            </DIV>
            <DIV>
              <LABEL CLASS="form-label">Paste No Resi (satu per
              baris):</LABEL> 
              <TEXTAREA ID="bulkResiInput" CLASS="bulk-textarea"
              PLACEHOLDER=
              "JX1234567890 002918123456 SPX7890123456 ..."></TEXTAREA>
              <DIV CLASS="form-help">
                üí° Tips: Copy dari Excel/spreadsheet dan paste
                langsung. Kurir akan auto-detect.
              </DIV>
              <DIV STYLE=
              "margin-top: 1rem; display: flex; gap: 1rem;">
                <BUTTON CLASS="btn btn-primary" ONCLICK=
                "processBulkImport()"><SVG WIDTH="16" HEIGHT="16"
                VIEWBOX="0 0 24 24" FILL="currentColor">
                <PATH D=
                "M12,1L3,5V11C3,16.55 6.84,21.74 12,22C17.16,21.74 21,16.55 21,11V5L12,1"></PATH>
                </SVG> Import Sekarang</BUTTON> <BUTTON CLASS=
                "btn btn-secondary" ONCLICK=
                "closeBulkImport()">Batal</BUTTON>
              </DIV>
            </DIV>
          </DIV>
        </DIV><!-- ===== DETAIL MODAL ===== -->
        <DIV ID="detailModal" CLASS="modal">
          <DIV CLASS="modal-content detail-modal-content">
            <DIV CLASS="modal-header">
              <H3 CLASS="modal-title">
                üì¶ Detail Tracking
              </H3><BUTTON CLASS="close-btn" ONCLICK=
              "closeDetailModal()">√ó</BUTTON>
            </DIV>
            <DIV ID="detailContent">
              <!-- Detail content will be loaded here -->
            </DIV>
          </DIV>
        </DIV><!-- ===== ADD PRODUCT MODAL ===== -->
        <DIV ID="addProductModal" CLASS="modal">
          <DIV CLASS="modal-content">
            <DIV CLASS="modal-header">
              <H3 CLASS="modal-title">
                üì¶ Tambah Produk Baru
              </H3><BUTTON CLASS="close-btn" ONCLICK=
              "closeAddProduct()">√ó</BUTTON>
            </DIV>
            <DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">SKU *</LABEL>
                <INPUT TYPE="text" CLASS="form-input" ID=
                "productSKU" PLACEHOLDER="Contoh: 7CHA1NTP"
                REQUIRED="">
              </DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Nama Barang *</LABEL>
                <INPUT TYPE="text" CLASS="form-input" ID=
                "productName" PLACEHOLDER="Gelas 420ml Tutup Kayu"
                REQUIRED="">
              </DIV>
              <DIV STYLE=
              "display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <DIV CLASS="form-group">
                  <LABEL CLASS="form-label">Unit</LABEL>
                  <SELECT CLASS="form-input" ID="productUnit">
                    <OPTION VALUE="pcs">
                      pcs
                    </OPTION>
                    <OPTION VALUE="kg">
                      kg
                    </OPTION>
                    <OPTION VALUE="liter">
                      liter
                    </OPTION>
                  </SELECT>
                </DIV>
                <DIV CLASS="form-group">
                  <LABEL CLASS="form-label">Stok Awal</LABEL>
                  <INPUT TYPE="number" CLASS="form-input" ID=
                  "productStock" PLACEHOLDER="0" MIN="0">
                </DIV>
              </DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Harga</LABEL>
                <INPUT TYPE="number" CLASS="form-input" ID=
                "productPrice" PLACEHOLDER="0" MIN="0">
              </DIV>
              <DIV STYLE=
              "margin-top: 1.5rem; display: flex; gap: 1rem;">
                <BUTTON CLASS="btn btn-primary" ONCLICK=
                "saveNewProduct()"><SVG WIDTH="16" HEIGHT="16"
                VIEWBOX="0 0 24 24" FILL="currentColor">
                <PATH D=
                "M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"></PATH>
                </SVG> Simpan Produk</BUTTON> <BUTTON CLASS=
                "btn btn-secondary" ONCLICK=
                "closeAddProduct()">Batal</BUTTON>
              </DIV>
            </DIV>
          </DIV>
        </DIV>
        
        <!-- ===== ADD CUSTOMER MODAL ===== -->
        <DIV ID="addCustomerModal" CLASS="modal">
          <DIV CLASS="modal-content">
            <DIV CLASS="modal-header">
              <H3 CLASS="modal-title">üë• Tambah Customer Baru</H3>
              <BUTTON CLASS="close-btn" ONCLICK="closeAddCustomer()">√ó</BUTTON>
            </DIV>
            <DIV>
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Nama Customer *</LABEL>
                <INPUT TYPE="text" CLASS="form-input" ID="customerNama" PLACEHOLDER="Nama lengkap customer" REQUIRED="">
                <DIV CLASS="form-help">Nama lengkap untuk pengiriman</DIV>
              </DIV>
              
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">No Telepon *</LABEL>
                <INPUT TYPE="text" CLASS="form-input" ID="customerTelepon" PLACEHOLDER="08123456789" REQUIRED="">
                <DIV CLASS="form-help">Format: 08xxx (untuk WhatsApp notifications)</DIV>
              </DIV>
              
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Alamat Lengkap</LABEL>
                <TEXTAREA CLASS="form-input" ID="customerAlamat" ROWS="3" PLACEHOLDER="Jl. Contoh No. 123, Kelurahan, Kecamatan, Kota, Provinsi"></TEXTAREA>
                <DIV CLASS="form-help">Alamat untuk pengiriman paket</DIV>
              </DIV>
              
              <DIV CLASS="form-group">
                <LABEL CLASS="form-label">Platform Preference</LABEL>
                <SELECT CLASS="form-input" ID="customerPlatform">
                  <OPTION VALUE="both">Both (TikTok & Shopee)</OPTION>
                  <OPTION VALUE="tiktok">TikTok Shop Only</OPTION>
                  <OPTION VALUE="shopee">Shopee Only</OPTION>
                </SELECT>
                <DIV CLASS="form-help">Platform mana yang biasa digunakan customer</DIV>
              </DIV>
              
              <DIV STYLE="margin-top: 1.5rem; display: flex; gap: 1rem;">
                <BUTTON CLASS="btn btn-primary" ONCLICK="saveCustomer()">
                  <SVG WIDTH="16" HEIGHT="16" VIEWBOX="0 0 24 24" FILL="currentColor">
                    <PATH D="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/>
                  </SVG>
                  Simpan Customer
                </BUTTON>
                <BUTTON CLASS="btn btn-secondary" ONCLICK="closeAddCustomer()">Batal</BUTTON>
              </DIV>
            </DIV>
          </DIV>
        </DIV>
        
        <!-- ===== TOAST CONTAINER ===== -->
        <DIV ID="toastContainer"></DIV>
        <SCRIPT>
        // ===== GLOBAL VARIABLES =====
        let currentUser = 'Anonymous';
        let currentDevice = 'Unknown Device';
        let apiKeys = {
        binderbyte: '',
        fonnte: ''
        };
        let trackingData = {
        resiData: [],
        deliveredData: [],
        returnsData: [],
        trackingHistory: {},
        productsData: [],
        movementsData: []
        };

        // ===== AUTO CHECK VARIABLES ===== ‚Üê TAMBAH DISINI
        let autoCheckTimer = null;
        let autoCheckInterval = 0; // dalam menit
        let autoCheckPosition = 0; // posisi terakhir ngecek
        let autoCheckStatus = false; // status running or not
        // ===== DAILY API TRACKING VARIABLES ===== ‚Üê TAMBAH INI AJA DULU
        let dailyAPIStats = {
        totalChecks: 0,
        totalCost: 0,
        delivered: 0,
        returns: 0,
        lastReset: new Date().toDateString()
        };

        // ===== PUSHER REALTIME VARIABLES ===== ‚Üê TAMBAH INI
        let pusher = null;
        let inventoryChannel = null;

        // Initialize Pusher
        function initializePusher() {
        pusher = new Pusher('f34c00dfd65c19c38d15', {
        cluster: 'ap1'
        });

        inventoryChannel = pusher.subscribe('inventory-channel');

        // Listen for product added
        inventoryChannel.bind('product-added', function(data) {
        console.log('üîÑ Product added:', data);
        showToast(`‚úÖ ${data.user} menambah produk ${data.sku}`, 'success');

        // Refresh inventory table
        if (document.querySelector('.section.active').id === 'inventory') {
            loadMasterProducts();
        }
        });
        }

        // ===== COURIER DETECTION PATTERNS =====
        const courierPatterns = {
        'J&T Express': ['^JX', '^JO'],
        'JNE': ['^012300', '^013990', '^019664', '^013781', '^012098', '^012231', '^013992'],
        'SiCepat Express': ['^0029', '^004441', '^004442', '^004443', '^004444', '^004445', '^004446'],
        'SAP Express': ['^KOMSHIP', '^OO00', '^MGT'],
        'Ninja Express': ['^ORDNL', '^NJVT', '^KOMRCKOM', '^NVID'],
        'Shopee Express': ['^SPX'],
        'AnterAja': ['^110'], // ‚Üê TAMBAH INI
        'Lazada Express': ['^NLIDAP', '^LXAD-'],
        'Lion Parcel': ['^JBB1']
        };

        function calculateTotalAPIStats() {
        // Hitung dari existing data (persistent) + session counter
        const totalDelivered = trackingData.deliveredData.length;
        const totalReturns = trackingData.returnsData.length;
        const baseChecks = totalDelivered + totalReturns;

        return {
        totalChecks: baseChecks + dailyAPIStats.totalChecks,
        totalCost: (baseChecks + dailyAPIStats.totalChecks) * 15,
        delivered: totalDelivered,
        returns: totalReturns
        };
        }


        // ===== INITIALIZATION =====
        function initializeApp() {
        const savedUser = localStorage.getItem('v12_user');
        const savedDevice = localStorage.getItem('v12_device');

        if (savedUser) {
        currentUser = savedUser;
        const userNameInput = document.getElementById('user_name');
        if (userNameInput) userNameInput.value = savedUser;
        }

        if (savedDevice) {
        currentDevice = savedDevice;
        const deviceNameInput = document.getElementById('device_name');
        if (deviceNameInput) deviceNameInput.value = savedDevice;
        }

        if (currentDevice === 'Unknown Device') {
        currentDevice = 'Browser-' + new Date().getTime();
        localStorage.setItem('v12_device', currentDevice);
        }

        // ===== LOAD AUTO CHECK POSITION ===== ‚Üê TAMBAH INI
        loadAutoCheckPosition();

        // ===== INITIALIZE PUSHER ===== ‚Üê TAMBAH INI
        initializePusher();

        // ===== INITIALIZE DAILY API STATS ===== ‚Üê TAMBAH INI
        dailyAPIStats.totalChecks = 0;
        dailyAPIStats.totalCost = 0;
        dailyAPIStats.delivered = 0;
        dailyAPIStats.returns = 0;

        console.log('V12 Panel initialized', { user: currentUser, device: currentDevice });
        }
        // ===== SIDEBAR FUNCTIONALITY =====
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        // ===== EVENT LISTENERS SETUP =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadSettings();
            loadTrackingData();
            setupEventListeners();
            
            setTimeout(checkBackupData, 1000);
            
            setTimeout(() => {
                const scanInput = document.getElementById('scanInput');
                if (scanInput) scanInput.focus();
            }, 500);
            
            setTimeout(() => {
                showToast('üöÄ V12 Panel siap digunakan! Tekan Alt+1-5 untuk navigasi cepat.', 'info');
            }, 1500);
        });

        function setupEventListeners() {
            // Sidebar navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = e.target.closest('.nav-link').dataset.section;
                    if (section) {
                        switchSection(section);
                        if (window.innerWidth <= 768) {
                            closeSidebar();
                        }
                    }
                });
            });

            // Scan input
            const scanInput = document.getElementById('scanInput');
            if (scanInput) {
                scanInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        processScanInput();
                    }
                });
            }

            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tab = e.target.dataset.tab;
                    if (tab) switchTab(tab);
                });
            });

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    applyFilters();
                });
            }

            // Inventory search
            const inventorySearch = document.getElementById('inventorySearch');
            if (inventorySearch) {
                inventorySearch.addEventListener('input', (e) => {
                    filterInventoryData(e.target.value);
                });
            }

            // Select all checkboxes
            document.addEventListener('change', (e) => {
                if (e.target.id === 'selectAllProses' || e.target.id === 'selectAllDelivered' || e.target.id === 'selectAllReturn') {
                    const tabId = e.target.id.replace('selectAll', '').toLowerCase();
                    const checkboxes = document.querySelectorAll('#' + tabId + '-tab .table-checkbox:not([id])');
                    checkboxes.forEach(cb => cb.checked = e.target.checked);
                }
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) {
                    const sidebar = document.getElementById('sidebar');
                    const toggle = document.querySelector('.mobile-toggle');
                    
                    if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
                        closeSidebar();
                    }
                }
            });

            // Modal close on overlay click
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // ===== NAVIGATION =====
        function switchSection(sectionId) {
        // DESTROY CHART WHEN LEAVING DASHBOARD
        if (window.myChart) {
        window.myChart.destroy();
        window.myChart = null;
        }

        document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
        });

        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
        targetSection.classList.add('active');
        }

        document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        });
        const activeLink = document.querySelector('[data-section="' + sectionId + '"]');
        if (activeLink) {
        activeLink.classList.add('active');
        }
        updatePageTitle(sectionId);
        if (sectionId === 'tracking') {
        loadTrackingData();
        // ‚úÖ TAMBAHIN INI: Activate tab pertama
        activateFirstTab('tracking', 'proses');
        } else if (sectionId === 'dashboard') {
        loadDashboardData();
        } else if (sectionId === 'inventory') {
        loadInventoryData();           
        loadMasterProducts();          
        updateInventoryStats();        
        loadMovementHistory();         
        populateProductDropdown();     
        updateInventoryReports();

        // Set default date di movement form
        setTimeout(() => {
            const movementDate = document.getElementById('movementDate');
            if (movementDate) {
                movementDate.value = new Date().toISOString().slice(0,10);
            }
        }, 100);

        // ‚úÖ TAMBAHIN INI: Activate tab pertama  
        activateFirstTab('inventory', 'master');
        } else if (sectionId === 'ai-intelligence') {
        console.log('ü§ñ Loading AI Intelligence...');
        updateAIDashboardRealtime();
        updateAutoCheckStatus();
        updateAIPredictions();
        updateAutoCheckHistoryTable();

        // ‚úÖ TAMBAHIN INI: Activate tab pertama
        activateFirstTab('ai-intelligence', 'monitoring');
        } else if (sectionId === 'auto-reports') {
    console.log('üìä Loading Auto Reports...');
    activateFirstTab('auto-reports', 'history');
    
    setTimeout(() => {
        loadAutoReportsData();
    }, 200);  // 200ms delay - cukup untuk DOM ready
} else if (sectionId === 'customer-engagement') {
    console.log('üë• Loading Customer Engagement...');
    activateFirstTab('customer-engagement', 'dashboard');
    
    setTimeout(() => {
        loadCustomerEngagementData();
    }, 200);
}
        }

        // ‚úÖ TAMBAHIN FUNCTION HELPER INI
        function activateFirstTab(sectionId, defaultTabId) {
        const section = document.getElementById(sectionId);
        if (!section) return;

        // Reset semua tabs di section ini
        const tabBtns = section.querySelectorAll('.tab-btn');
        const tabPanels = section.querySelectorAll('.tab-panel');

        tabBtns.forEach(btn => btn.classList.remove('active'));
        tabPanels.forEach(panel => panel.classList.remove('active'));

        // Activate tab pertama secara explicit
        const firstTabBtn = section.querySelector('[data-tab="' + defaultTabId + '"]');
        const firstTabPanel = section.querySelector('#' + defaultTabId + '-tab');

        if (firstTabBtn) firstTabBtn.classList.add('active');
        if (firstTabPanel) firstTabPanel.classList.add('active');

        console.log('‚úÖ Activated first tab:', defaultTabId, 'in section:', sectionId);
        }

        function updatePageTitle(sectionId) {
        const pageTitle = document.getElementById('pageTitle');
       const titles = {
        scan: 'Scan Resi',
        tracking: 'Tracking Resi',
        dashboard: 'Dashboard',
        inventory: 'Inventory',
        'ai-intelligence': 'AI Intelligence',
        'auto-reports': 'Auto Reports',
        'customer-engagement': 'Customer Engagement',  // ‚Üê TAMBAH INI
        settings: 'Settings'
        };

        const icons = {
        scan: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 7V5C3 3.89 3.89 3 5 3H7V5H5V7H3M17 3H19C20.11 3 21 3.89 21 5V7H19V5H17V3M21 17V19C21 20.11 20.11 21 19 21H17V19H19V17H21M7 21H5C3.89 21 3 20.11 3 19V17H5V19H7V21M9 7V9H15V7H9M11 11V13H13V11H11M9 15V17H15V15H9Z"/><\/svg>',
        tracking: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8C18.34 8 18.67 8.04 19 8.09V2H5V22H12.81C12.28 21.09 12 20.05 12 19C12 15.69 14.69 13 18 13C18.34 13 18.67 13.04 19 13.09V11H5V13H10V15H5V17H9.09C9.04 17.33 9 17.66 9 18H5V20H10.09C10.89 21.28 12.28 22.09 13.81 22H19V16.91C18.67 16.96 18.34 17 18 17C14.69 17 12 14.31 12 11S14.69 5 18 5 24 7.69 24 11 21.31 17 18 17Z"/><\/svg>',
        dashboard: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3H11V11H3V3M13 3H21V11H13V3M3 13H11V21H3V13M13 13H21V21H13V13Z"/><\/svg>',
        inventory: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 8H4V6C4 4.89 4.89 4 6 4H18C19.11 4 20 4.89 20 6V8M5 10V19H19V10H5M12 12C13.11 12 14 12.89 14 14S13.11 16 12 16 10 15.11 10 14 10.89 12 12 12Z"/><\/svg>',
        'auto-reports': '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/><\/svg>',
        'customer-engagement': '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25Z"/><\/svg>',  // ‚Üê TAMBAH INI
        settings: '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8C9.79 8 8 9.79 8 12S9.79 16 12 16 16 14.21 16 12 14.21 8 12 8M12 14C10.9 14 10 13.11 10 12S10.9 10 12 10 14 10.9 14 12 13.11 14 12 14M19.43 12.98C19.47 12.66 19.5 12.34 19.5 12S19.47 11.34 19.43 11.02L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.96 19.05 5.05L16.56 6.05C16.04 5.65 15.5 5.32 14.87 5.07L14.5 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.5 2.42L9.13 5.07C8.5 5.32 7.96 5.65 7.44 6.05L4.95 5.05C4.73 4.96 4.46 5.05 4.34 5.27L2.34 8.73C2.22 8.95 2.27 9.22 2.46 9.37L4.57 11.02C4.53 11.34 4.5 11.66 4.5 12S4.53 12.66 4.57 12.98L2.46 14.63C2.27 14.78 2.22 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.04 4.95 18.95L7.44 17.95C7.96 18.35 8.5 18.68 9.13 18.93L9.5 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.5 21.58L14.87 18.93C15.5 18.68 16.04 18.35 16.56 17.95L19.05 18.95C19.27 19.04 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.98Z"/><\/svg>'
        };
            
        if (pageTitle && titles[sectionId] && icons[sectionId]) {
        pageTitle.innerHTML = icons[sectionId] + titles[sectionId];
        }
        }

        function switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        });
        const activeTab = document.querySelector('[data-tab="' + tabId + '"]');
        if (activeTab) {
        activeTab.classList.add('active');
        }

        document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
        });
        const targetPanel = document.getElementById(tabId + '-tab');
        if (targetPanel) {
        targetPanel.classList.add('active');
        }
        }

        // ===== COURIER DETECTION =====
        function detectCourier(resi) {
            const cleanResi = resi.toString().toUpperCase().trim();
            
            for (const [courier, patterns] of Object.entries(courierPatterns)) {
                for (const pattern of patterns) {
                    const regex = new RegExp(pattern);
                    if (regex.test(cleanResi)) {
                        return courier;
                    }
                }
            }
            return 'Unknown';
        }

        // ===== COURIER DETECTION =====
        function detectCourier(resi) {
            const cleanResi = resi.toString().toUpperCase().trim();
            
            for (const [courier, patterns] of Object.entries(courierPatterns)) {
                for (const pattern of patterns) {
                    const regex = new RegExp(pattern);
                    if (regex.test(cleanResi)) {
                        return courier;
                    }
                }
            }
            return 'Unknown';
        }

        // ===== AUTO CHECK FUNCTIONS ===== ‚Üê TAMBAH DISINI
        // Function untuk get resi yang perlu dicek (pending/error/proses only)
        function getPendingResiList() {
            return trackingData.resiData.filter(item => {
                const status = item.statusAPI;
                return status === 'Pending' || 
                       status === 'Error' || 
                       (status !== 'DELIVERED' && !status.includes('RETURN'));
            });
        }

        // Core auto check function
        async function runAutoCheck() {
        const pendingList = getPendingResiList();

        if (pendingList.length === 0) {
        console.log('ü§ñ Auto Check: No pending resi to check');
        autoCheckPosition = 0;
        return;
        }

        // Reset position jika sudah mencapai akhir
        if (autoCheckPosition >= pendingList.length) {
        autoCheckPosition = 0;
        }

        // Ambil resi berikutnya
        const currentResi = pendingList[autoCheckPosition];
        const beforeStatus = currentResi.statusAPI;
        const timestamp = new Date().toISOString();
        const timeString = new Date().toLocaleTimeString('id-ID');

        console.log(`ü§ñ Auto Check: Checking resi ${currentResi.resi} (${autoCheckPosition + 1}/${pendingList.length})`);

        // Check resi
        const result = await checkAndUpdateResi(currentResi);

        // ===== SAVE HISTORY TO DATABASE (IMPROVED) =====
        try {
        const historyData = {
            action: 'save_autocheck_history',
            resi: currentResi.resi,
            courier: currentResi.ekspedisi,
            before_status: beforeStatus,
            after_status: result.status || beforeStatus,
            result: result.success ? (result.status !== beforeStatus ? 'SUCCESS' : 'NO_CHANGE') : 'API_ERROR',
            cost: 15,
            check_time: timestamp,
            user: currentUser,
            device: currentDevice
        };

        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(historyData)
        });

        const saveResult = await response.json();
        if (saveResult.success) {
            console.log(`üìù Auto check history saved for ${currentResi.resi}`);
        } else {
            console.error('‚ùå Failed to save auto check history:', saveResult.message);
        }
        } catch (error) {
        console.error('üí• Error saving auto check history:', error);
        }
        // ===== END SAVE TO DATABASE =====

        // Update position untuk next check
        autoCheckPosition++;
        await saveAutoCheckPosition(); // ‚Üê GANTI JADI INI

        if (result.success) {
        console.log(`‚úÖ Auto Check: ${currentResi.resi} - ${result.status}`);

        // ===== FULL DATABASE UPDATE & UI REFRESH =====
        loadTrackingData();

        // Real-time UI updates (delay sedikit biar loadTrackingData kelar dulu)
        setTimeout(() => {
            updateDailySummaryStats();           // Update daily stats
            updateAutoCheckHistoryTable();      // Refresh history table  
            updateAutoCheckStatus();            // Update status indicators
            console.log('üîÑ UI refreshed after auto check');
        }, 1500);
        // ===== END FULL UPDATE =====
        }
        }

        // Function untuk save history ke database
        async function saveAutoCheckHistory(historyData) {
        try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'save_autocheck_history',
                ...historyData
            })
        });

        const result = await response.json();
        if (!result.success) {
            console.error('Failed to save auto check history:', result.message);
        }
        } catch (error) {
        console.error('Error saving auto check history:', error);
        }
        }

        // Timer management functions (DATABASE INTEGRATED)
        async function startAutoCheck() {
        // Stop existing timer dulu
        if (autoCheckTimer) {
        clearInterval(autoCheckTimer);
        }

        if (autoCheckInterval > 0) {
        const intervalMs = autoCheckInterval * 60 * 1000; // convert ke milliseconds
        autoCheckTimer = setInterval(async () => {
            await runAutoCheck();
        }, intervalMs);

        autoCheckStatus = true;

        // ===== SAVE START EVENT TO DATABASE =====
        try {
            const response = await fetch('database.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'save_autocheck_event',
                    event_type: 'START',
                    interval_minutes: autoCheckInterval,
                    user: currentUser,
                    device: currentDevice,
                    timestamp: new Date().toISOString()
                })
            });
            
            const result = await response.json();
            if (result.success) {
                console.log('üìä Auto check START event saved to database');
            }
        } catch (error) {
            console.error('Error saving auto check start event:', error);
        }
        // ===== END SAVE TO DATABASE =====

        showToast(`ü§ñ Auto check started (setiap ${autoCheckInterval} menit)`, 'info');
        console.log(`ü§ñ Auto Check started: ${autoCheckInterval} minutes interval`);
        }
        }

        async function stopAutoCheck() {
        if (autoCheckTimer) {
        clearInterval(autoCheckTimer);
        autoCheckTimer = null;
        autoCheckStatus = false;

        // ===== SAVE STOP EVENT TO DATABASE =====
        try {
            const response = await fetch('database.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'save_autocheck_event',
                    event_type: 'STOP',
                    user: currentUser,
                    device: currentDevice,
                    timestamp: new Date().toISOString()
                })
            });
            
            const result = await response.json();
            if (result.success) {
                console.log('üìä Auto check STOP event saved to database');
            }
        } catch (error) {
            console.error('Error saving auto check stop event:', error);
        }
        // ===== END SAVE TO DATABASE =====

        showToast('üõë Auto check stopped', 'info');
        console.log('üõë Auto Check stopped');
        }
        }

        // Load auto check position dari DATABASE (bukan localStorage)
        async function loadAutoCheckPosition() {
        try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_autocheck_position',
                user: currentUser,
                device: currentDevice
            })
        });

        const result = await response.json();
        if (result.success && result.position !== undefined) {
            autoCheckPosition = parseInt(result.position) || 0;
            console.log(`üìç Auto check position loaded from database: ${autoCheckPosition}`);
        } else {
            // Fallback to localStorage
            const savedPosition = localStorage.getItem('v12_autocheck_position');
            autoCheckPosition = parseInt(savedPosition) || 0;
            console.log(`üìç Auto check position loaded from localStorage: ${autoCheckPosition}`);
        }
        } catch (error) {
        console.error('Error loading auto check position:', error);
        // Fallback to localStorage
        const savedPosition = localStorage.getItem('v12_autocheck_position');
        autoCheckPosition = parseInt(savedPosition) || 0;
        }
        }

        // ===== TAMBAHAN: SAVE POSITION TO DATABASE =====
        async function saveAutoCheckPosition() {
        try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'save_autocheck_position',
                position: autoCheckPosition,
                user: currentUser,
                device: currentDevice
            })
        });

        // Tetap save ke localStorage juga sebagai backup
        localStorage.setItem('v12_autocheck_position', autoCheckPosition.toString());
        } catch (error) {
        console.error('Error saving auto check position:', error);
        // Fallback to localStorage only
        localStorage.setItem('v12_autocheck_position', autoCheckPosition.toString());
        }
        }

        // ===== SCAN FUNCTIONALITY =====
        function processScanInput() {
            const input = document.getElementById('scanInput');
            const resi = input.value.trim();
            
            if (!resi) {
                showToast('‚ùå Nomor resi tidak boleh kosong!', 'error');
                return;
            }

            if (isResiExists(resi)) {
                showToast('‚ùå Resi ' + resi + ' sudah ada di sistem!', 'error');
                input.value = '';
                input.focus();
                return;
            }

            const courier = detectCourier(resi);
            const now = new Date();
            
            const newResi = {
                tanggal: formatDateIndo(now),
                resi: resi,
                ekspedisi: courier,
                jamScan: formatTime(now),
                statusAPI: 'Pending',
                namaPenerima: '',
                tglDiterima: '',
                keterangan: '',
                created_by: currentUser,
                updated_at: now.toISOString()
            };

            saveResi(newResi);
            
            input.value = '';
            input.focus();
            
            const courierDisplay = courier === 'Unknown' ? '‚ùì Unknown' : '‚úÖ ' + courier;
            showToast('‚úÖ Resi ' + resi + ' berhasil discan (' + courierDisplay + ')', 'success');
        }

        function isResiExists(resi) {
            const allData = [
                ...trackingData.resiData,
                ...trackingData.deliveredData,
                ...trackingData.returnsData
            ];
            return allData.some(item => item.resi === resi);
        }

        // ===== BULK IMPORT =====
        function openBulkImport() {
            document.getElementById('bulkImportModal').style.display = 'flex';
            document.getElementById('bulkResiInput').focus();
        }

        function closeBulkImport() {
            document.getElementById('bulkImportModal').style.display = 'none';
            document.getElementById('bulkResiInput').value = '';
        }

        function processBulkImport() {
            const textarea = document.getElementById('bulkResiInput');
            const resiList = textarea.value.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
                
            if (resiList.length === 0) {
                showToast('‚ùå Tidak ada nomor resi untuk diimport!', 'error');
                return;
            }

            let successCount = 0;
            let duplicateCount = 0;
            let errorCount = 0;

            resiList.forEach(resi => {
                if (isResiExists(resi)) {
                    duplicateCount++;
                    return;
                }

                try {
                    const courier = detectCourier(resi);
                    const now = new Date();
                    
                    const newResi = {
                        tanggal: formatDateIndo(now),
                        resi: resi,
                        ekspedisi: courier,
                        jamScan: formatTime(now),
                        statusAPI: 'Pending',
                        namaPenerima: '',
                        tglDiterima: '',
                        keterangan: '',
                        created_by: currentUser,
                        updated_at: now.toISOString()
                    };

                    saveResi(newResi);
                    successCount++;
                } catch (error) {
                    errorCount++;
                }
            });

            let message = 'üì¶ Import selesai!\n‚úÖ Berhasil: ' + successCount;
            if (duplicateCount > 0) message += '\nüîÑ Duplikat: ' + duplicateCount;
            if (errorCount > 0) message += '\n‚ùå Error: ' + errorCount;
            
            showToast(message, successCount > 0 ? 'success' : 'error');
            
            loadTrackingData();
            closeBulkImport();
        }

        // ===== DATABASE OPERATIONS =====
        async function saveResi(resiData) {
            try {
                const response = await fetch('database.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save_resi',
                        ...resiData,
                        user: currentUser,
                        device: currentDevice
                    })
                });

                const result = await response.json();
                if (result.success) {
                    resiData.id = result.id;
                    if (!trackingData.resiData.find(item => item.resi === resiData.resi)) {
                        trackingData.resiData.unshift(resiData);
                    }
                    updateTrackingCounts();
                    updateTrackingTables();
                }
                return result;
            } catch (error) {
                console.error('Error saving resi:', error);
                return { success: false, message: error.message };
            }
        }

        async function loadTrackingData() {
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'load_all',
                user: currentUser,
                device: currentDevice
            })
        });

        const result = await response.json();
        if (result.success) {
            trackingData = {
                resiData: result.resiData || [],
                deliveredData: result.deliveredData || [],
                returnsData: result.returnsData || [],
                trackingHistory: result.trackingHistory || {},
                productsData: result.productsData || [],
                movementsData: result.movementsData || []
            };
            
            updateTrackingCounts();
            updateTrackingTables();
            updateInventoryStats();
            updateDashboardStats();
            
            // ‚úÖ TAMBAH INI - Auto sync orders setiap kali load tracking data
            await syncOrderTrackingStatus();
        }
    } catch (error) {
        console.error('Error loading tracking data:', error);
        showToast('‚ùå Error loading data', 'error');
    }
}

        // ===== FILTERING =====
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const courierFilter = document.getElementById('filterCourier').value;
            
            const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
            const tbody = document.getElementById(activeTab + 'TableBody');
            
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const cells = row.querySelectorAll('td');
                
                let showRow = true;

                // Search filter
                if (searchTerm && !text.includes(searchTerm)) {
                    showRow = false;
                }

                // Status filter
                if (statusFilter && activeTab === 'proses') {
                    const statusCell = cells[6]; // Status column
                    if (statusCell && !statusCell.textContent.includes(statusFilter)) {
                        showRow = false;
                    }
                }

                // Courier filter
                if (courierFilter) {
                    const courierCell = cells[4]; // Ekspedisi column
                    if (courierCell && !courierCell.textContent.includes(courierFilter)) {
                        showRow = false;
                    }
                }

                row.style.display = showRow ? '' : 'none';
            });
        }

        // ===== INVENTORY FUNCTIONS =====
        async function loadInventoryData() {
            updateInventoryTable();
            updateInventoryStats();
        }

        function updateInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            if (trackingData.productsData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="9" style="text-align: center; color: var(--text-muted);">Belum ada produk. Klik "Tambah Produk" untuk menambah produk baru.<\/td>';
                tbody.appendChild(row);
                return;
            }

            trackingData.productsData.forEach((product) => {
                const movements = trackingData.movementsData.filter(m => m.sku === product.sku);
                const stockIn = movements.filter(m => m.type === 'in').reduce((sum, m) => sum + parseInt(m.qty), 0);
                const stockOut = movements.filter(m => m.type === 'out').reduce((sum, m) => sum + parseInt(m.qty), 0);
                const currentStock = parseInt(product.stok_awal) + stockIn - stockOut;

                const row = document.createElement('tr');
                row.innerHTML = '<td>' + product.sku + '<\/td><td>' + product.nama_barang + '<\/td><td>' + product.unit + '<\/td><td>' + product.stok_awal + '<\/td><td>' + stockIn + '<\/td><td>' + stockOut + '<\/td><td><span class="status-badge ' + (currentStock <= 5 ? 'status-error' : 'status-delivered') + '">' + currentStock + '<\/span><\/td><td>Rp ' + formatNumber(product.harga || 0) + '<\/td><td><div class="action-buttons"><button class="btn btn-sm btn-secondary" onclick="editProduct(\'' + product.sku + '\')">‚úèÔ∏è<\/button><button class="btn btn-sm btn-info" onclick="addMovement(\'' + product.sku + '\')">üì¶<\/button><button class="btn btn-sm btn-danger" onclick="deleteProduct(\'' + product.sku + '\')">üóëÔ∏è<\/button><\/div><\/td>';
                tbody.appendChild(row);
            });
        }

        function updateInventoryStats() {
            const totalProducts = trackingData.productsData.length;
            let lowStockCount = 0;
            let stockInMonth = 0;
            let stockOutMonth = 0;

            const currentMonth = new Date().toISOString().slice(0, 7);

            trackingData.productsData.forEach(product => {
                const movements = trackingData.movementsData.filter(m => m.sku === product.sku);
                const stockIn = movements.filter(m => m.type === 'in').reduce((sum, m) => sum + parseInt(m.qty), 0);
                const stockOut = movements.filter(m => m.type === 'out').reduce((sum, m) => sum + parseInt(m.qty), 0);
                const currentStock = parseInt(product.stok_awal) + stockIn - stockOut;

                if (currentStock <= 5) {
                    lowStockCount++;
                }
            });

            trackingData.movementsData.forEach(movement => {
                if (movement.movement_date && movement.movement_date.startsWith(currentMonth)) {
                    if (movement.type === 'in') {
                        stockInMonth += parseInt(movement.qty);
                    } else if (movement.type === 'out') {
                        stockOutMonth += parseInt(movement.qty);
                    }
                }
            });

            const totalProductsEl = document.getElementById('totalProducts');
            const lowStockEl = document.getElementById('lowStockProducts');
            const stockInEl = document.getElementById('stockInMonth');
            const stockOutEl = document.getElementById('stockOutMonth');
            const lowStockBadgeEl = document.getElementById('lowStockCount');

            if (totalProductsEl) totalProductsEl.textContent = totalProducts;
            if (lowStockEl) lowStockEl.textContent = lowStockCount;
            if (stockInEl) stockInEl.textContent = stockInMonth;
            if (stockOutEl) stockOutEl.textContent = stockOutMonth;
            if (lowStockBadgeEl) lowStockBadgeEl.textContent = lowStockCount;
        }

        function filterInventoryData(searchTerm) {
            const tbody = document.getElementById('inventoryTableBody');
            if (!tbody) return;

            const rows = tbody.querySelectorAll('tr');
            const term = searchTerm.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(term)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function addNewProduct() {
            const sku = prompt('Masukkan SKU produk:');
            if (!sku) return;

            const nama_barang = prompt('Masukkan nama barang:');
            if (!nama_barang) return;

            const unit = prompt('Masukkan unit (pcs/kg/liter):', 'pcs');
            const stok_awal = parseInt(prompt('Masukkan stok awal:', '0') || '0');
            const harga = parseFloat(prompt('Masukkan harga:', '0') || '0');

            saveProduct({ sku, nama_barang, unit, stok_awal, harga });
        }

        async function saveProduct(productData) {
            try {
                const response = await fetch('database.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save_product',
                        ...productData,
                        user: currentUser,
                        device: currentDevice
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('‚úÖ Produk berhasil ditambahkan!', 'success');
                    loadTrackingData();
                } else {
                    showToast('‚ùå Error: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('‚ùå Error saving product: ' + error.message, 'error');
            }
        }



        function addMovement(sku) {
            const type = prompt('Masukkan tipe (in/out):', 'in');
            if (type !== 'in' && type !== 'out') {
                showToast('‚ùå Tipe harus "in" atau "out"!', 'error');
                return;
            }

            const qty = parseInt(prompt('Masukkan quantity:', '1') || '1');
            if (qty <= 0) {
                showToast('‚ùå Quantity harus lebih dari 0!', 'error');
                return;
            }

            const notes = prompt('Masukkan catatan (opsional):') || '';

            saveMovement({ sku, type, qty, notes, movement_date: new Date().toISOString().slice(0, 10) });
        }

        async function saveMovement() {
        // Get form data
        const type = document.getElementById('movementType').value;
        const productSku = document.getElementById('movementProduct').value;
        const qty = parseInt(document.getElementById('movementQty').value) || 0;
        const date = document.getElementById('movementDate').value;
        const notes = document.getElementById('movementNotes').value.trim();

        // Validation
        if (!productSku) {
        showToast('‚ùå Pilih produk terlebih dahulu!', 'error');
        return;
        }

        if (qty <= 0) {
        showToast('‚ùå Quantity harus lebih dari 0!', 'error');
        return;
        }

        if (!date) {
        showToast('‚ùå Tanggal wajib diisi!', 'error');
        return;
        }

        showToast('üîÑ Menyimpan movement...', 'info');

        try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'save_movement',
                sku: productSku,
                type: type,
                qty: qty,
                notes: notes,
                movement_date: date,
                user: currentUser,
                device: currentDevice
            })
        });

        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ Movement berhasil disimpan!', 'success');
            clearMovementForm();
            loadMovementHistory();
            loadMasterProducts(); // Refresh untuk update current stock
            updateLaporanLastUpdatedInfo();
            updateMovementLastUpdatedInfo();
        } else {
            showToast('‚ùå Error: ' + result.message, 'error');
        }
        } catch (error) {
        showToast('‚ùå Error: ' + error.message, 'error');
        }
        }

        function clearMovementForm() {
        document.getElementById('movementProduct').value = '';
        document.getElementById('movementQty').value = '';
        document.getElementById('movementNotes').value = '';
        document.getElementById('movementDate').value = new Date().toISOString().slice(0,10);
        }

        function editProduct(id) {  // ‚Üê ganti parameter dari sku ke id
        // Cari data produk pake ID
        const product = trackingData.productsData.find(p => p.id == id);  // ‚Üê ganti ini
        if (!product) {
        showToast('‚ùå Produk tidak ditemukan!', 'error');
        return;
        }

        // Isi modal dengan data existing  
        document.getElementById('productSKU').value = product.sku;
        document.getElementById('productName').value = product.nama_barang;
        document.getElementById('productUnit').value = product.unit;
        document.getElementById('productStock').value = product.stok_awal;
        document.getElementById('productPrice').value = product.harga;

        // Ganti title modal & button
        document.querySelector('.modal-title').textContent = '‚úèÔ∏è Edit Produk';
        document.querySelector('#addProductModal .btn-primary').textContent = 'Update Produk';

        // Set mode edit
        window.editMode = true;
        window.editingId = id;  // ‚Üê simpan ID, bukan SKU

        // Buka modal
        document.getElementById('addProductModal').style.display = 'flex';
        document.getElementById('productSKU').focus();
        }

        async function deleteProduct(productId) {  // ‚Üê Ganti parameter jadi ID
        const product = trackingData.productsData.find(p => p.id == productId);
        const productName = product ? product.sku : 'Unknown';

        if (!confirm('Yakin hapus produk ' + productName + '?\n\nData akan dihapus permanen!')) return;

        showToast('üóëÔ∏è Menghapus produk...', 'info');

        try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'delete_product',
                id: productId,  // ‚Üê Kirim ID, bukan SKU
                user: currentUser,
                device: currentDevice
            })
        });

        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ Produk berhasil dihapus!', 'success');
            loadMasterProducts();
        } else {
            showToast('‚ùå Error: ' + result.message, 'error');
        }
        } catch (error) {
        showToast('‚ùå Error: ' + error.message, 'error');
        }
        }


        // ===== REFRESH & EXPORT FUNCTIONS =====
        function refreshProducts() {
        showToast('üîÑ Refreshing data...', 'info');
        loadMasterProducts();
        }

        function exportProducts() {
        if (trackingData.productsData.length === 0) {
        showToast('‚ùå Tidak ada data untuk di-export!', 'error');
        return;
        }

        // Create CSV data
        let csv = 'SKU,Nama Barang,Unit,Stok Awal,Harga\n';
        trackingData.productsData.forEach(product => {
        csv += `"${product.sku}","${product.nama_barang}","${product.unit}",${product.stok_awal},${product.harga}\n`;
        });

        // Download CSV
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `master_products_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
        URL.revokeObjectURL(url);

        showToast('‚úÖ Data berhasil di-export!', 'success');
        }

        function toggleMovementForm() {
        const formCard = document.getElementById('movementFormCard');
        const toggleBtn = document.getElementById('toggleFormBtn');

        if (formCard.style.display === 'none') {
        formCard.style.display = 'block';
        toggleBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19,13H5V11H19V13Z"/>
            <\/svg>
            Tutup Form
        `;
        } else {
        formCard.style.display = 'none';
        toggleBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
            <\/svg>
            Tambah Movement Baru
        `;
        }
        }

        function closeMovementForm() {
        const formCard = document.getElementById('movementFormCard');
        const toggleBtn = document.getElementById('toggleFormBtn');

        formCard.style.display = 'none';
        toggleBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
        <\/svg>
        Tambah Movement Baru
        `;

        // Clear form
        clearMovementForm();
        }



        async function updateDashboardStats() {
        // Get current month from selector or default
        const monthSelector = document.getElementById('monthSelector');
        const currentMonth = monthSelector ? monthSelector.value : '2025-07';

        // Helper function to check if date is in current month
        function isInCurrentMonth(tanggalStr) {
        // Handle different date formats
        if (currentMonth === '2025-07' && tanggalStr.includes('Juli 2025')) {
            return true;
        }
        if (currentMonth === '2025-06' && tanggalStr.includes('Juni 2025')) {
            return true;
        }
        if (currentMonth === '2025-05' && tanggalStr.includes('Mei 2025')) {
            return true;
        }
        // Add more months as needed
        return false;
        }

        // Count delivered this month
        const deliveredThisMonth = trackingData.deliveredData.filter(item => 
        isInCurrentMonth(item.tanggal)
        );

        // Count returns this month  
        const returnsThisMonth = trackingData.returnsData.filter(item => 
        isInCurrentMonth(item.tanggal)
        );

        // Count pending/process this month
        const pendingProcessThisMonth = trackingData.resiData.filter(item => 
        isInCurrentMonth(item.tanggal)
        );

        // Calculate basic counts
        const delivered = deliveredThisMonth.length;
        const returns = returnsThisMonth.length;
        const pending = pendingProcessThisMonth.length;

        // Total pengiriman bulan ini
        const totalPengiriman = delivered + returns + pending;

        // Finalized packages (yang udah ada outcome final)
        const finalizedPackages = delivered + returns;

        // Calculate rates - CUMA dari yang udah final
        const successRate = finalizedPackages > 0 ? Math.round((delivered / finalizedPackages) * 100) : 0;
        const returnRate = finalizedPackages > 0 ? Math.round((returns / finalizedPackages) * 100) : 0;

        // Breakdown pending status
        const pendingCount = pendingProcessThisMonth.filter(item => 
        item.statusAPI === 'Pending' || item.statusAPI === 'Error'
        ).length;

        const onProcessCount = pendingProcessThisMonth.filter(item => 
        item.statusAPI !== 'Pending' && 
        item.statusAPI !== 'Error' && 
        !item.statusAPI.includes('DELIVERED') && 
        !item.statusAPI.includes('RETURN')
        ).length;

        // Update DOM elements
        const totalPengirimanEl = document.getElementById('totalPengiriman');
        const successRateEl = document.getElementById('successRate');
        const returnRateEl = document.getElementById('returnRate');
        const pendingCountEl = document.getElementById('pendingCount');
        const pendingBreakdown = document.getElementById('pendingBreakdown');

        if (totalPengirimanEl) {
        totalPengirimanEl.textContent = totalPengiriman;
        }

        if (successRateEl) {
        successRateEl.innerHTML = successRate + '<span style="font-size: 1rem;">%<\/span>';
        }

        if (returnRateEl) {
        returnRateEl.innerHTML = returnRate + '<span style="font-size: 1rem;">%<\/span>';
        }

        if (pendingCountEl) {
        pendingCountEl.textContent = pending;
        }

        if (pendingBreakdown) {
        pendingBreakdown.textContent = `${onProcessCount} dalam perjalanan | ${pendingCount} Pending`;
        }

        // Update keterangan dengan jumlah paket untuk Success Rate
        const successDesc = document.querySelector('.stats-grid .stat-card:nth-child(2) .stat-change');
        if (successDesc) {
        successDesc.textContent = `${delivered} delivered packages`;
        }

        // Update keterangan dengan jumlah paket untuk Return Rate  
        const returnDesc = document.querySelector('.stats-grid .stat-card:nth-child(3) .stat-change');
        if (returnDesc) {
        returnDesc.textContent = `${returns} return packages`;

        // Tambah ini di akhir function updateDashboardStats()
        const targets = await loadTargetSettings();

        // Update Success Rate dengan progress bar
        const successRateEl = document.getElementById('successRate');
        if (successRateEl) {
        const targetSuccess = targets.success_rate;
        const progressColor = successRate >= targetSuccess ? '#10b981' : successRate >= (targetSuccess - 10) ? '#f59e0b' : '#ef4444';

        successRateEl.innerHTML = `
        ${successRate}<span style="font-size: 1rem;">%<\/span>
        <div style="width: 100%; height: 4px; background: var(--bg-tertiary); border-radius: 2px; margin-top: 8px;">
            <div style="width: ${Math.min(successRate, 100)}%; height: 100%; background: ${progressColor}; border-radius: 2px; transition: all 0.3s ease;"><\/div>
        <\/div>
        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">Target: ${targetSuccess}%<\/div>
        `;
        }

        // Update Return Rate dengan progress bar
        const returnRateEl = document.getElementById('returnRate');
        if (returnRateEl) {
        const targetReturn = targets.return_rate;
        const progressColor = returnRate <= targetReturn ? '#10b981' : returnRate <= (targetReturn + 5) ? '#f59e0b' : '#ef4444';

        returnRateEl.innerHTML = `
        ${returnRate}<span style="font-size: 1rem;">%<\/span>
        <div style="width: 100%; height: 4px; background: var(--bg-tertiary); border-radius: 2px; margin-top: 8px;">
            <div style="width: ${Math.min(returnRate * 4, 100)}%; height: 100%; background: ${progressColor}; border-radius: 2px; transition: all 0.3s ease;"><\/div>
        <\/div>
        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">Max: ${targetReturn}%<\/div>
        `;
        }  
        }

        // Debug log
        console.log('Dashboard Stats:', {
        totalPengiriman,
        delivered,
        returns,
        pending,
        finalizedPackages,
        successRate,
        returnRate,
        onProcessCount,
        pendingCount
        });
        }

        // Call function when dashboard loads
        async function loadDashboardData() {
        updateDashboardStats();
        createCourierChart();
        createTopEkspedisiRanking();
        await createTargetHarianWidget(); // ‚Üê TAMBAH AWAIT
        }

        // Update stats when month selector changes
        document.addEventListener('DOMContentLoaded', function() {
        const monthSelector = document.getElementById('monthSelector');
        if (monthSelector) {
        monthSelector.addEventListener('change', function() {
            updateDashboardStats();
        });
        }
        });

        function mapCourierName(ekspedisi) {
            const mapping = {
        'J&T Express': 'jnt',
        'JNE': 'jne', 
        'SiCepat Express': 'sicepat',
        'SAP Express': 'sap',
        'Ninja Express': 'ninja',
        'Shopee Express': 'spx',
        'AnterAja': 'anteraja', // ‚Üê TAMBAH INI
        'Lazada Express': 'lex',
        'Lion Parcel': 'lion'
        };
            return mapping[ekspedisi] || ekspedisi.toLowerCase();
        }

        async function checkSelectedResi() {
        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
        const checkboxes = document.querySelectorAll('#' + activeTab + '-tab .table-checkbox:checked');
        const selectedResis = Array.from(checkboxes)
        .filter(cb => cb.value && cb.value !== 'on')
        .map(cb => cb.value);

        if (selectedResis.length === 0) {
        showToast('‚ùå Pilih resi yang akan dicek!', 'error');
        return;
        }

        showToast('üîÑ Checking ' + selectedResis.length + ' resi...', 'info');

        let delivered = 0, returned = 0, processing = 0, errors = 0;

        for (const resi of selectedResis) {
        const resiData = trackingData.resiData.find(item => item.resi === resi);
        if (resiData) {
            const result = await checkAndUpdateResi(resiData);
            if (result.success) {
                const status = result.status;
                if (status === 'DELIVERED') delivered++;
                else if (status && status.includes('RETURN')) returned++;
                else if (status === 'Error') errors++;
                else processing++;
            } else {
                errors++;
            }
        }
        }

        // Dynamic summary toast
        let message = `üìä Hasil Check ${selectedResis.length} resi:\n`;
        if (delivered > 0) message += `üöö Delivered: ${delivered}\n`;
        if (processing > 0) message += `üîÑ Processing: ${processing}\n`;
        if (returned > 0) message += `üîÅ Returned: ${returned}\n`;
        if (errors > 0) message += `‚ùå Error: ${errors}`;

        const type = errors > (selectedResis.length / 2) ? 'error' : 'success';
        showToast(message, type);
        loadTrackingData();
        }

        async function checkAllPending() {
        const pendingResis = trackingData.resiData.filter(item => 
        item.statusAPI === 'Pending' || item.statusAPI === 'Error'
        );

        if (pendingResis.length === 0) {
        showToast('‚úÖ Tidak ada resi pending untuk dicek!', 'info');
        return;
        }

        showToast('üîÑ Checking ' + pendingResis.length + ' resi pending...', 'info');

        let delivered = 0, returned = 0, processing = 0, errors = 0;

        for (const resiData of pendingResis) {
        const result = await checkAndUpdateResi(resiData);
        if (result.success) {
            const status = result.status;
            if (status === 'DELIVERED') delivered++;
            else if (status && status.includes('RETURN')) returned++;
            else if (status === 'Error') errors++;
            else processing++;
        } else {
            errors++;
        }
        }

        // Dynamic summary toast
        let message = `üéØ Check All Selesai (${pendingResis.length} resi):\n`;
        if (delivered > 0) message += `üöö Delivered: ${delivered}\n`;
        if (processing > 0) message += `üîÑ Processing: ${processing}\n`;
        if (returned > 0) message += `üîÅ Returned: ${returned}\n`;
        if (errors > 0) message += `‚ùå Error: ${errors}`;

        showToast(message, 'success');
        loadTrackingData();
        }


        async function checkResi(awb, courier) {
        try {
        const response = await fetch('api.php?action=check-resi', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                api_key: apiKeys.binderbyte,
                courier: mapCourierName(courier),
                awb: awb
            })
        });

        return await response.json();
        } catch (error) {
        console.error('Error checking resi:', error);
        return { status: 500, error: error.message };
        }
        }

       async function checkAndUpdateResi(resiData) {
    const result = await checkResi(resiData.resi, resiData.ekspedisi);
    if (!result || result.status !== 200) {
    await updateResiStatus(resiData.resi, {
        statusAPI: 'Error',
        keterangan: 'API Error atau Quota Habis'
    });
    return { success: false, status: 'Error' }; // ‚Üê GANTI: success: FALSE untuk API gagal
    }
    const apiData = result.data;
    const status = (apiData.summary && apiData.summary.status || '').toUpperCase();
    const history = apiData.history || [];
    // Check for return keywords in history
    let isReturn = false;
    const returnKeywords = ['RETURN', 'RETUR', 'DIKEMBALIKAN', 'RTS', 'KEMBALI', 'RETURNED TO SENDER'];
    for (const historyItem of history) {
    const desc = (historyItem.desc || '').toUpperCase();
    if (returnKeywords.some(keyword => desc.includes(keyword))) {
        isReturn = true;
        break;
    }
    }
    let finalStatus = status;
    if (isReturn && !status.includes('DELIVERED')) {
    finalStatus = 'RETURNED TO SENDER';
    }
    // Get receiver name from detail (not summary)
    const namaPenerima = (apiData.detail && apiData.detail.receiver) || '';
    // Get delivery date if delivered
    const tglDiterima = status === 'DELIVERED' ? (apiData.summary.date || '') : '';
    await updateResiStatus(resiData.resi, {
    statusAPI: finalStatus,
    namaPenerima: namaPenerima,
    tglDiterima: tglDiterima,
    keterangan: (history[0] && history[0].desc) || ''
    });
    await saveTrackingHistory(resiData.resi, {
    summary: apiData.summary,
    detail: apiData.detail,
    history: history,
    lastUpdate: new Date().toISOString()
    });
    if (finalStatus === 'DELIVERED') {
    await moveToDelivered(resiData.resi);
    } else if (finalStatus.includes('RETURN')) {
    await moveToReturns(resiData.resi);
    }
    
    // ‚úÖ TAMBAH LINE INI - Update order status juga
    await updateOrderStatusByResi(resiData.resi, finalStatus);
    
    // ===== TAMBAH INI SEBELUM RETURN ===== 
    // Update real-time API counter setiap ada hit Binderbyte
    dailyAPIStats.totalChecks++;
    // Track hasil delivery
    if (finalStatus === 'DELIVERED') {
    dailyAPIStats.delivered++;
    } else if (finalStatus.includes('RETURN')) {
    dailyAPIStats.returns++;
    }
    // Update dashboard langsung
    updateAIDashboardRealtime();
    return { success: true, status: finalStatus }; // ‚Üê SUCCESS: TRUE cuma untuk API berhasil
}

        async function saveTrackingHistory(resi, historyData) {
            try {
                const response = await fetch('database.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save_tracking_history',
                        resi: resi,
                        ...historyData
                    })
                });

                return await response.json();
            } catch (error) {
                console.error('Error saving history:', error);
                return { success: false };
            }
        }

        async function moveToDelivered(resi) {
            try {
                const response = await fetch('database.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'move_to_delivered',
                        resi: resi,
                        user: currentUser,
                        device: currentDevice
                    })
                });

                return await response.json();
            } catch (error) {
                console.error('Error moving to delivered:', error);
                return { success: false };
            }
        }

        async function moveToReturns(resi) {
            try {
                const response = await fetch('database.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'move_to_returns',
                        resi: resi,
                        user: currentUser,
                        device: currentDevice
                    })
                });

                return await response.json();
            } catch (error) {
                console.error('Error moving to returns:', error);
                return { success: false };
            }
        }

        function showDetail(resi) {
            const history = trackingData.trackingHistory[resi];
            const resiData = trackingData.resiData.find(item => item.resi === resi) || 
                            trackingData.deliveredData.find(item => item.resi === resi) || 
                            trackingData.returnsData.find(item => item.resi === resi);
            
            if (!history && !resiData) {
                showToast('‚ùå Detail tracking untuk resi ' + resi + ' tidak ditemukan', 'error');
                return;
            }

            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailContent');

            const jamScan = resiData?.jamScan || 
                           (history?.history && history.history[history.history.length - 1]?.date ? 
                            history.history[history.history.length - 1].date.split(' ')[1] : 'N/A');

            content.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">NO RESI<\/div>
                        <div class="detail-value" style="font-family: monospace;">${resi}<\/div>
                    <\/div>
                    
                    <div class="detail-item">
                        <div class="detail-label">EKSPEDISI<\/div>
                        <div><span class="courier-badge ${getCourierClass(resiData?.ekspedisi || 'Unknown')}">${resiData?.ekspedisi || 'N/A'}<\/span><\/div>
                    <\/div>
                    
                    <div class="detail-item">
                        <div class="detail-label">STATUS<\/div>
                        <div><span class="status-badge ${getStatusClass((history?.summary?.status) || resiData?.statusAPI || 'Pending')}">${(history?.summary?.status) || resiData?.statusAPI || 'PENDING'}<\/span><\/div>
                    <\/div>
                    
                    <div class="detail-item">
                        <div class="detail-label">PENERIMA<\/div>
                        <div class="detail-value">${(history?.summary?.pod_receiver) || resiData?.namaPenerima || 'Belum diketahui'}<\/div>
                    <\/div>
                    
                    <div class="detail-item">
                        <div class="detail-label">PENGIRIM<\/div>
                        <div class="detail-value">CHEMZ COLLECTION<\/div>
                    <\/div>
                    
                    <div class="detail-item">
                        <div class="detail-label">JAM SCAN<\/div>
                        <div class="detail-value" style="font-family: monospace;">${jamScan}<\/div>
                    <\/div>
                <\/div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="detail-item">
                        <div class="detail-label">ASAL<\/div>
                        <div style="color: var(--text-secondary); font-size: 0.8125rem; line-height: 1.4;">${(history?.detail?.origin) || 'Kontrakan ibu badriah (kmr nmr 4) jln raya duri kosambi gang haji sidik RT.5 RW.1.'}<\/div>
                    <\/div>

                    <div class="detail-item">
                        <div class="detail-label">TUJUAN<\/div>
                        <div style="color: var(--text-secondary); font-size: 0.8125rem; line-height: 1.4;">${(history?.detail?.destination) || 'jln.pandu.gg lv Rt.18 No 60 kel. kebun bunga toko rasyid jalan poros sebelah langgar desa rantau atas.'}<\/div>
                    <\/div>
                <\/div>

                <div class="card card-compact">
                    <h3 style="color: var(--text-primary); font-size: 1rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6M12,8A4,4 0 0,0 8,12A4,4 0 0,0 12,16A4,4 0 0,0 16,12A4,4 0 0,0 12,8Z"/>
                        <\/svg>
                        History Tracking
                    <\/h3>
                    <div class="tracking-history">
                        ${history?.history?.map((item, index) => `
                            <div class="tracking-item">
                                <div class="tracking-date">${item.date || ''}<\/div>
                                <div class="tracking-location">${item.location || ''}<\/div>
                                <div class="tracking-desc">${item.desc || ''}<\/div>
                            <\/div>
                        `).join('') || '<div style="text-align: center; color: var(--text-muted); padding: 2rem; font-size: 0.875rem;"><div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã<\/div>Tidak ada riwayat tracking tersedia<\/div>'}
                    <\/div>
                <\/div>
            `;

            modal.style.display = 'flex';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        async function checkSingleResi(resi) {
        const resiData = trackingData.resiData.find(item => item.resi === resi);
        if (resiData) {
        showToast('üîÑ Checking resi ' + resi + '...', 'info');

        const beforeStatus = resiData.statusAPI; // ‚Üê SIMPAN STATUS SEBELUM CHECK
        const timestamp = new Date().toISOString();

        const result = await checkAndUpdateResi(resiData);

        // ===== SAVE MANUAL CHECK HISTORY TO DATABASE =====
        try {
            const historyData = {
                action: 'save_autocheck_history',
                resi: resi,
                courier: resiData.ekspedisi,
                before_status: beforeStatus,
                after_status: result.status || beforeStatus,
                result: result.success ? (result.status !== beforeStatus ? 'SUCCESS' : 'NO_CHANGE') : 'API_ERROR',
                cost: 15,
                check_time: timestamp,
                user: currentUser,
                device: currentDevice
            };
            
            const response = await fetch('database.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(historyData)
            });
            
            const saveResult = await response.json();
            if (saveResult.success) {
                console.log(`üìù Manual check history saved for ${resi}`);
            }
        } catch (error) {
            console.error('Error saving manual check history:', error);
        }
        // ===== END SAVE TO DATABASE =====

        if (result.success) {
            // Dynamic toast based on status
            const status = result.status;
            let message, type;
            
            if (status === 'DELIVERED') {
                message = `üöö DELIVERED - Resi ${resi} sudah sampai!`;
                type = 'success';
            } else if (status && status.includes('RETURN')) {
                message = `üîÅ RETURNED - Resi ${resi} dikembalikan ke pengirim`;
                type = 'error';
            } else if (status === 'Error') {
                message = `‚ùå ERROR - Resi ${resi} gagal dicek atau quota habis`;
                type = 'error';
            } else {
                message = `üîÑ ON PROCESS - Resi ${resi} masih dalam perjalanan`;
                type = 'info';
            }
            
            showToast(message, type);
            loadTrackingData();
            
            // ===== TAMBAH INI - UPDATE AI DASHBOARD =====
            updateAIDashboardRealtime();
            
            // ===== UPDATE UI AFTER MANUAL CHECK =====
            setTimeout(() => {
                updateDailySummaryStats();
                updateAutoCheckHistoryTable();
                updateAutoCheckStatus();
            }, 1000);
        } else {
            showToast('‚ùå Error checking resi ' + resi, 'error');
        }
        }
        }

        async function deleteResi(resi, table) {
            if (!confirm('Yakin hapus resi ' + resi + '?')) return;

            try {
                const response = await fetch('database.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete_resi',
                        resi: resi,
                        table: table,
                        user: currentUser,
                        device: currentDevice
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('‚úÖ Resi ' + resi + ' berhasil dihapus!', 'success');
                    loadTrackingData();
                } else {
                    showToast('‚ùå Error: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('‚ùå Error deleting resi: ' + error.message, 'error');
            }
        }

        // ===== UI UPDATES =====
        function updateTrackingCounts() {
            const prosesElement = document.getElementById('prosesCount');
            const deliveredElement = document.getElementById('deliveredCount');
            const returnElement = document.getElementById('returnCount');
            const totalElement = document.getElementById('totalResiCount');
            
            if (prosesElement) prosesElement.textContent = trackingData.resiData.length;
            if (deliveredElement) deliveredElement.textContent = trackingData.deliveredData.length;
            if (returnElement) returnElement.textContent = trackingData.returnsData.length;
            if (totalElement) {
                const total = trackingData.resiData.length + trackingData.deliveredData.length + trackingData.returnsData.length;
                totalElement.textContent = total;
            }
        }

        function updateTrackingTables() {
            updateProsesTable();
            updateDeliveredTable();
            updateReturnTable();
        }

        function updateProsesTable() {
        const tbody = document.getElementById('prosesTableBody');
        if (!tbody) return;

        tbody.innerHTML = '';
        trackingData.resiData.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="checkbox" class="table-checkbox" value="${item.resi}"><\/td>
            <td>${index + 1}<\/td>
            <td style="font-size: 0.8125rem; white-space: nowrap;">${item.tanggal}<\/td>
            <td style="font-family: monospace; font-size: 0.8125rem; font-weight: 600;">${item.resi}<\/td>
            <td><span class="courier-badge ${getCourierClass(item.ekspedisi)}">${item.ekspedisi}<\/span><\/td>
            <td style="font-family: monospace; font-size: 0.8125rem; white-space: nowrap;">${item.jamScan}<\/td>
            <td><span class="status-badge ${getStatusClass(item.statusAPI)}">${item.statusAPI}<\/span><\/td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-check-modern" onclick="checkSingleResi('${item.resi}')" title="Check Status">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-8 3.58-8 8s3.58 8 8 8c3.14 0 5.86-1.81 7.18-4.42l-1.44-.61A6.02 6.02 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                        <\/svg>
                    <\/button>
                    <button class="btn btn-sm btn-secondary" onclick="showDetail('${item.resi}')" title="Detail">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5z"/>
                        <\/svg>
                    <\/button>
                    <button class="btn btn-sm btn-danger" onclick="deleteResi('${item.resi}', 'resi_data')" title="Hapus">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12z"/>
                        <\/svg>
                    <\/button>
                <\/div>
            <\/td>
        `;
        tbody.appendChild(row);
        });
        }

        function updateDeliveredTable() {
            const tbody = document.getElementById('deliveredTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            trackingData.deliveredData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="table-checkbox" value="${item.resi}"><\/td>
                    <td>${index + 1}<\/td>
                    <td style="font-size: 0.8125rem; white-space: nowrap;">${item.tanggal}<\/td>
                    <td style="font-family: monospace; font-size: 0.8125rem; font-weight: 600;">${item.resi}<\/td>
                    <td><span class="courier-badge ${getCourierClass(item.ekspedisi)}">${item.ekspedisi}<\/span><\/td>
                    <td><span class="status-badge status-delivered">${item.statusAPI}<\/span><\/td>
                    <td style="font-size: 0.8125rem; max-width: 130px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.namaPenerima}">${item.namaPenerima}<\/td>
                    <td style="font-family: monospace; font-size: 0.8125rem; white-space: nowrap;">${item.tglDiterima}<\/td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="showDetail('${item.resi}')" title="Detail">üëÅÔ∏è<\/button>
                            <button class="btn btn-sm btn-danger" onclick="deleteResi('${item.resi}', 'delivered_data')" title="Hapus">üóëÔ∏è<\/button>
                        <\/div>
                    <\/td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateReturnTable() {
            const tbody = document.getElementById('returnTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            trackingData.returnsData.forEach((item, index) => {
                // Simplify status text
                let statusText = item.statusAPI;
                if (statusText.includes('RETURNED TO SENDER') || statusText.includes('RETURN')) {
                    statusText = 'RETURNED';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="table-checkbox" value="${item.resi}"><\/td>
                    <td>${index + 1}<\/td>
                    <td style="font-size: 0.8125rem; white-space: nowrap;">${item.tanggal}<\/td>
                    <td style="font-family: monospace; font-size: 0.8125rem; font-weight: 600;">${item.resi}<\/td>
                    <td><span class="courier-badge ${getCourierClass(item.ekspedisi)}">${item.ekspedisi}<\/span><\/td>
                    <td><span class="status-badge status-return" style="white-space: nowrap; font-size: 0.6875rem;">${statusText}<\/span><\/td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-secondary" onclick="showDetail('${item.resi}')" title="Detail">üëÅÔ∏è<\/button>
                            <button class="btn btn-sm btn-danger" onclick="deleteResi('${item.resi}', 'returns_data')" title="Hapus">üóëÔ∏è<\/button>
                        <\/div>
                    <\/td>
                `;
                tbody.appendChild(row);
            });
        }

        function getCourierClass(courier) {
        const mapping = {
        'J&T Express': 'courier-jnt',
        'JNE': 'courier-jne',
        'SiCepat Express': 'courier-sicepat',
        'SAP Express': 'courier-sap',
        'Shopee Express': 'courier-shopee',
        'Ninja Express': 'courier-ninja',
        'AnterAja': 'courier-anteraja', // ‚Üê TAMBAH INI
        'Unknown': 'courier-unknown'
        };
        return mapping[courier] || 'courier-unknown';
        }

        function getStatusClass(status) {
            if (status === 'Pending') return 'status-pending';
            if (status === 'DELIVERED') return 'status-delivered';
            if (status.includes('RETURN')) return 'status-return';
            if (status === 'Error') return 'status-error';
            return 'status-pending';
        }

        // ===== SETTINGS =====
async function loadSettings() {
try {
const response = await fetch('database.php', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({
        action: 'load_settings',
        user: currentUser
    })
});

const result = await response.json();
if (result.success && result.settings) {
    apiKeys.binderbyte = result.settings.binderbyte_api || '';
    apiKeys.fonnte = result.settings.fonnte_api || '';
    
    const elements = {
        'binderbyte_api': result.settings.binderbyte_api,
        'fonnte_api': result.settings.fonnte_api,
        'target_success': result.settings.target_success,
        'target_return': result.settings.target_return,
        'target_daily': result.settings.target_daily,
        'check_interval': result.settings.check_interval
    };

    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element && elements[id]) {
            element.value = elements[id];
        }
    });

    // ===== START AUTO CHECK JIKA ADA SETTING ===== 
    const checkInterval = parseInt(result.settings.check_interval) || 0;
    if (checkInterval > 0) {
        autoCheckInterval = checkInterval;
        startAutoCheck();
    }
}
} catch (error) {
console.error('Error loading settings:', error);
}

// ===== UPDATE UI BADGE SETELAH LOAD SETTINGS ===== 
updateAutoCheckStatus();
}

        async function saveApiSettings() {
            const binderbyte_api = document.getElementById('binderbyte_api').value.trim();
            const fonnte_api = document.getElementById('fonnte_api').value.trim();
            
            if (!binderbyte_api) {
                showToast('‚ùå Binderbyte API key wajib diisi!', 'error');
                return;
            }

            const user = currentUser || 'defaultuser';
            
            try {
                const response = await fetch('database.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save_settings',
                        user: user,
                        settings: {
                            binderbyte_api: binderbyte_api,
                            fonnte_api: fonnte_api
                        }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    apiKeys.binderbyte = binderbyte_api;
                    apiKeys.fonnte = fonnte_api;
                    showToast('‚úÖ API settings berhasil disimpan!', 'success');
                } else {
                    showToast('‚ùå Error: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('‚ùå Error saving settings: ' + error.message, 'error');
            }
        }

        async function saveTargetSettings() {
            const target_success = document.getElementById('target_success').value;
            const target_return = document.getElementById('target_return').value;
            const target_daily = document.getElementById('target_daily').value;

            try {
                const response = await fetch('database.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save_settings',
                        user: currentUser,
                        settings: {
                            target_success: target_success,
                            target_return: target_return,
                            target_daily: target_daily
                        }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('‚úÖ Target settings berhasil disimpan!', 'success');
                } else {
                    showToast('‚ùå Error: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('‚ùå Error saving settings: ' + error.message, 'error');
            }
        }

        async function saveUserSettings() {
        const user_name = document.getElementById('user_name').value.trim();
        const device_name = document.getElementById('device_name').value.trim();
        const check_interval = document.getElementById('check_interval').value;

        if (!user_name) {
        showToast('‚ùå Nama user wajib diisi!', 'error');
        return;
        }

        try {
        currentUser = user_name;
        currentDevice = device_name || 'Unknown Device';

        localStorage.setItem('v12_user', currentUser);
        localStorage.setItem('v12_device', currentDevice);

        // ===== UPDATE AUTO CHECK SETTINGS =====
        const newInterval = parseInt(check_interval) || 0;

        if (newInterval !== autoCheckInterval) {
            autoCheckInterval = newInterval;
            
            // Restart auto check dengan interval baru
            stopAutoCheck();
            if (autoCheckInterval > 0) {
                startAutoCheck();
            }
        }

        const response = await fetch('database.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'save_settings',
                user: currentUser,
                settings: {
                    check_interval: check_interval
                }
            })
        });

        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ User settings berhasil disimpan!', 'success');
        } else {
            showToast('‚ùå Error: ' + result.message, 'error');
        }
        } catch (error) {
        showToast('‚ùå Error saving settings: ' + error.message, 'error');
        }
        }

        // ===== UTILITY FUNCTIONS =====
        function formatDateIndo(date) {
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                           'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const dateNum = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            
            return dateNum + ' ' + month + ' ' + year;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function showToast(message, type) {
            type = type || 'info';
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.innerHTML = '<div style="display: flex; justify-content: space-between; align-items: flex-start;"><div style="white-space: pre-line; flex: 1;">' + message + '<\/div><button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; margin-left: 1rem; padding: 0.25rem; border-radius: 4px;" onmouseover="this.style.background=\'var(--bg-primary)\'" onmouseout="this.style.background=\'none\'">‚úï<\/button><\/div>';
            
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // ===== AUTO-SAVE FUNCTIONALITY =====
        let autoSaveTimeout;
        function triggerAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                try {
                    localStorage.setItem('v12_backup_data', JSON.stringify({
                        trackingData: trackingData,
                        timestamp: new Date().toISOString()
                    }));
                } catch (error) {
                    console.warn('Could not save backup data:', error);
                }
            }, 5000);
        }

        // ===== RESTORE FROM BACKUP =====
        function checkBackupData() {
            try {
                const backup = localStorage.getItem('v12_backup_data');
                if (backup) {
                    const data = JSON.parse(backup);
                    if (data.timestamp && trackingData.resiData.length === 0) {
                        const backupAge = Date.now() - new Date(data.timestamp).getTime();
                        if (backupAge < 24 * 60 * 60 * 1000) {
                            if (confirm('Ditemukan backup data dari session sebelumnya. Restore data?')) {
                                trackingData = data.trackingData;
                                updateTrackingCounts();
                                updateTrackingTables();
                                updateInventoryStats();
                                updateDashboardStats();
                                showToast('‚úÖ Data berhasil di-restore dari backup', 'success');
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('Could not restore backup data:', error);
            }
        }

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', function(e) {
            // ESC to close modals
            if (e.key === 'Escape') {
                closeBulkImport();
                closeDetailModal();
            }
            
            // Ctrl/Cmd + K for search focus
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const activeSection = document.querySelector('.section.active');
                if (activeSection && activeSection.id === 'scan') {
                    const scanInput = document.getElementById('scanInput');
                    if (scanInput) scanInput.focus();
                } else if (activeSection && activeSection.id === 'tracking') {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) searchInput.focus();
                } else if (activeSection && activeSection.id === 'inventory') {
                    const inventorySearch = document.getElementById('inventorySearch');
                    if (inventorySearch) inventorySearch.focus();
                }
            }

            // Ctrl/Cmd + Enter for bulk import
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const bulkModal = document.getElementById('bulkImportModal');
                if (bulkModal.style.display === 'flex') {
                    e.preventDefault();
                    processBulkImport();
                }
            }

            // Alt + 1,2,3,4,5 for quick navigation
            if (e.altKey && e.key >= '1' && e.key <= '5') {
                e.preventDefault();
                const sections = ['scan', 'tracking', 'dashboard', 'inventory', 'settings'];
                const index = parseInt(e.key) - 1;
                if (sections[index]) {
                    switchSection(sections[index]);
                }
            }
        });

        // ===== ERROR HANDLING & LOGGING =====
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showToast('‚ùå Terjadi error! Silakan refresh halaman jika masalah berlanjut.', 'error');
        });

        // ===== NETWORK STATUS DETECTION =====
        window.addEventListener('online', function() {
            showToast('üåê Koneksi internet tersambung kembali', 'success');
        });

        window.addEventListener('offline', function() {
            showToast('‚ö†Ô∏è Koneksi internet terputus. Beberapa fitur mungkin tidak bekerja.', 'error');
        });

        console.log('üöÄ V12 Panel Modern - Clean & Functional loaded successfully!');

        // Tambah function ini di bagian JavaScript
        
        
        
        
       // ===== CUSTOMER MANAGEMENT FUNCTIONS =====

// 1. Load customers data dengan stats
async function loadCustomersData() {
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_customers_with_stats',
                user: currentUser
            })
        });
        
        const result = await response.json();
        if (result.success) {
            updateCustomersTable(result.customers || []);
            updateCustomerBadgeCount(result.customers.length);
        }
    } catch (error) {
        console.error('Error loading customers:', error);
        showToast('‚ùå Error loading customers', 'error');
    }
}

// 2. Update customers table
function updateCustomersTable(customers) {
    const tbody = document.getElementById('customersTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted); padding: 2rem;">Belum ada customer. Otomatis ter-create dari orders.</td></tr>';
        return;
    }
    
    customers.forEach((customer) => {
        const row = document.createElement('tr');
        
        // Format last order date
        const lastOrderDate = customer.last_order_date ? 
            new Date(customer.last_order_date).toLocaleDateString('id-ID') : 
            'Belum ada order';
        
        // Platform badge
        const platformBadge = customer.platform_preference === 'tiktok' ? 
            '<span class="status-badge" style="background: #ff0050; color: white;">TikTok</span>' :
            customer.platform_preference === 'shopee' ?
            '<span class="status-badge" style="background: #ee4d2d; color: white;">Shopee</span>' :
            '<span class="status-badge" style="background: var(--blue); color: white;">Both</span>';
        
        // Customer segment
        const segmentColor = customer.customer_segment === 'vip' ? 'var(--green)' :
                           customer.customer_segment === 'regular' ? 'var(--blue)' : 'var(--orange)';
        
        row.innerHTML = `
            <td style="font-weight: 600;">${customer.nama}</td>
            <td style="font-family: monospace;">${customer.telepon}</td>
            <td>${platformBadge}</td>
            <td style="text-align: center; font-weight: 600;">${customer.total_orders}</td>
            <td style="color: var(--green); font-weight: 600;">Rp ${formatNumber(customer.total_spent)}</td>
            <td><span style="color: ${segmentColor}; font-weight: 600; text-transform: uppercase;">${customer.customer_segment}</span></td>
            <td style="font-size: 0.8rem;">${lastOrderDate}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-sm btn-secondary" onclick="showCustomerDetail(${customer.id})" title="Detail">
                        üëÅÔ∏è
                    </button>
                    <button class="btn btn-sm btn-info" onclick="sendManualWA('${customer.telepon}', '${customer.nama}')" title="Send WA">
                        üì±
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="editCustomer(${customer.id})" title="Edit">
                        ‚úèÔ∏è
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// 3. Show customer detail modal
async function showCustomerDetail(customerId) {
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'get_customer_detail',
                customer_id: customerId,
                user: currentUser
            })
        });
        
        const result = await response.json();
        if (result.success) {
            showCustomerDetailModal(result.customer, result.orders || []);
        }
    } catch (error) {
        showToast('‚ùå Error loading customer detail', 'error');
    }
}

// 4. Customer detail modal
function showCustomerDetailModal(customer, orders) {
    const modal = document.getElementById('customerDetailModal') || createCustomerDetailModal();
    
    const ordersHtml = orders.map(order => `
        <div style="background: var(--bg-primary); padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid var(--blue);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>${order.nama_produk}</strong> (${order.qty}x)
                    <br><small style="color: var(--text-secondary);">${new Date(order.tanggal).toLocaleDateString('id-ID')}</small>
                </div>
                <div style="text-align: right;">
                    <div style="color: var(--green); font-weight: 600;">Rp ${formatNumber(order.harga_jual)}</div>
                    <small style="color: var(--text-secondary);">${order.status}</small>
                </div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('customerDetailContent').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div>
                <strong>Nama:</strong> ${customer.nama}<br>
                <strong>Telepon:</strong> ${customer.telepon}<br>
                <strong>Platform:</strong> ${customer.platform_preference}
            </div>
            <div>
                <strong>Total Orders:</strong> ${customer.total_orders}<br>
                <strong>Total Spent:</strong> Rp ${formatNumber(customer.total_spent)}<br>
                <strong>Customer Segment:</strong> ${customer.customer_segment}
            </div>
        </div>
        
        <h4 style="color: var(--blue); margin-bottom: 1rem;">üì¶ Order History</h4>
        <div style="max-height: 300px; overflow-y: auto;">
            ${ordersHtml || '<p style="text-align: center; color: var(--text-muted);">Belum ada orders</p>'}
        </div>
    `;
    
    modal.style.display = 'flex';
}

// 5. Create customer detail modal (if not exists)
function createCustomerDetailModal() {
    const modal = document.createElement('div');
    modal.id = 'customerDetailModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üë• Customer Detail</h3>
                <button class="close-btn" onclick="closeCustomerDetailModal()">√ó</button>
            </div>
            <div id="customerDetailContent"></div>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
}

function closeCustomerDetailModal() {
    const modal = document.getElementById('customerDetailModal');
    if (modal) modal.style.display = 'none';
}

// 6. Send manual WhatsApp
async function sendManualWA(phone, nama) {
    const message = prompt(`Kirim WA ke ${nama} (${phone}):`, `Halo ${nama}, terima kasih sudah berbelanja di CHEMZ SHOP! üòä`);
    
    if (!message) return;
    
    try {
        showToast('üì± Sending WhatsApp...', 'info');
        
        const response = await fetch('https://api.fonnte.com/send', {
            method: 'POST',
            headers: { 'Authorization': apiKeys.fonnte },
            body: new URLSearchParams({
                target: phone,
                message: message,
                countryCode: '62'
            })
        });
        
        if (response.ok) {
            showToast('‚úÖ WhatsApp berhasil dikirim!', 'success');
            
            // Log ke database
            await fetch('database.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'save_wa_log',
                    phone: phone,
                    message: message,
                    type: 'manual',
                    user: currentUser
                })
            });
        } else {
            showToast('‚ùå Gagal kirim WhatsApp', 'error');
        }
    } catch (error) {
        showToast('‚ùå Error: ' + error.message, 'error');
    }
}

// 7. Update customer badge count
function updateCustomerBadgeCount(count) {
    const badge = document.getElementById('customerEngagementCount');
    if (badge) badge.textContent = count;
}

// 8. Customer search functionality
function setupCustomerSearch() {
    const searchInput = document.getElementById('customerSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            filterCustomersTable(e.target.value);
        });
    }
}

function filterCustomersTable(searchTerm) {
    const tbody = document.getElementById('customersTableBody');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    const term = searchTerm.toLowerCase();
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(term) || term === '') {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// 9. Initialize customer management
function initializeCustomerManagement() {
    loadCustomersData();
    setupCustomerSearch();
    
    // Setup refresh setiap 30 detik
    setInterval(() => {
        if (document.querySelector('.section.active').id === 'customer-engagement') {
            loadCustomersData();
        }
    }, 30000);
} 
        
        
        
        // ===== ORDER TRACKING SYNC FUNCTIONS =====
async function syncOrderTrackingStatus() {
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'sync_order_tracking',
                user: currentUser
            })
        });
        
        const result = await response.json();
        if (result.success) {
            console.log('‚úÖ Order tracking status synced:', result.updated);
            return result.updated;
        } else {
            console.error('‚ùå Sync failed:', result.message);
        }
    } catch (error) {
        console.error('‚ùå Sync error:', error);
    }
    return null;
}

async function updateOrderStatusByResi(resi, trackingStatus) {
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'update_order_by_resi',
                resi: resi,
                tracking_status: trackingStatus,
                user: currentUser
            })
        });
        
        const result = await response.json();
        if (result.success) {
            console.log(`‚úÖ Order status updated: ${resi} ‚Üí ${result.order_status}`);
        }
    } catch (error) {
        console.error('‚ùå Error updating order status:', error);
    }
}
        
        
        
     // ===== DYNAMIC PRODUCT FUNCTIONS =====
let productRowCounter = 0;

function addProductRow() {
    productRowCounter++;
    const container = document.getElementById('productsContainer');
    
    const productRow = document.createElement('div');
    productRow.className = 'product-row';
    productRow.id = `productRow${productRowCounter}`;
    productRow.style.cssText = `
        display: grid; 
        grid-template-columns: 2fr 1fr 1fr auto; 
        gap: 1rem; 
        align-items: end; 
        padding: 1rem; 
        background: var(--bg-primary); 
        border-radius: 8px; 
        margin-bottom: 1rem; 
        border: 1px solid var(--border);
    `;
    
    productRow.innerHTML = `
        <div class="form-group">
            <label class="form-label">Produk *</label>
            <select class="form-input product-select" id="product${productRowCounter}" onchange="calculateTotalProfit()">
                <option value="">Pilih Produk</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Qty *</label>
            <input type="number" class="form-input qty-input" id="qty${productRowCounter}" placeholder="1" min="1" onchange="calculateTotalProfit()">
        </div>
        <div class="form-group">
            <label class="form-label">Harga Jual *</label>
            <input type="number" class="form-input price-input" id="price${productRowCounter}" placeholder="0" min="0" onchange="calculateTotalProfit()">
        </div>
        <div class="form-group">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeProductRow(${productRowCounter})" title="Hapus Produk">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                </svg>
            </button>
        </div>
    `;
    
    container.appendChild(productRow);
    
    // Load products ke dropdown yang baru
    loadProductsToNewDropdown(`product${productRowCounter}`);
    
    // Auto focus ke dropdown produk
    document.getElementById(`product${productRowCounter}`).focus();
}

function removeProductRow(rowId) {
    const row = document.getElementById(`productRow${rowId}`);
    if (row) {
        row.remove();
        calculateTotalProfit();
    }
}

function loadProductsToNewDropdown(selectId) {
    const dropdown = document.getElementById(selectId);
    if (!dropdown) return;
    
    dropdown.innerHTML = '<option value="">Pilih Produk</option>';
    
    if (trackingData.productsData) {
        trackingData.productsData.forEach(product => {
            dropdown.innerHTML += `<option value="${product.sku}" data-hpp="${product.harga}" data-name="${product.nama_barang}">${product.sku} - ${product.nama_barang}</option>`;
        });
    }
}   
        
        
        function calculateTotalProfit() {
    const productRows = document.querySelectorAll('.product-row');
    let totalItems = 0;
    let totalHPP = 0;
    let totalHargaJual = 0;
    let totalProfit = 0;
    
    productRows.forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const qtyInput = row.querySelector('.qty-input');
        const priceInput = row.querySelector('.price-input');
        
        if (productSelect.value && qtyInput.value && priceInput.value) {
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const hpp = parseFloat(selectedOption.dataset.hpp) || 0;
            const qty = parseInt(qtyInput.value) || 0;
            const hargaJual = parseFloat(priceInput.value) || 0;
            
            const itemHPP = hpp * qty;
            const itemProfit = hargaJual - itemHPP;
            
            totalItems += qty;
            totalHPP += itemHPP;
            totalHargaJual += hargaJual;
            totalProfit += itemProfit;
        }
    });
    
    const avgMargin = totalHargaJual > 0 ? ((totalProfit / totalHargaJual) * 100) : 0;
    
    document.getElementById('totalCalculation').innerHTML = `
        Total Items: ${totalItems} | 
        Total HPP: Rp ${formatNumber(totalHPP)} | 
        Total Harga Jual: Rp ${formatNumber(totalHargaJual)} | 
        Total Profit: Rp ${formatNumber(totalProfit)} | 
        Avg Margin: ${avgMargin.toFixed(1)}%
    `;
}


// ===== SAVE MULTIPLE ORDER FUNCTION =====
// ===== SAVE MULTIPLE ORDER FUNCTION ===== 
async function saveMultipleOrder() {
    // 1. VALIDATION - Customer Info
    const customerNama = document.getElementById('customerNama').value.trim();
    const customerHP = document.getElementById('customerHP').value.trim();
    const customerAlamat = document.getElementById('customerAlamat').value.trim();
    const platform = document.getElementById('orderPlatform').value;
    const tanggal = document.getElementById('orderTanggal').value;
    const resi = document.getElementById('orderResi').value.trim();
    
    if (!customerNama || !customerHP || !platform) {
        showToast('‚ùå Nama customer, HP, dan platform wajib diisi!', 'error');
        return;
    }
    
    // 2. VALIDATION - Products
    const productRows = document.querySelectorAll('.product-row');
    if (productRows.length === 0) {
        showToast('‚ùå Minimal tambah 1 produk!', 'error');
        return;
    }
    
    // Collect & validate all products
    const products = [];
    let hasError = false;
    
    productRows.forEach((row, index) => {
        const productSelect = row.querySelector('.product-select');
        const qtyInput = row.querySelector('.qty-input');
        const priceInput = row.querySelector('.price-input');
        
        const productSku = productSelect.value;
        const qty = parseInt(qtyInput.value) || 0;
        const hargaJual = parseFloat(priceInput.value) || 0;
        
        if (!productSku || qty <= 0 || hargaJual <= 0) {
            showToast(`‚ùå Produk #${index + 1}: Lengkapi semua field!`, 'error');
            hasError = true;
            return;
        }
        
        // Get product data
        const selectedOption = productSelect.options[productSelect.selectedIndex];
        const hpp = parseFloat(selectedOption.dataset.hpp) || 0;
        const namaBarang = selectedOption.dataset.name || '';
        
        products.push({
            sku: productSku,
            nama: namaBarang,
            qty: qty,
            hargaJual: hargaJual,
            hpp: hpp
        });
    });
    
    if (hasError) return;
    
    showToast('üîÑ Menyimpan customer & orders + updating stock...', 'info');
    
    try {
        // 3. ‚úÖ PANGGIL DATABASE ACTION YANG UDAH ADA
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'save_order_with_movements', // ‚Üê INI YANG PENTING!
                customer_nama: customerNama,
                customer_hp: customerHP,
                customer_alamat: customerAlamat,
                platform: platform,
                tanggal: tanggal || new Date().toISOString().slice(0, 10),
                products: products, // Array semua produk
                user: currentUser,
                device: currentDevice
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(`‚úÖ Berhasil! Customer: ${customerNama} | Orders: ${result.orders_count} | Stock Movements: ${result.movements_count}`, 'success');
            closeOrderForm();
            
            // Refresh semua data
            loadOrdersData(); // Refresh orders table
            loadTrackingData(); // Refresh inventory data
        } else {
            showToast('‚ùå Error: ' + result.message, 'error');
        }
        
    } catch (error) {
        showToast('‚ùå Error: ' + error.message, 'error');
        console.error('Save multiple order error:', error);
    }
}
        
        
        
        
        
        // ===== ORDER MANAGEMENT FUNCTIONS =====
// ===== UPDATE EXISTING FUNCTIONS =====
function toggleOrderForm() {
    const formCard = document.getElementById('orderFormCard');
    const toggleBtn = document.getElementById('toggleOrderBtn');
    
    if (formCard.style.display === 'none' || !formCard.style.display) {
        formCard.style.display = 'block';
        toggleBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19,13H5V11H19V13Z"/>
            </svg>
            Tutup Form
        `;
        
        // Set default date & add first product row
        document.getElementById('orderTanggal').value = new Date().toISOString().slice(0,10);
        
        // Clear existing products & add first row
        document.getElementById('productsContainer').innerHTML = '';
        productRowCounter = 0;
        addProductRow();
        
    } else {
        closeOrderForm();
    }
}

function closeOrderForm() {
    const formCard = document.getElementById('orderFormCard');
    const toggleBtn = document.getElementById('toggleOrderBtn');
    
    formCard.style.display = 'none';
    toggleBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
        </svg>
        Tambah Order Baru
    `;
    
    // Clear all form data
    clearOrderForm();
}

function clearOrderForm() {
    // Clear customer fields
    document.getElementById('customerNama').value = '';
    document.getElementById('customerHP').value = '';
    document.getElementById('customerAlamat').value = '';
    document.getElementById('orderPlatform').value = '';
    document.getElementById('orderResi').value = '';
    
    // Clear products container
    document.getElementById('productsContainer').innerHTML = '';
    productRowCounter = 0;
    
    // Reset total calculation
    document.getElementById('totalCalculation').innerHTML = 'Total Items: 0 | Total HPP: Rp 0 | Total Harga Jual: Rp 0 | Total Profit: Rp 0 | Avg Margin: 0%';
}


async function loadCustomersToDropdown() {
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_customers',
                user: currentUser
            })
        });

        const result = await response.json();
        const dropdown = document.getElementById('orderCustomer');
        
        dropdown.innerHTML = '<option value="">Pilih Customer</option>';
        
        if (result.success && result.customers) {
            result.customers.forEach(customer => {
                dropdown.innerHTML += `<option value="${customer.id}" data-name="${customer.nama}" data-phone="${customer.telepon}">${customer.nama} - ${customer.telepon}</option>`;
            });
        }
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

async function loadProductsToDropdown() {
    const dropdown = document.getElementById('orderProduct');
    dropdown.innerHTML = '<option value="">Pilih Produk</option>';
    
    if (trackingData.productsData) {
        trackingData.productsData.forEach(product => {
            dropdown.innerHTML += `<option value="${product.sku}" data-hpp="${product.harga}" data-name="${product.nama_barang}">${product.sku} - ${product.nama_barang}</option>`;
        });
    }
}


function calculateOrderProfit() {
    const productDropdown = document.getElementById('orderProduct');
    const qty = parseInt(document.getElementById('orderQty').value) || 0;
    const hargaJual = parseFloat(document.getElementById('orderHargaJual').value) || 0;
    
    let hpp = 0;
    if (productDropdown.value) {
        const selectedOption = productDropdown.options[productDropdown.selectedIndex];
        hpp = parseFloat(selectedOption.dataset.hpp) || 0;
    }
    
    const totalHPP = hpp * qty;
    const profit = hargaJual - totalHPP;
    const margin = hargaJual > 0 ? ((profit / hargaJual) * 100) : 0;
    
    document.getElementById('profitCalculation').innerHTML = `
        HPP: Rp ${formatNumber(hpp)} | 
        Total: Rp ${formatNumber(totalHPP)} | 
        Profit: Rp ${formatNumber(profit)} | 
        Margin: ${margin.toFixed(1)}%
    `;
}

async function saveOrder() {
    // Get form data
    const platform = document.getElementById('orderPlatform').value;
    const customerId = document.getElementById('orderCustomer').value;
    const productSku = document.getElementById('orderProduct').value;
    const qty = parseInt(document.getElementById('orderQty').value) || 0;
    const hargaJual = parseFloat(document.getElementById('orderHargaJual').value) || 0;
    const tanggal = document.getElementById('orderTanggal').value;
    const resi = document.getElementById('orderResi').value.trim();
    
    // Validation
    if (!platform || !customerId || !productSku || qty <= 0 || hargaJual <= 0) {
        showToast('‚ùå Lengkapi semua field yang required!', 'error');
        return;
    }
    
    // Get HPP for calculation
    const productDropdown = document.getElementById('orderProduct');
    const selectedOption = productDropdown.options[productDropdown.selectedIndex];
    const hpp = parseFloat(selectedOption.dataset.hpp) || 0;
    
    const totalHPP = hpp * qty;
    const profit = hargaJual - totalHPP;
    const margin = hargaJual > 0 ? ((profit / hargaJual) * 100) : 0;
    
    showToast('üîÑ Menyimpan order...', 'info');
    
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'save_order',
                platform: platform,
                customer_id: customerId,
                product_sku: productSku,
                qty: qty,
                harga_jual: hargaJual,
                hpp: hpp,
                profit: profit,
                margin: margin,
                no_resi: resi,
                order_date: tanggal,
                status: 'Pending',
                user: currentUser,
                device: currentDevice
            })
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ Order berhasil disimpan!', 'success');
            closeOrderForm();
            loadOrdersData(); // Refresh table
        } else {
            showToast('‚ùå Error: ' + result.message, 'error');
        }
    } catch (error) {
        showToast('‚ùå Error: ' + error.message, 'error');
    }
}


async function loadOrdersData() {
    try {
        // ‚úÖ TAMBAH INI - Sync dulu sebelum load
        await syncOrderTrackingStatus();
        
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_orders',
                user: currentUser
            })
        });

        const result = await response.json();
        if (result.success) {
            updateOrdersTable(result.orders || []);
        }
    } catch (error) {
        console.error('Error loading orders:', error);
        showToast('‚ùå Error loading orders', 'error');
    }
}

function updateOrdersTable(orders) {
    const tbody = document.getElementById('ordersTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: var(--text-muted); padding: 2rem;">Belum ada orders. Klik "Tambah Order Baru" untuk memulai.</td></tr>';
        return;
    }
    
    orders.forEach((order, index) => {
        const row = document.createElement('tr');
        
        // Format tanggal
        const orderDate = new Date(order.order_date).toLocaleDateString('id-ID');
        
        // Platform badge
        const platformBadge = order.platform === 'tiktok' ? 
            '<span class="status-badge" style="background: #ff0050; color: white;">TikTok</span>' :
            '<span class="status-badge" style="background: #ee4d2d; color: white;">Shopee</span>';
        
        // Status badge
        const statusClass = order.status === 'Completed' ? 'status-delivered' : 
                           order.status === 'Cancelled' ? 'status-return' : 'status-pending';
        
        row.innerHTML = `
    <td>${orderDate}</td>
    <td>${platformBadge}</td>
    <td>${order.customer_name || 'N/A'}</td>
    <td title="${order.product_name || 'N/A'}">${order.product_sku}</td>
    <td>${order.qty}</td>
    <td>Rp ${formatNumber(parseFloat(order.harga_jual))}</td>
    <td style="color: ${parseFloat(order.profit) >= 0 ? 'var(--green)' : 'var(--red)'}; font-weight: 600;">
        Rp ${formatNumber(parseFloat(order.profit))}
    </td>
    <td style="font-weight: 600;">${parseFloat(order.margin).toFixed(1)}%</td>
    <td style="font-family: monospace; font-size: 0.8rem;">${order.no_resi || '-'}</td>
    <td><span class="status-badge ${statusClass}">${order.status}</span></td>
    <td>
        <div class="action-buttons">
            <button class="btn btn-sm btn-secondary" onclick="editOrder(${order.id})" title="Edit">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
                </svg>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteOrder(${order.id})" title="Hapus">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                </svg>
            </button>
        </div>
    </td>
`;
        tbody.appendChild(row);
    });
}  
        
        // Search functionality
document.addEventListener('DOMContentLoaded', function() {
    // Order search
    const orderSearch = document.getElementById('orderSearch');
    if (orderSearch) {
        orderSearch.addEventListener('input', function(e) {
            filterOrdersTable(e.target.value);
        });
    }
});

function filterOrdersTable(searchTerm) {
    const tbody = document.getElementById('ordersTableBody');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    const term = searchTerm.toLowerCase();
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(term) || term === '') {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function editOrder(orderId) {
    // TODO: Implement edit functionality
    showToast('üîß Edit order feature coming soon!', 'info');
}

async function deleteOrder(orderId) {
    if (!confirm('Yakin hapus order ini?\n\nData akan dihapus permanen!')) return;
    
    showToast('üóëÔ∏è Menghapus order...', 'info');
    
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'delete_order',
                id: orderId,
                user: currentUser,
                device: currentDevice
            })
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ Order berhasil dihapus!', 'success');
            loadOrdersData(); // Refresh table
        } else {
            showToast('‚ùå Error: ' + result.message, 'error');
        }
    } catch (error) {
        showToast('‚ùå Error: ' + error.message, 'error');
    }
}

        
        
        // ===== CUSTOMER ENGAGEMENT FUNCTIONS =====
function loadCustomerEngagementData() {
    console.log('üë• Loading Customer Engagement data...');
    
    // Load orders data
    loadOrdersData();
    
    // Load customers data for dropdown
    loadCustomersToDropdown();
    
    // Load products data for dropdown  
    loadProductsToDropdown();
    
    // Update dashboard stats
    updateCustomerEngagementCounts();
}


// ===== ORDER TRACKING SYNC FUNCTIONS =====
async function syncOrderTrackingStatus() {
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'sync_order_tracking',
                user: currentUser
            })
        });
        
        const result = await response.json();
        if (result.success) {
            console.log('‚úÖ Order tracking status synced:', result.updated);
            return result.updated;
        } else {
            console.error('‚ùå Sync failed:', result.message);
        }
    } catch (error) {
        console.error('‚ùå Sync error:', error);
    }
    return null;
}

async function updateOrderStatusByResi(resi, trackingStatus) {
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'update_order_by_resi',
                resi: resi,
                tracking_status: trackingStatus,
                user: currentUser
            })
        });
        
        const result = await response.json();
        if (result.success) {
            console.log(`‚úÖ Order status updated: ${resi} ‚Üí ${result.order_status}`);
        }
    } catch (error) {
        console.error('‚ùå Error updating order status:', error);
    }
}

function updateCustomerEngagementCounts() {
    // TODO: Calculate real stats from orders data
    const badge = document.getElementById('customerEngagementCount');
    if (badge) badge.textContent = '0';
}

function updateCustomerEngagementCounts() {
    // TODO: Update badge counts
    const badge = document.getElementById('customerEngagementCount');
    if (badge) badge.textContent = '0';
}
        
        
        async function sendTestReport() {
        const groupId = document.getElementById('reportGroupId').value.trim();
        const adminWA = document.getElementById('reportAdminWA').value.trim();

        if (!groupId && !adminWA) {
        showToast('‚ùå Isi target pengiriman dulu!', 'error');
        return;
        }

        showToast('üì± Sending test report...', 'info');

        const reportMessage = document.getElementById('reportPreviewContainer').textContent;
        const targets = [];

        if (groupId) targets.push(groupId);
        if (adminWA) targets.push(adminWA);

        try {
        for (const target of targets) {
            const response = await fetch('https://api.fonnte.com/send', {
                method: 'POST',
                headers: {
                    'Authorization': apiKeys.fonnte || 'YOUR_FONNTE_TOKEN'
                },
                body: new URLSearchParams({
                    target: target,
                    message: reportMessage,
                    countryCode: '62'
                })
            });
            
            const result = await response.json();
            console.log('Fonnte response:', result);
        }

        showToast('‚úÖ Test report sent!', 'success');

        // Save to history
        await saveReportHistory('test_report', targets.join(', '), reportMessage);

        } catch (error) {
        showToast('‚ùå Failed to send: ' + error.message, 'error');
        }
        }

       // ===== HELPER FUNCTION SAVE HISTORY =====
async function saveReportHistory(reportType, sentTo, messagePreview, status = 'sent') {
    try {
        await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'save_report_history',
                report_type: reportType,
                sent_to: sentTo,
                message_preview: messagePreview.substring(0, 200),
                status: status,
                user: currentUser,
                device: currentDevice
            })
        });
    } catch (error) {
        console.error('Failed to save report history:', error);
    }
}

// ===== AUTO REPORT HISTORY FUNCTIONS =====
async function loadAutoReportHistory() {
    console.log('üîÑ Loading auto report history...');
    const tbody = document.getElementById('autoReportHistoryBody');
    if (!tbody) return;
    
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">üîÑ Loading...</td></tr>';
    
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_report_history',
                user: currentUser
            })
        });
        
        const result = await response.json();
        if (result.success) {
            updateAutoReportHistoryTable(result.history || []);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function updateAutoReportHistoryTable(history) {
    const tbody = document.getElementById('autoReportHistoryBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">Belum ada riwayat auto reports</td></tr>';
        return;
    }
    
    history.forEach((item, index) => {
        const row = document.createElement('tr');
        const sentDate = new Date(item.sent_at).toLocaleDateString('id-ID');
        const sentTime = new Date(item.sent_at).toLocaleTimeString('id-ID');
        
        row.innerHTML = `
            <td>${sentDate}</td>
            <td>${sentTime}</td>
            <td>${item.sent_to}</td>
            <td>${item.report_type}</td>
            <td><span class="status-badge status-delivered">${item.status}</span></td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${item.message_preview}</td>
            <td>
                <button class="btn btn-sm btn-secondary" onclick="showReportPreview('${item.message_preview}')" title="Preview">
                    üëÅÔ∏è
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function showReportPreview(message) {
    console.log('üìã Preview clicked, message length:', message.length);
    
    // Simple alert dengan format yang lebih baik
    const shortMessage = message.length > 300 ? 
        message.substring(0, 300) + '\n\n...(sisanya dipotong)' : 
        message;
    
    alert(`üìã PREVIEW LAPORAN:\n\n${shortMessage}`);
}


        // ===== AUTO SCHEDULER =====
        let autoReportTimer = null;

        function startAutoReportScheduler() {
        if (autoReportTimer) clearInterval(autoReportTimer);

        autoReportTimer = setInterval(async () => {
        await checkScheduledReports();
        }, 60000); // Cek setiap 1 menit

        console.log('üìÖ Auto report scheduler started');
        }

async function checkScheduledReports() {
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_auto_report_settings',
                user: currentUser
            })
        });

        const result = await response.json();
        if (!result.success || !result.settings || !result.settings.enabled) return;

        const now = new Date();
        const currentTime = now.toTimeString().slice(0, 5);
        const scheduleTime = result.settings.schedule_time.slice(0, 5);

        console.log('üïê Time check:', currentTime, 'vs', scheduleTime);

        if (currentTime === scheduleTime) {
            const today = now.toISOString().slice(0, 10);
            
            console.log('‚è∞ Time match! Checking database if already sent today...');
            
            // ‚úÖ CEK DARI DATABASE - NO MORE LOCALSTORAGE
            const checkResponse = await fetch('database.php', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'check_report_sent_today',
                    user: currentUser,
                    date: today
                })
            });
            
            const checkResult = await checkResponse.json();
            console.log('üìä Database check result:', checkResult);
            
            if (checkResult.success && !checkResult.already_sent) {
                console.log('üì§ Sending automatic report...');
                await sendAutomaticReport(result.settings);
                console.log('üìä Automatic report sent at', currentTime);
            } else {
                console.log('‚úÖ Report already sent today from database. Count:', checkResult.count);
            }
        }
    } catch (error) {
        console.error('Auto scheduler error:', error);
    }
}

        async function sendAutomaticReport(settings) {
    console.log('üì§ Starting automatic report send...');
    
    generatePreviewReport();
    const reportMessage = document.getElementById('reportPreviewContainer').textContent;
    const targets = [];
    
    if (settings.target_group) targets.push(settings.target_group);
    if (settings.target_admin) targets.push(settings.target_admin);

    if (targets.length === 0) {
        console.error('‚ùå No targets for automatic report');
        return;
    }

    let successCount = 0;
    let failCount = 0;
    
    console.log(`üì± Sending to ${targets.length} targets:`, targets);
    
    for (const target of targets) {
        try {
            console.log(`üìû Sending to: ${target}`);
            
            const response = await fetch('https://api.fonnte.com/send', {
                method: 'POST',
                headers: { 'Authorization': apiKeys.fonnte },
                body: new URLSearchParams({
                    target: target,
                    message: reportMessage,
                    countryCode: '62'
                })
            });
            
            if (response.ok) {
                successCount++;
                console.log(`‚úÖ Successfully sent to ${target}`);
            } else {
                failCount++;
                console.log(`‚ùå Failed to send to ${target}`);
            }
            
        } catch (error) {
            console.error('Send error:', error);
            failCount++;
        }
    }
    
    console.log(`üìä Send completed: ${successCount} success, ${failCount} failed`);
    
    // ===== SAVE HISTORY KE DATABASE =====
    const status = failCount === 0 ? 'sent' : (successCount === 0 ? 'failed' : 'partial');
    
    try {
        await saveReportHistory('auto_daily', targets.join(', '), reportMessage, status);
        console.log('üíæ Report history saved to database');
    } catch (error) {
        console.error('‚ùå Failed to save report history:', error);
    }
    
    // Refresh history table
    try {
        await loadAutoReportHistory();
        console.log('üîÑ History table refreshed');
    } catch (error) {
        console.error('‚ùå Failed to refresh history:', error);
    }
}
// ===== AUTO REPORTS FUNCTIONS =====
async function loadAutoReportsData() {
    console.log('üìä Loading auto reports data...');
    await loadAutoReportSettings();
    await loadAutoReportHistory();  // ‚Üê TAMBAH LINE INI BRO!
    
    // ===== UPDATE BADGE SETELAH LOAD =====
    updateAutoReportsStatus();
}

async function saveAutoReportSettings() {
    const groupId = document.getElementById('reportGroupId').value.trim();
    const adminWA = document.getElementById('reportAdminWA').value.trim();
    const scheduleTime = document.getElementById('reportTime').value;

    console.log('Debug save:', { groupId, adminWA, scheduleTime }); // ‚Üê TAMBAH INI

    if (!groupId && !adminWA) {
        showToast('‚ùå Minimal isi Grup ID atau Admin WA!', 'error');
        return;
    }

    if (!scheduleTime) {
        showToast('‚ùå Waktu kirim wajib diisi!', 'error');
        return;
    }

    showToast('üîÑ Menyimpan settings...', 'info');

    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'save_auto_report_settings',
                schedule_time: scheduleTime,
                target_group: groupId,
                target_admin: adminWA,
                enabled: 1,
                report_types: ['daily_movement', 'top_products', 'dead_stock'],
                user: currentUser,
                device: currentDevice
            })
        });

        const result = await response.json();
        console.log('Save result:', result); // ‚Üê TAMBAH INI

        if (result.success) {
            showToast('‚úÖ Auto report settings berhasil disimpan!', 'success');
            updateAutoReportsStatus();
            // JANGAN load ulang settings - biar input tidak reset
        } else {
            showToast('‚ùå Error: ' + result.message, 'error');
        }
    } catch (error) {
        showToast('‚ùå Error: ' + error.message, 'error');
    }
}


// ===== AUTO REPORT MODAL FUNCTIONS =====
function openAutoReportModal() {
    document.getElementById('autoReportModal').style.display = 'flex';
    
    // Load existing settings ke modal
    loadAutoReportSettingsToModal();
}

function closeAutoReportModal() {
    document.getElementById('autoReportModal').style.display = 'none';
}

async function loadAutoReportSettingsToModal() {
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_auto_report_settings',
                user: currentUser,
                device: currentDevice
            })
        });

        const result = await response.json();
        if (result.success && result.settings) {
            // Populate form di modal
            document.getElementById('modalReportGroupId').value = result.settings.target_group || '';
            document.getElementById('modalReportAdminWA').value = result.settings.target_admin || '';
            document.getElementById('modalReportTime').value = result.settings.schedule_time || '17:00';
            document.getElementById('enableAutoReports').checked = result.settings.enabled == 1;
        }
    } catch (error) {
        console.error('Error loading settings to modal:', error);
    }
}

async function saveAutoReportModalSettings() {
    const groupId = document.getElementById('modalReportGroupId').value.trim();
    const adminWA = document.getElementById('modalReportAdminWA').value.trim();
    const scheduleTime = document.getElementById('modalReportTime').value;
    const enabled = document.getElementById('enableAutoReports').checked;

    if (!enabled) {
        showToast('‚ùå Enable Auto Reports dulu!', 'error');
        return;
    }

    if (!groupId && !adminWA) {
        showToast('‚ùå Minimal isi Grup ID atau Admin WA!', 'error');
        return;
    }

    if (!scheduleTime) {
        showToast('‚ùå Waktu kirim wajib diisi!', 'error');
        return;
    }

    showToast('üîÑ Menyimpan settings...', 'info');

    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'save_auto_report_settings',
                schedule_time: scheduleTime,
                target_group: groupId,
                target_admin: adminWA,
                enabled: enabled ? 1 : 0,
                report_types: ['daily_movement', 'top_products', 'dead_stock'],
                user: currentUser,
                device: currentDevice
            })
        });

        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ Auto report settings berhasil disimpan!', 'success');
            updateAutoReportsStatus();
            closeAutoReportModal();
        } else {
            showToast('‚ùå Error: ' + result.message, 'error');
        }
    } catch (error) {
        showToast('‚ùå Error: ' + error.message, 'error');
    }
}

async function stopAutoReports() {
    if (!confirm('Yakin mau stop auto reports?')) return;

    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'save_auto_report_settings',
                schedule_time: '17:00',  // ‚Üê TAMBAH INI (dummy value)
                target_group: '',        // ‚Üê TAMBAH INI
                target_admin: '',        // ‚Üê TAMBAH INI  
                enabled: 0,
                report_types: [],
                user: currentUser,
                device: currentDevice
            })
        });

        const result = await response.json();
        if (result.success) {
            showToast('üõë Auto reports berhasil di-stop!', 'success');
            updateAutoReportsStatus();
            closeAutoReportModal();
        } else {
            showToast('‚ùå Error: ' + result.message, 'error');
        }
    } catch (error) {
        showToast('‚ùå Error: ' + error.message, 'error');
    }
}

async function loadAutoReportHistory() {
    try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_report_history',
                user: currentUser
            })
        });
        
        const result = await response.json();
        if (result.success) {
            updateAutoReportHistoryTable(result.history || []); // ‚Üê TAMBAH LINE INI!
        }
    } catch (error) {
        console.error('Error loading auto report history:', error);
    }
}


function updateAutoReportHistoryTable(history) {
    const tbody = document.getElementById('autoReportHistoryBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">Belum ada riwayat auto reports</td></tr>';
        return;
    }
    
    history.forEach((item, index) => {
        const row = document.createElement('tr');
        const sentDate = new Date(item.sent_at).toLocaleDateString('id-ID');
        const sentTime = new Date(item.sent_at).toLocaleTimeString('id-ID');
        
        row.innerHTML = `
            <td>${sentDate}</td>
            <td>${sentTime}</td>
            <td>${item.sent_to}</td>
            <td>${item.report_type}</td>
            <td><span class="status-badge status-delivered">${item.status}</span></td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${item.message_preview}</td>
            <td>
                <button class="btn btn-sm btn-secondary preview-btn" data-index="${index}" title="Preview">
                    üëÅÔ∏è
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // ‚úÖ ADD EVENT LISTENERS SETELAH RENDER (AMAN!)
    tbody.querySelectorAll('.preview-btn').forEach((btn, index) => {
        btn.addEventListener('click', function() {
            try {
                const message = history[index].message_preview;
                showReportPreview(message);
            } catch (error) {
                console.error('Preview error:', error);
                showToast('‚ùå Error membuka preview', 'error');
            }
        });
    });
}


function showReportPreview(message) {
    alert(message); // Simple preview, bisa diganti modal
}




        function generatePreviewReport() {
    try {
        console.log('üîÑ Generating real data report...');
        
        const today = new Date().toISOString().slice(0, 10);
        const todayMovements = trackingData.movementsData ? 
            trackingData.movementsData.filter(m => m.movement_date === today) : [];

        console.log('üìä Today movements found:', todayMovements.length);

        // Calculate real data dengan error handling
        const stockIn = {};
        const stockOut = {};

        todayMovements.forEach(movement => {
            try {
                const qty = parseInt(movement.qty) || 0;
                const sku = movement.sku || 'Unknown';
                
                if (movement.type === 'in') {
                    stockIn[sku] = (stockIn[sku] || 0) + qty;
                } else if (movement.type === 'out') {
                    stockOut[sku] = (stockOut[sku] || 0) + qty;
                }
            } catch (error) {
                console.error('Error processing movement:', movement, error);
            }
        });

        const totalIn = Object.values(stockIn).reduce((sum, qty) => sum + qty, 0);
        const totalOut = Object.values(stockOut).reduce((sum, qty) => sum + qty, 0);

        // Generate stock IN list
        const stockInList = Object.entries(stockIn)
            .map(([sku, qty]) => `‚Ä¢ ${sku} - ${qty} pcs`)
            .join('\n');

        // Generate stock OUT list  
        const stockOutList = Object.entries(stockOut)
            .map(([sku, qty]) => `‚Ä¢ ${sku} - ${qty} pcs`)
            .join('\n');

        // Generate final report
        const preview = `üè™ LAPORAN INVENTORY HARIAN
üìÖ ${new Date().toLocaleDateString('id-ID')} | ${new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})} WIB

üìà STOCK IN HARI INI (${totalIn} pcs):
${stockInList || 'Tidak ada stock masuk'}

üìâ STOCK OUT HARI INI (${totalOut} pcs):
${stockOutList || 'Tidak ada stock keluar'}

üíπ NET MOVEMENT: ${totalIn - totalOut >= 0 ? '+' : ''}${totalIn - totalOut} pcs

---
ü§ñ Real Data - Auto Report V12 Panel`;

        // Update container dengan error handling
        const container = document.getElementById('reportPreviewContainer');
        if (container) {
            container.textContent = preview;
            console.log('‚úÖ Report preview updated successfully');
            console.log('üìÑ Report length:', preview.length, 'characters');
        } else {
            console.error('‚ùå reportPreviewContainer element not found');
            throw new Error('Preview container not found');
        }

        // Show success toast
        if (typeof showToast === 'function') {
            showToast('‚úÖ Real report generated!', 'success');
        }

        return preview;

    } catch (error) {
        console.error('‚ùå generatePreviewReport error:', error);
        
        // Fallback preview jika error
        const fallbackPreview = `üè™ LAPORAN INVENTORY HARIAN
üìÖ ${new Date().toLocaleDateString('id-ID')} | ${new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})} WIB

‚ùå Error generating detailed report
üìä Fallback mode activated

---
ü§ñ Error Recovery - Auto Report V12 Panel`;

        const container = document.getElementById('reportPreviewContainer');
        if (container) {
            container.textContent = fallbackPreview;
        }

        // Show error toast
        if (typeof showToast === 'function') {
            showToast('‚ùå Error generating report, using fallback', 'error');
        }

        return fallbackPreview;
    }
}



        function updateMovementLastUpdatedInfo() {
        const container = document.getElementById('movementLastUpdatedInfo');
        if (!container) return;

        // Copy logic yang sama kayak updateLaporanLastUpdatedInfo()
        if (!trackingData.movementsData || trackingData.movementsData.length === 0) {
        container.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="color: var(--text-muted);">
                    <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                <\/svg>
                <span>Belum ada movement<\/span>
            <\/div>
        `;
        return;
        }

        let latestMovement = trackingData.movementsData[trackingData.movementsData.length - 1];
        const userName = latestMovement.user || latestMovement.created_by || 'System';
        const moveDate = latestMovement.movement_date || 'Unknown';

        container.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="color: var(--blue);">
                <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
            <\/svg>
            <span>Last Update: <strong>${userName}<\/strong> - ${moveDate}<\/span>
        <\/div>
        `;
        }


        // ===== HELPER FUNCTION UNTUK FORMAT TANGGAL =====
        function formatDateTimeIndo(dateString) {
        if (!dateString) return 'Tidak diketahui';

        try {
        const date = new Date(dateString);
        const options = {
            day: '2-digit',
            month: 'short', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };

        return date.toLocaleDateString('id-ID', options);
        } catch (error) {
        return 'Format tanggal tidak valid';
        }
        }

        // ===== UPDATE LAST UPDATED INFO WIDGET =====
        function updateLastUpdatedInfo() {
        const container = document.getElementById('lastUpdatedInfo');
        if (!container) return;

        // ‚úÖ DEBUG: Cek data products
        console.log('üîç trackingData.productsData:', trackingData.productsData);
        console.log('üîç Length:', trackingData.productsData ? trackingData.productsData.length : 'undefined');

        if (!trackingData.productsData || trackingData.productsData.length === 0) {
        container.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="color: var(--text-muted);">
                    <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                <\/svg>
                <span>Belum ada data<\/span>
            <\/div>
        `;
        return;
        }

        // Cari produk yang paling baru di-update
        let latestProduct = null;
        let latestTime = null;

        trackingData.productsData.forEach((product, index) => {
        // ‚úÖ DEBUG: Cek setiap produk
        console.log(`üîç Product ${index}:`, {
            sku: product.sku,
            user: product.user,
            updated_at: product.updated_at,
            created_at: product.created_at // backup kalau updated_at kosong
        });

        // ‚úÖ IMPROVED: Coba updated_at dulu, kalau kosong pake created_at
        const timeField = product.updated_at || product.created_at;

        if (timeField) {
            const updateTime = new Date(timeField);
            console.log(`üîç Parsed time for ${product.sku}:`, updateTime);
            
            if (!latestTime || updateTime > latestTime) {
                latestTime = updateTime;
                latestProduct = product;
                latestProduct.timeUsed = timeField; // simpan field mana yang dipake
            }
        }
        });

        console.log('üîç Latest product found:', latestProduct);

        if (latestProduct) {
        const formattedTime = formatDateTimeIndo(latestProduct.timeUsed);
        const userName = latestProduct.user || 'System';

        console.log('üîç Final display:', { userName, formattedTime });

        container.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="color: var(--blue);">
                    <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                <\/svg>
                <span>Last Update: <strong>${userName}<\/strong> - ${formattedTime}<\/span>
            <\/div>
        `;
        } else {
        console.log('‚ùå No latest product found');
        container.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="color: var(--text-muted);">
                    <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                <\/svg>
                <span>Tidak ada info update<\/span>
            <\/div>
        `;
        }
        }


        function updateLaporanLastUpdatedInfo() {
        const container = document.getElementById('laporanLastUpdatedInfo');
        if (!container) return;

        // Cek ada data movement atau tidak
        if (!trackingData.movementsData || trackingData.movementsData.length === 0) {
        container.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="color: var(--text-muted);">
                    <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                <\/svg>
                <span>Belum ada movement<\/span>
            <\/div>
        `;
        return;
        }

        // Cari movement yang paling baru
        let latestMovement = trackingData.movementsData[trackingData.movementsData.length - 1];
        const userName = latestMovement.user || latestMovement.created_by || 'System';
        const moveDate = latestMovement.movement_date || 'Unknown';

        container.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="color: var(--blue);">
                <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
            <\/svg>
            <span>Last Update: <strong>${userName}<\/strong> - ${moveDate}<\/span>
        <\/div>
        `;
        } 





        // ===== AI PREDICTIONS WIDGETS =====

        // ===== AI PREDICTIONS WIDGETS - ENHANCED DELIVERY PERFORMANCE =====

        // 1Ô∏è‚É£ PACKAGE STATUS SUMMARY - Delivery Analytics Style
        function updatePackageStatusWidget() {
        const container = document.getElementById('packageStatusWidget');
        if (!container) return;

        // Hitung summary dari semua data
        const totalProcessing = trackingData.resiData.length;
        const totalDelivered = trackingData.deliveredData.length;
        const totalReturns = trackingData.returnsData.length;
        const totalPackages = totalProcessing + totalDelivered + totalReturns;

        // Breakdown status processing
        const pendingCount = trackingData.resiData.filter(item => 
        item.statusAPI === 'Pending' || item.statusAPI === 'Error'
        ).length;

        const onProcessCount = trackingData.resiData.filter(item => 
        item.statusAPI !== 'Pending' && 
        item.statusAPI !== 'Error' && 
        !item.statusAPI.includes('DELIVERED') && 
        !item.statusAPI.includes('RETURN')
        ).length;

        if (totalPackages === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                üì¶ Belum ada data package
            <\/div>
        `;
        return;
        }

        container.innerHTML = `
        <div style="padding: 1rem;">
            <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 1rem;">
                üìä Package Status Overview:
            <\/div>
            
            <!-- TOTAL SUMMARY -->
            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--blue);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                    <div style="text-align: center;">
                        <div style="color: var(--blue); font-size: 1.5rem; font-weight: 700;">${totalPackages}<\/div>
                        <div style="color: var(--text-secondary); font-size: 0.8rem;">Total Packages<\/div>
                    <\/div>
                    <div style="text-align: center;">
                        <div style="color: var(--green); font-size: 1.5rem; font-weight: 700;">${totalDelivered}<\/div>
                        <div style="color: var(--text-secondary); font-size: 0.8rem;">Delivered<\/div>
                    <\/div>
                    <div style="text-align: center;">
                        <div style="color: var(--orange); font-size: 1.5rem; font-weight: 700;">${totalProcessing}<\/div>
                        <div style="color: var(--text-secondary); font-size: 0.8rem;">Processing<\/div>
                    <\/div>
                    <div style="text-align: center;">
                        <div style="color: var(--red); font-size: 1.5rem; font-weight: 700;">${totalReturns}<\/div>
                        <div style="color: var(--text-secondary); font-size: 0.8rem;">Returns<\/div>
                    <\/div>
                <\/div>
            <\/div>
            
            <!-- PROCESSING BREAKDOWN -->
            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--orange);">
                <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">üîÑ Processing Breakdown:<\/div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">üìä On Process:<\/span>
                        <span style="color: var(--blue); font-weight: 600;">${onProcessCount}<\/span>
                    <\/div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">‚è≥ Pending:<\/span>
                        <span style="color: var(--orange); font-weight: 600;">${pendingCount}<\/span>
                    <\/div>
                <\/div>
            <\/div>
        <\/div>
        `;
        }
        // 3Ô∏è‚É£ COST EFFICIENCY - Enhanced with Stuck Package Cost Analysis
        function updateCostEfficiencyWidget() {
        const container = document.getElementById('costEfficiencyWidget');
        if (!container) return;

        const stats = calculateTotalAPIStats();

        container.innerHTML = `
        <div style="padding: 1rem;">
            <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.75rem;">üí∞ Real-time Cost Data<\/div>
            
            <div style="display: grid; gap: 0.5rem; font-size: 0.9rem;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">üìä Total API Calls:<\/span>
                    <span style="color: var(--blue); font-weight: 600;">${stats.totalChecks}<\/span>
                <\/div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">üí∞ Total Cost:<\/span>
                    <span style="color: var(--green); font-weight: 600;">Rp ${formatNumber(stats.totalCost)}<\/span>
                <\/div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">üì¶ Delivered:<\/span>
                    <span style="color: var(--green); font-weight: 600;">${stats.delivered}<\/span>
                <\/div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-secondary);">üîÅ Returns:<\/span>
                    <span style="color: var(--red); font-weight: 600;">${stats.returns}<\/span>
                <\/div>
            <\/div>
        <\/div>
        `;
        }


        // ===== HELPER FUNCTIONS UNTUK PARSE TANGGAL =====

        function parseIndonesianDate(dateStr) {
        if (!dateStr) return null;  // ‚Üê TAMBAH INI

        const months = {
        'Januari': 0, 'Februari': 1, 'Maret': 2, 'April': 3, 'Mei': 4, 'Juni': 5,
        'Juli': 6, 'Agustus': 7, 'September': 8, 'Oktober': 9, 'November': 10, 'Desember': 11
        };

        try {
        // Format: "Sabtu, 12 Juli 2025"
        const parts = dateStr.split(', ')[1]; // Ambil "12 Juli 2025"
        if (!parts) return null;  // ‚Üê TAMBAH INI

        const [day, month, year] = parts.split(' ');

        const dayNum = parseInt(day);
        const monthNum = months[month];
        const yearNum = parseInt(year);

        if (dayNum && monthNum !== undefined && yearNum) {
            return new Date(yearNum, monthNum, dayNum);
        }
        } catch (error) {
        console.error('Error parsing Indonesian date:', dateStr, error);
        }

        return null;
        }

        // Parse ISO date "2025-07-14 14:18:11" ‚Üí Date object
        function parseISODate(dateStr) {
        if (!dateStr) return null;

        try {
        // Format: "2025-07-14 14:18:11" atau "2025-07-14"
        return new Date(dateStr);
        } catch (error) {
        console.error('Error parsing ISO date:', dateStr, error);
        return null;
        }
        }

        // Hitung selisih hari antara 2 tanggal
        function calculateDaysDiff(startDate, endDate) {
        if (!startDate || !endDate) return null;

        const diffTime = endDate.getTime() - startDate.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        return Math.max(diffDays, 0); // Jangan sampai minus
        }




        // 4Ô∏è‚É£ COURIER SLA RANKING - Average Delivery Time Focus
        function updateCourierRankingWidget() {
        const container = document.getElementById('courierRankingWidget');
        if (!container) return;

        const deliveredData = trackingData.deliveredData || [];

        if (deliveredData.length === 0) {
        container.innerHTML = `
            <div style="
                text-align: center; 
                padding: 3rem 2rem;
                background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(139,92,246,0.1) 100%);
                border-radius: 16px;
                border: 1px solid rgba(59,130,246,0.2);
            ">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶<\/div>
                <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Waiting for Deliveries<\/div>
                <div style="color: var(--text-muted); font-size: 0.85rem;">SLA ranking will appear when packages are delivered<\/div>
            <\/div>
        `;
        return;
        }

        // Calculate SLA data (same logic as before)
        const courierSLA = {};
        let processedCount = 0;

        deliveredData.forEach(item => {
        const courier = item.ekspedisi || 'Unknown';
        const scanDate = parseIndonesianDate(item.tanggal);      
        const deliveredDate = parseISODate(item.tglDiterima);    
        const daysDiff = calculateDaysDiff(scanDate, deliveredDate);

        if (daysDiff !== null && daysDiff >= 0) {
            if (!courierSLA[courier]) {
                courierSLA[courier] = { totalDays: 0, packageCount: 0 };
            }
            courierSLA[courier].totalDays += daysDiff;
            courierSLA[courier].packageCount += 1;
            processedCount++;
        }
        });

        const ranking = Object.entries(courierSLA)
        .map(([name, data]) => ({
            name: name,
            avgDays: (data.totalDays / data.packageCount).toFixed(1),
            packageCount: data.packageCount
        }))
        .filter(item => item.name !== 'Unknown') // Filter out Unknown
        .sort((a, b) => parseFloat(a.avgDays) - parseFloat(b.avgDays))
        .slice(0, 5);

        if (ranking.length === 0) {
        container.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No valid SLA data<\/div>`;
        return;
        }

        // üé® MODERN UI RENDERING
        container.innerHTML = `
        <div style="padding: 1.5rem;">
            <!-- MODERN HEADER -->
            <div style="
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid rgba(59,130,246,0.2);
            ">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div style="
                        width: 40px; 
                        height: 40px; 
                        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
                        border-radius: 12px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        box-shadow: 0 8px 25px rgba(59,130,246,0.3);
                    ">
                        <span style="font-size: 1.2rem;">üèÜ<\/span>
                    <\/div>
                    <div>
                        <div style="color: var(--text-primary); font-weight: 700; font-size: 1.1rem;">SLA Performance<\/div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">Fastest delivery ranking<\/div>
                    <\/div>
                <\/div>
                <div style="
                    background: rgba(16,185,129,0.1); 
                    color: #10b981; 
                    padding: 0.4rem 0.8rem; 
                    border-radius: 20px; 
                    font-size: 0.75rem; 
                    font-weight: 600;
                    border: 1px solid rgba(16,185,129,0.2);
                ">
                    ${processedCount} analyzed
                <\/div>
            <\/div>
            
            <!-- RANKING CARDS -->
            ${ranking.map((item, index) => {
                const gradients = [
        'linear-gradient(135deg, #10b981 0%, #059669 100%)', // Green (ganti dari kuning)
        'linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 100%)', // Silver  
        'linear-gradient(135deg, #CD7F32 0%, #B8860B 100%)', // Bronze
        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', // Purple
        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'  // Pink
        ];
                
                const shadowColors = [
        'rgba(16,185,129,0.4)', // Green shadow (ganti dari kuning)
        'rgba(192,192,192,0.3)', 
        'rgba(205,127,50,0.3)',
        'rgba(102,126,234,0.3)', 
        'rgba(240,147,251,0.3)'
        ];
                
                const medals = ['üëë', 'ü•à', 'ü•â', 'üéñÔ∏è', 'üèÖ'];
                const ranks = ['CHAMPION', 'RUNNER-UP', 'THIRD', '4TH PLACE', '5TH PLACE'];
                
                // Performance indicator
                const avgDays = parseFloat(item.avgDays);
                let performanceColor, performanceText;
                if (avgDays <= 1) {
                    performanceColor = '#10b981';
                    performanceText = 'EXCELLENT';
                } else if (avgDays <= 2) {
                    performanceColor = '#f59e0b';
                    performanceText = 'GOOD';
                } else {
                    performanceColor = '#ef4444';
                    performanceText = 'NEEDS IMPROVEMENT';
                }
                
                return `
                    <div style="
                        background: var(--bg-primary);
                        border-radius: 16px;
                        padding: 1.75rem;
                        margin-bottom: 1.25rem;
                        border: 1px solid rgba(255,255,255,0.1);
                        position: relative;
                        overflow: hidden;
                        transition: all 0.3s ease;
                        cursor: pointer;
                        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                        min-height: 120px;
                    " 
                    onmouseover="
                        this.style.transform='translateY(-8px) scale(1.02)'; 
                        this.style.boxShadow='0 20px 40px ${shadowColors[index]}';
                        this.style.borderColor='rgba(255,255,255,0.2)';
                    " 
                    onmouseout="
                        this.style.transform='translateY(0) scale(1)'; 
                        this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)';
                        this.style.borderColor='rgba(255,255,255,0.1)';
                    ">
                        
        <!-- RANK BADGE -->
        <div style="
        position: absolute;
        top: -4px;
        right: -4px;
        width: 35px;
        height: 35px;
        background: ${gradients[index]};
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px ${shadowColors[index]};
        border: 2px solid var(--bg-primary);
        ">
        <span style="font-size: 1rem; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.4));">${medals[index]}<\/span>
        <\/div>
                        
                        <!-- MAIN CONTENT -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1; margin-right: 1rem;">
                                <!-- COURIER NAME -->
                                <div style="
                                    color: var(--text-primary); 
                                    font-weight: 900; 
                                    font-size: 1.3rem; 
                                    margin-bottom: 0.25rem;
                                    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                ">${item.name}<\/div>
                                
                                <!-- RANK TEXT -->
                                <div style="
                                    color: var(--text-muted); 
                                    font-size: 0.75rem; 
                                    font-weight: 600; 
                                    text-transform: uppercase; 
                                    letter-spacing: 1px;
                                    margin-bottom: 0.5rem;
                                ">${ranks[index]}<\/div>
                                
                                <!-- PACKAGE COUNT -->
                                <div style="
                                    display: inline-block;
                                    background: rgba(59,130,246,0.1); 
                                    color: #3b82f6; 
                                    padding: 0.3rem 0.6rem; 
                                    border-radius: 12px; 
                                    font-size: 0.75rem; 
                                    font-weight: 600;
                                    border: 1px solid rgba(59,130,246,0.2);
                                ">üì¶ ${item.packageCount} packages<\/div>
                            <\/div>
                            
                            <!-- SLA TIME -->
                            <div style="text-align: right;">
                                <div style="
                                    font-size: 2.5rem; 
                                    font-weight: 900; 
                                    background: ${gradients[index]};
                                    -webkit-background-clip: text;
                                    -webkit-text-fill-color: transparent;
                                    background-clip: text;
                                    line-height: 1;
                                    margin-bottom: 0.25rem;
                                    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
                                ">${item.avgDays}<\/div>
                                
                                <div style="
                                    color: var(--text-muted); 
                                    font-size: 0.8rem; 
                                    font-weight: 600;
                                    margin-bottom: 0.5rem;
                                ">days avg<\/div>
                                
                                <!-- PERFORMANCE BADGE -->
                                <div style="
                                    background: rgba(${performanceColor === '#10b981' ? '16,185,129' : performanceColor === '#f59e0b' ? '245,158,11' : '239,68,68'},0.1);
                                    color: ${performanceColor};
                                    padding: 0.25rem 0.5rem;
                                    border-radius: 8px;
                                    font-size: 0.65rem;
                                    font-weight: 700;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    border: 1px solid rgba(${performanceColor === '#10b981' ? '16,185,129' : performanceColor === '#f59e0b' ? '245,158,11' : '239,68,68'},0.2);
                                ">${performanceText}<\/div>
                            <\/div>
                        <\/div>
                    <\/div>
                `;
            }).join('')}
        <\/div>
        `;
        }

        // Helper function to parse Indonesian date format
        function parseDateIndo(dateString) {
        if (!dateString) return new Date();

        const months = {
        'Januari': 0, 'Februari': 1, 'Maret': 2, 'April': 3, 'Mei': 4, 'Juni': 5,
        'Juli': 6, 'Agustus': 7, 'September': 8, 'Oktober': 9, 'November': 10, 'Desember': 11
        };

        // Format: "15 Juli 2025"
        const parts = dateString.split(' ');
        if (parts.length === 3) {
        const day = parseInt(parts[0]);
        const month = months[parts[1]];
        const year = parseInt(parts[2]);

        if (day && month !== undefined && year) {
            return new Date(year, month, day);
        }
        }

        return new Date(); // fallback
        }



        // ===== REAL-TIME AI DASHBOARD UPDATE ===== ‚Üê TAMBAH INI
        function updateAIDashboardRealtime() {
        const stats = calculateTotalAPIStats();

        // Update DOM elements langsung
        const deliveredEl = document.getElementById('deliveredToday');
        const returnsEl = document.getElementById('returnsToday');
        const totalChecksEl = document.getElementById('totalChecksToday');
        const successRateEl = document.getElementById('successRateToday');

        // ===== DIRECT UPDATE COST ELEMENT =====
        const costElement = document.getElementById('costTodayLive');

        if (deliveredEl) deliveredEl.textContent = stats.delivered;
        if (returnsEl) returnsEl.textContent = stats.returns;
        if (totalChecksEl) totalChecksEl.textContent = stats.totalChecks;

        // DIRECT UPDATE - NO formatNumber untuk test
        if (costElement) {
        costElement.textContent = 'Rp ' + stats.totalCost;
        console.log('‚úÖ Updated costTodayLive to:', stats.totalCost);
        } else {
        console.log('‚ùå costTodayLive element not found');
        }

        // Calculate success rate
        const finalized = stats.delivered + stats.returns;
        const successRate = finalized > 0 ? Math.round((stats.delivered / finalized) * 100) : 0;
        if (successRateEl) successRateEl.textContent = successRate + '%';
        }




        function updateAIPredictions() {
        updateCourierAnalysis();
        updateAIMetrics(); 
        updateCostOptimization();

        updateCostEfficiencyWidget(); 
        updateCourierRankingWidget(); 
        updateStuckProbabilityWidget(); 
        updatePackageStatusWidget(); // ‚Üê TAMBAH INI

        console.log('üîÆ AI Predictions updated with real data');
        }

        function updateStuckProbabilityWidget() {
        const container = document.getElementById('stuckProbabilityWidget');
        if (!container) return;

        const today = new Date();
        const stuckPackages = [];

        // Cari paket yang "stuck" (pending > 5 hari)
        trackingData.resiData.forEach(item => {
        if (item.statusAPI === 'Pending' || item.statusAPI === 'Error') {
            // Hitung umur paket (asumsi tanggal format "15 Juli 2025")
            const scanDate = new Date(); // Simplified for now
            const daysSinceStuck = 3; // Dummy calculation
            
            if (daysSinceStuck >= 3) {
                const riskLevel = daysSinceStuck >= 7 ? 'HIGH RISK' : daysSinceStuck >= 5 ? 'MEDIUM RISK' : 'LOW RISK';
                const riskColor = daysSinceStuck >= 7 ? '#ef4444' : daysSinceStuck >= 5 ? '#f59e0b' : '#3b82f6';
                
                stuckPackages.push({
                    resi: item.resi,
                    courier: item.ekspedisi,
                    days: daysSinceStuck,
                    riskLevel: riskLevel,
                    riskColor: riskColor
                });
            }
        }
        });

        if (stuckPackages.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; color: var(--green); padding: 2rem;">
                üéØ Excellent! Tidak ada paket stuck.<br>
                <span style="font-size: 0.8rem; color: var(--text-muted);">Semua packages dalam kondisi normal<\/span>
            <\/div>
        `;
        return;
        }

        container.innerHTML = `
        <div style="padding: 1rem;">
            <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 1rem;">
                üö® ${stuckPackages.length} Paket Berpotensi Stuck:
            <\/div>
            
            ${stuckPackages.slice(0, 5).map(pkg => `
                <div style="background: var(--bg-primary); border-left: 4px solid ${pkg.riskColor}; padding: 1rem; margin-bottom: 0.5rem; border-radius: 6px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="color: var(--text-primary); font-weight: 600; font-family: monospace;">${pkg.resi}<\/div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">${pkg.courier}<\/div>
                        <\/div>
                        <div style="text-align: right;">
                            <div style="color: ${pkg.riskColor}; font-weight: 600;">${pkg.days} hari<\/div>
                            <div style="color: ${pkg.riskColor}; font-size: 0.8rem; font-weight: 600;">${pkg.riskLevel}<\/div>
                        <\/div>
                    <\/div>
                <\/div>
            `).join('')}
            
            ${stuckPackages.length > 5 ? `
                <div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 1rem;">
                    dan ${stuckPackages.length - 5} paket lainnya...
                <\/div>
            ` : ''}
        <\/div>
        `;
        }




        function updateCourierAnalysis() {
        // Hitung performance per courier dari delivered data
        const courierStats = {};

        trackingData.deliveredData.forEach(item => {
        const courier = item.ekspedisi;
        if (!courierStats[courier]) {
            courierStats[courier] = { delivered: 0, totalDays: 0 };
        }
        courierStats[courier].delivered++;
        // Dummy calculation - bisa pake tanggal delivered vs tanggal scan
        courierStats[courier].totalDays += 3; // placeholder average
        });

        // Calculate average delivery time & sort by performance
        const courierPerformance = Object.entries(courierStats)
        .map(([courier, stats]) => ({
            courier: courier,
            avgDays: (stats.totalDays / stats.delivered).toFixed(1),
            delivered: stats.delivered
        }))
        .sort((a, b) => parseFloat(a.avgDays) - parseFloat(b.avgDays))
        .slice(0, 3); // Top 3

        // Update best courier stat
        const bestCourierEl = document.getElementById('bestCourier');
        if (bestCourierEl && courierPerformance.length > 0) {
        bestCourierEl.textContent = courierPerformance[0].courier.split(' ')[0];
        }

        // Update courier performance widget
        const widget = document.getElementById('courierPerformanceWidget');
        if (widget && courierPerformance.length > 0) {
        widget.innerHTML = courierPerformance.map(item => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--bg-primary); border-radius: 6px; margin-bottom: 0.5rem;">
                <span>${item.courier.split(' ')[0]} (${item.delivered})<\/span>
                <span style="color: var(--green); font-weight: 600;">${item.avgDays} days<\/span>
            <\/div>
        `).join('');
        }
        }

        function updateAIMetrics() {
        // Calculate real metrics
        const totalDelivered = trackingData.deliveredData.length;
        const totalReturns = trackingData.returnsData.length;
        const totalProcessed = totalDelivered + totalReturns;

        // API Efficiency
        const apiEfficiency = totalProcessed > 0 ? Math.round((totalDelivered / totalProcessed) * 100) : 0;
        const apiEfficiencyEl = document.getElementById('apiEfficiency');
        if (apiEfficiencyEl) {
        apiEfficiencyEl.textContent = apiEfficiency + '%';
        }

        // Risk Alert (pending resi yang lama)
        const riskAlert = trackingData.resiData.length;
        const riskAlertEl = document.getElementById('riskAlert');
        if (riskAlertEl) {
        riskAlertEl.textContent = riskAlert;
        }
        }

        function updateCostOptimization() {
        // Calculate current monthly cost projection
        const currentInterval = autoCheckInterval || 5; // default 5 minutes
        const dailyCalls = (24 * 60) / currentInterval; // calls per day
        const monthlyCost = dailyCalls * 30 * 15; // monthly cost

        const currentMonthlyCostEl = document.getElementById('currentMonthlyCost');
        if (currentMonthlyCostEl) {
        currentMonthlyCostEl.textContent = 'Rp ' + formatNumber(monthlyCost);
        }
        }


        async function updateAutoCheckHistoryTable() {
        const tbody = document.getElementById('autoCheckHistoryBody');
        if (!tbody) return;

        try {
        // Show loading indicator
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">üîÑ Loading history...<\/td><\/tr>';

        // Load dari database
        const response = await fetch('database.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'load_autocheck_history',
                user: currentUser,
                date: new Date().toISOString().slice(0, 10)
            })
        });

        const result = await response.json();
        console.log('üîç Auto check history response:', result);

        if (result.success && result.history) {
            const todayUpdates = result.history.slice(-20).reverse();
            
            tbody.innerHTML = '';
            
            if (todayUpdates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">Belum ada auto check hari ini<\/td><\/tr>';
                return;
            }
            
            todayUpdates.forEach(update => {
                const time = new Date(update.check_time).toLocaleTimeString('id-ID');
                
                // LOGIC RESULT YANG SIMPLE
                let resultText, resultColor;
                if (update.result === 'SUCCESS') {
                    resultText = '‚úÖ Sukses';
                    resultColor = 'var(--green)';
                } else if (update.result === 'NO_CHANGE') {
                    resultText = 'üîÑ Tidak Ada Perubahan';
                    resultColor = 'var(--blue)';
                } else {
                    resultText = '‚ùå Gagal Dicek';
                    resultColor = 'var(--red)';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-family: monospace; font-size: 0.8rem;">${time}<\/td>
                    <td style="font-family: monospace; font-weight: 600;">${update.resi}<\/td>
                    <td><span class="courier-badge ${getCourierClass(update.courier)}">${update.courier.split(' ')[0]}<\/span><\/td>
                    <td>
                        <span class="status-badge status-pending">${update.before_status}<\/span> ‚Üí 
                        <span class="status-badge ${update.after_status === 'DELIVERED' ? 'status-delivered' : update.after_status.includes('RETURN') ? 'status-return' : 'status-pending'}">${update.after_status}<\/span>
                    <\/td>
                    <td style="color: var(--red); font-weight: 600; font-size: 0.8rem;">Rp ${update.cost}<\/td>
                    <td>
                        <span style="color: ${resultColor}; font-weight: 600; font-size: 0.8rem;">
                            ${resultText}
                        <\/span>
                    <\/td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="showDetail('${update.resi}')" title="Lihat Detail Tracking">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>
                            <\/svg>
                        <\/button>
                    <\/td>
                `;
                tbody.appendChild(row);
            });
            
            console.log(`üìã History table updated: ${todayUpdates.length} database entries`);
        } else {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">Gagal load history dari database<\/td><\/tr>';
            console.error('‚ùå Failed to load history:', result);
        }

        } catch (error) {
        console.error('Error loading auto check history:', error);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">Error loading history<\/td><\/tr>';
        }
        }



        async function updateDailySummaryStats() {
        try {
        // Get today's date
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

        // Load auto check history from database for today
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_autocheck_history',
                user: currentUser,
                date: today
            })
        });

        const result = await response.json();

        if (result.success && result.history) {
            const todayHistory = result.history;
            
            // Count by result type
            const delivered = todayHistory.filter(h => h.after_status === 'DELIVERED').length;
            const returns = todayHistory.filter(h => h.after_status.includes('RETURN')).length;
            const totalChecks = todayHistory.length;
            const successRate = totalChecks > 0 ? Math.round((delivered / (delivered + returns)) * 100) : 0;
            
            // Update DOM elements
            const deliveredEl = document.getElementById('deliveredToday');
            const returnsEl = document.getElementById('returnsToday');
            const totalChecksEl = document.getElementById('totalChecksToday');
            const successRateEl = document.getElementById('successRateToday');
            
            if (deliveredEl) deliveredEl.textContent = delivered;
            if (returnsEl) returnsEl.textContent = returns;
            if (totalChecksEl) totalChecksEl.textContent = totalChecks;
            if (successRateEl) successRateEl.textContent = successRate + '%';
            
            console.log('üìä Daily stats updated from database:', { delivered, returns, totalChecks, successRate });
        }
        } catch (error) {
        console.error('Error updating daily summary stats:', error);
        }
        }


        // ===== AI INTELLIGENCE FUNCTIONS =====
        async function updateAutoCheckStatus() {
        // Update badge di sidebar
        const statusBadge = document.getElementById('autoCheckStatus');
        if (statusBadge) {
        statusBadge.textContent = autoCheckStatus ? 'ON' : 'OFF';
        statusBadge.className = 'nav-badge ' + (autoCheckStatus ? 'info' : '');
        }

        // Update live status di monitoring tab
        const statusLive = document.getElementById('autoCheckStatusLive');
        const intervalLive = document.getElementById('checkIntervalLive');
        // const costLive = document.getElementById('costTodayLive'); ‚Üê HAPUS INI

        if (statusLive) {
        statusLive.textContent = autoCheckStatus ? 'RUNNING' : 'STOPPED';
        statusLive.style.color = autoCheckStatus ? '#10b981' : '#ef4444';
        }

        if (intervalLive) {
        intervalLive.textContent = autoCheckInterval > 0 ? autoCheckInterval + ' minutes' : 'Manual Only';
        }

        // ===== HAPUS SEMUA BAGIAN INI ===== 
        /*
        if (costLive) {
        // Hitung real cost dari database auto check history
        try {
            const todayCost = await calculateRealAPICost();
            costLive.textContent = 'Rp ' + formatNumber(todayCost);
        } catch (error) {
            console.error('Error getting API cost:', error);
            costLive.textContent = 'Rp 0';
        }
        }
        */

        console.log('ü§ñ AI Intelligence status updated with real data');
        }

        async function calculateRealAPICost() {
        try {
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

        // Load auto check history from database for today
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_autocheck_history',
                user: currentUser,
                date: today
            })
        });

        const result = await response.json();

        if (result.success && result.history) {
            // Sum total cost from database
            const totalCost = result.history.reduce((sum, item) => sum + (item.cost || 15), 0);
            return totalCost;
        }

        return 0; // Fallback jika ga ada data

        } catch (error) {
        console.error('Error calculating API cost:', error);
        return 0;
        }
        }



        // Function untuk apply smart filters
        function applyStockFilters() {
        const statusFilter = document.getElementById('stockStatusFilter').value;
        const rangeFilter = document.getElementById('stockRangeFilter').value;
        const searchInput = document.querySelector('#laporan-tab .search-input');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

        const tbody = document.getElementById('laporanStockBody');
        if (!tbody) return;

        const rows = tbody.querySelectorAll('tr');

        rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 8) return; // Skip header atau empty rows

        const sku = cells[0].textContent.toLowerCase();
        const nama = cells[1].textContent.toLowerCase();
        const currentStock = parseInt(cells[6].textContent) || 0;
        const status = cells[7].textContent.trim();

        let showRow = true;

        // Search filter
        if (searchTerm && !sku.includes(searchTerm) && !nama.includes(searchTerm)) {
            showRow = false;
        }

        // Status filter
        if (statusFilter && !status.includes(statusFilter)) {
            showRow = false;
        }

        // Range filter
        if (rangeFilter) {
            if (rangeFilter === '0' && currentStock !== 0) showRow = false;
            if (rangeFilter === '1-5' && (currentStock < 1 || currentStock > 5)) showRow = false;
            if (rangeFilter === '6-10' && (currentStock < 6 || currentStock > 10)) showRow = false;
            if (rangeFilter === '11+' && currentStock < 11) showRow = false;
        }

        row.style.display = showRow ? '' : 'none';
        });
        }

        function refreshStockReport() {
        showToast('üîÑ Refreshing stock report...', 'info');
        updateLaporanStock();

        // TAMBAH INI
        updateLaporanLastUpdatedInfo();

        // Reset filters
        document.getElementById('stockStatusFilter').value = '';
        document.getElementById('stockRangeFilter').value = '';
        const searchInput = document.querySelector('#laporan-tab .search-input');
        if (searchInput) searchInput.value = '';
        }

        // Export function
        function exportStockReport() {
        if (!trackingData.productsData || trackingData.productsData.length === 0) {
        showToast('‚ùå Tidak ada data untuk di-export!', 'error');
        return;
        }

        // Create CSV data
        let csv = 'SKU,Nama Barang,Unit,Stok Awal,Stock IN,Stock OUT,Current Stock,Status\n';

        trackingData.productsData.forEach(product => {
        const movements = trackingData.movementsData ? trackingData.movementsData.filter(m => m.sku === product.sku) : [];
        const stockIn = movements.filter(m => m.type === 'in').reduce((sum, m) => sum + parseInt(m.qty || 0), 0);
        const stockOut = movements.filter(m => m.type === 'out').reduce((sum, m) => sum + parseInt(m.qty || 0), 0);
        const currentStock = parseInt(product.stok_awal || 0) + stockIn - stockOut;

        let status;
        if (currentStock <= 0) status = 'HABIS';
        else if (currentStock <= 5) status = 'LOW STOCK';
        else if (currentStock <= 10) status = 'WARNING';
        else status = 'AMAN';

        csv += `"${product.sku}","${product.nama_barang}","${product.unit}",${product.stok_awal},${stockIn},${stockOut},${currentStock},"${status}"\n`;
        });

        // Download CSV
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `stock_report_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
        URL.revokeObjectURL(url);

        showToast('‚úÖ Stock report berhasil di-export!', 'success');
        }

        // Tambahin event listener untuk search input
        document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
        const searchInput = document.querySelector('#laporan-tab .search-input');
        if (searchInput) {
            searchInput.addEventListener('input', applyStockFilters);
        }
        }, 1000);
        });

        // ===== LAPORAN STOCK FUNCTIONS =====
        function updateLaporanStock() {
        if (!trackingData.productsData || trackingData.productsData.length === 0) {
        const tbody = document.getElementById('laporanStockBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted); padding: 2rem;">Belum ada data stock.<\/td><\/tr>';
        }
        return;
        }

        const tbody = document.getElementById('laporanStockBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        trackingData.productsData.forEach((product) => {
        // Calculate movements for this product
        const movements = trackingData.movementsData ? trackingData.movementsData.filter(m => m.sku === product.sku) : [];
        const stockIn = movements.filter(m => m.type === 'in').reduce((sum, m) => sum + parseInt(m.qty || 0), 0);
        const stockOut = movements.filter(m => m.type === 'out').reduce((sum, m) => sum + parseInt(m.qty || 0), 0);
        const currentStock = parseInt(product.stok_awal || 0) + stockIn - stockOut;

        // Determine status
        let statusClass, statusText;
        if (currentStock <= 0) {
            statusClass = 'status-return';
            statusText = 'HABIS';
        } else if (currentStock <= 5) {
            statusClass = 'status-error';
            statusText = 'LOW STOCK';
        } else if (currentStock <= 10) {
            statusClass = 'status-pending';
            statusText = 'WARNING';
        } else {
            statusClass = 'status-delivered';
            statusText = 'AMAN';
        }

        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="font-family: monospace; font-weight: 600;">${product.sku}<\/td>
            <td>${product.nama_barang}<\/td>
            <td>${product.unit}<\/td>
            <td>${product.stok_awal}<\/td>
            <td style="color: var(--green); font-weight: 600;">${stockIn}<\/td>
            <td style="color: var(--red); font-weight: 600;">${stockOut}<\/td>
            <td style="font-size: 1.1rem; font-weight: 700;">${currentStock}<\/td>
            <td><span class="status-badge ${statusClass}">${statusText}<\/span><\/td>
        `;
        tbody.appendChild(row);
        });
        }

        // ===== REPORT FUNCTIONS =====
        function updateFastMovingItems() {
        const container = document.getElementById('fastMovingList');
        if (!container) return;

        if (!trackingData.movementsData || trackingData.movementsData.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Belum ada data movement<\/p>';
        return;
        }

        // Hitung total stock OUT per produk
        const stockOutData = {};
        trackingData.movementsData.forEach(movement => {
        if (movement.type === 'out') {
            const sku = movement.sku;
            stockOutData[sku] = (stockOutData[sku] || 0) + parseInt(movement.qty || 0);
        }
        });

        // Sort dan ambil top 5
        const sortedProducts = Object.entries(stockOutData)
        .map(([sku, totalOut]) => {
            const product = trackingData.productsData.find(p => p.sku === sku);
            return {
                sku: sku,
                nama: product ? product.nama_barang : 'Unknown Product',
                totalOut: totalOut
            };
        })
        .sort((a, b) => b.totalOut - a.totalOut)
        .slice(0, 5);

        if (sortedProducts.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Belum ada stock out<\/p>';
        return;
        }

        // SVG Icons untuk ranking
        const getRankingIcon = (index) => {
        const icons = {
            0: `<svg width="20" height="20" viewBox="0 0 24 24" fill="#FFD700" style="filter: drop-shadow(0 2px 4px rgba(255,215,0,0.4));">
                    <path d="M5 16L3 21L8.5 18L12 21L15.5 18L21 21L19 16H5M12 2L13.09 8.26L22 9L17 14L18.18 22L12 19L5.82 22L7 14L2 9L10.91 8.26L12 2Z"/>
                <\/svg>`,
            1: `<svg width="18" height="18" viewBox="0 0 24 24" fill="#C0C0C0" style="filter: drop-shadow(0 1px 3px rgba(192,192,192,0.4));">
                    <path d="M12 2L13.09 8.26L22 9L17 14L18.18 22L12 19L5.82 22L7 14L2 9L10.91 8.26L12 2Z"/>
                <\/svg>`,
            2: `<svg width="16" height="16" viewBox="0 0 24 24" fill="#CD7F32" style="filter: drop-shadow(0 1px 2px rgba(205,127,50,0.4));">
                    <path d="M12 2L13.09 8.26L22 9L17 14L18.18 22L12 19L5.82 22L7 14L2 9L10.91 8.26L12 2Z"/>
                <\/svg>`,
            3: `<svg width="14" height="14" viewBox="0 0 24 24" fill="#667eea">
                    <circle cx="12" cy="12" r="10"/>
                <\/svg>`,
            4: `<svg width="12" height="12" viewBox="0 0 24 24" fill="#f093fb">
                    <circle cx="12" cy="12" r="8"/>
                <\/svg>`
        };
        return icons[index] || '';
        };

        // Background gradients untuk setiap ranking
        const getRankingBg = (index) => {
        const backgrounds = {
            0: 'background: linear-gradient(135deg, rgba(255,215,0,0.15) 0%, rgba(255,193,7,0.1) 100%); border-left: 4px solid #FFD700;',
            1: 'background: linear-gradient(135deg, rgba(192,192,192,0.12) 0%, rgba(169,169,169,0.08) 100%); border-left: 4px solid #C0C0C0;',
            2: 'background: linear-gradient(135deg, rgba(205,127,50,0.12) 0%, rgba(184,115,51,0.08) 100%); border-left: 4px solid #CD7F32;',
            3: 'background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.06) 100%); border-left: 3px solid #667eea;',
            4: 'background: linear-gradient(135deg, rgba(240,147,251,0.1) 0%, rgba(245,87,108,0.06) 100%); border-left: 3px solid #f093fb;'
        };
        return backgrounds[index] || 'border-left: 2px solid var(--border);';
        };

        // Warna nomor sesuai ranking
        const getNumberColor = (index) => {
        const colors = {
            0: '#FFD700',
            1: '#C0C0C0', 
            2: '#CD7F32',
            3: '#667eea',
            4: '#f093fb'
        };
        return colors[index] || 'var(--text-primary)';
        };

        container.innerHTML = sortedProducts.map((item, index) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; transition: all 0.2s ease; ${getRankingBg(index)}" 
             onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';" 
             onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none';">
            
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <!-- NOMOR RANKING -->
                <div style="display: flex; align-items: center; gap: 0.5rem; min-width: 60px;">
                    <span style="font-size: 1.2rem; font-weight: 900; color: ${getNumberColor(index)}; text-shadow: 0 1px 2px rgba(0,0,0,0.3); min-width: 20px;">#${index + 1}<\/span>
                    ${getRankingIcon(index)}
                <\/div>
                
                <div>
                    <div style="font-weight: 700; color: var(--text-primary); font-size: 0.95rem; margin-bottom: 2px;">${item.sku}<\/div>
                    <div style="color: var(--text-secondary); font-size: 0.8rem; line-height: 1.2;">${item.nama}<\/div>
                <\/div>
            <\/div>
            
            <div style="text-align: right;">
                <div style="color: #ffffff; font-weight: 900; font-size: 1.2rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${item.totalOut}<\/div>
                <div style="color: var(--text-muted); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">sold<\/div>
            <\/div>
        <\/div>
        `).join('');
        }

        function updateLowStockAlert() {
        const container = document.getElementById('lowStockList');
        if (!container) return;

        if (!trackingData.productsData || trackingData.productsData.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 1rem;">Belum ada produk<\/p>';
        return;
        }

        const lowStockItems = [];

        trackingData.productsData.forEach(product => {
        const movements = trackingData.movementsData ? trackingData.movementsData.filter(m => m.sku === product.sku) : [];
        const stockIn = movements.filter(m => m.type === 'in').reduce((sum, m) => sum + parseInt(m.qty || 0), 0);
        const stockOut = movements.filter(m => m.type === 'out').reduce((sum, m) => sum + parseInt(m.qty || 0), 0);
        const currentStock = parseInt(product.stok_awal || 0) + stockIn - stockOut;

        if (currentStock <= 5) {
            let alertLevel, alertColor;
            if (currentStock <= 0) {
                alertLevel = 'HABIS';
                alertColor = '#ff4757';
            } else if (currentStock <= 2) {
                alertLevel = 'KRITIS';
                alertColor = '#ff3838';
            } else {
                alertLevel = 'RENDAH';
                alertColor = '#ff6348';
            }
            
            lowStockItems.push({
                sku: product.sku,
                nama: product.nama_barang,
                currentStock: currentStock,
                alertLevel: alertLevel,
                alertColor: alertColor
            });
        }
        });

        // Sort by current stock (lowest first) - biar yang paling kritis di atas
        lowStockItems.sort((a, b) => a.currentStock - b.currentStock);

        if (lowStockItems.length === 0) {
        container.innerHTML = '<p style="color: var(--green); text-align: center; padding: 1rem; font-weight: 600;">‚úÖ Semua stock aman!<\/p>';
        return;
        }

        // Mini SVG icons untuk kanan aja
        const getMiniSVG = (item) => {
        if (item.currentStock <= 0) {
            return `<svg width="16" height="16" viewBox="0 0 24 24" fill="#ff4757" style="filter: drop-shadow(0 1px 2px rgba(255,71,87,0.3));">
                        <path d="M1,21H23L12,2L1,21Z"/>
                    <\/svg>`;
        } else if (item.currentStock <= 2) {
            return `<svg width="14" height="14" viewBox="0 0 24 24" fill="#ff3838" style="filter: drop-shadow(0 1px 2px rgba(255,56,56,0.3));">
                        <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1Z"/>
                    <\/svg>`;
        } else {
            return `<svg width="12" height="12" viewBox="0 0 24 24" fill="#ff6348" style="filter: drop-shadow(0 1px 2px rgba(255,99,72,0.3));">
                        <circle cx="12" cy="12" r="10"/>
                    <\/svg>`;
        }
        };

        // Background untuk alert level
        const getAlertBg = (item) => {
        if (item.currentStock <= 0) {
            return 'background: linear-gradient(135deg, rgba(255,71,87,0.2) 0%, rgba(255,71,87,0.1) 100%); border-left: 4px solid #ff4757;';
        } else if (item.currentStock <= 2) {
            return 'background: linear-gradient(135deg, rgba(255,56,56,0.15) 0%, rgba(255,56,56,0.08) 100%); border-left: 4px solid #ff3838;';
        } else {
            return 'background: linear-gradient(135deg, rgba(255,99,72,0.12) 0%, rgba(255,99,72,0.06) 100%); border-left: 3px solid #ff6348;';
        }
        };

        container.innerHTML = lowStockItems.map((item) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; transition: all 0.2s ease; ${getAlertBg(item)}" 
             onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 4px 12px rgba(255,71,87,0.2)';" 
             onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none';">
            
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <!-- CUMA TEXT AJA -->
                <div>
                    <div style="font-weight: 700; color: var(--text-primary); font-size: 0.95rem; margin-bottom: 2px;">${item.sku}<\/div>
                    <div style="color: var(--text-secondary); font-size: 0.8rem; line-height: 1.2;">${item.nama}<\/div>
                <\/div>
            <\/div>
            
            <div style="text-align: right;">
                <!-- ANGKA + MINI SVG -->
                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 0.4rem; margin-bottom: 4px;">
                    <span style="color: #ffffff; font-weight: 900; font-size: 1.2rem; text-shadow: 0 1px 3px rgba(0,0,0,0.3);">${item.currentStock}<\/span>
                    ${getMiniSVG(item)}
                <\/div>
                <div style="color: #ffffff; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">${item.alertLevel}<\/div>
            <\/div>
        <\/div>
        `).join('');
        }

        function updateMovementCount() {
        const reportMovements = document.getElementById('reportMovements');
        if (!reportMovements) return;

        const currentMonth = new Date().toISOString().slice(0,7); // YYYY-MM format
        const movementsThisMonth = trackingData.movementsData ? 
        trackingData.movementsData.filter(m => 
            m.movement_date && m.movement_date.startsWith(currentMonth)
        ).length : 0;

        reportMovements.textContent = movementsThisMonth;
        }    

        async function deleteMovement(sku) {  // ‚Üê Ganti parameter jadi SKU
        if (!confirm('Yakin hapus latest movement untuk ' + sku + '?\n\nData akan dihapus permanen!')) return;

        showToast('üóëÔ∏è Menghapus movement...', 'info');

        try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'delete_movement',
                sku: sku,  // ‚Üê Kirim SKU, bukan ID
                user: currentUser,
                device: currentDevice
            })
        });

        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ Movement berhasil dihapus!', 'success');
            loadMovementHistory();
            loadMasterProducts();
        } else {
            showToast('‚ùå Error: ' + result.message, 'error');
        }
        } catch (error) {
        showToast('‚ùå Error: ' + error.message, 'error');
        }
        }


        async function createTargetHarianWidget() {
        const container = document.getElementById('targetHarianWidget');

        if (!container) return;

        // Load target settings
        const targets = await loadTargetSettings();
        const dailyTarget = targets.daily_target;

        // HITUNG REAL DATA HARI INI
        const today = new Date();
        const todayStr = today.getDate() + ' Juli 2025'; // Format: "15 Juli 2025"

        let todayCount = 0;

        // Count dari resi yang di-scan hari ini
        trackingData.resiData.forEach(item => {
        if (item.tanggal === todayStr) {
            todayCount++;
        }
        });

        const percentage = Math.round((todayCount / dailyTarget) * 100);
        const progressColor = percentage >= 100 ? '#10b981' : percentage >= 80 ? '#f59e0b' : '#ef4444';

        container.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">
                ${todayCount}/${dailyTarget}
            <\/div>
            <div style="width: 100%; height: 6px; background: var(--bg-tertiary); border-radius: 3px; margin-bottom: 0.5rem;">
                <div style="width: ${Math.min(percentage, 100)}%; height: 100%; background: ${progressColor}; border-radius: 3px; transition: all 0.3s ease;"><\/div>
            <\/div>
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">
                ${percentage}% tercapai hari ini
            <\/div>
            ${todayCount >= dailyTarget ? 
                `<div style="font-size: 0.75rem; color: ${progressColor}; font-weight: 600;">
                    ${todayCount > dailyTarget ? 'üî• Melebihi target!' : 'üéâ Target tercapai!'}
                <\/div>` : 
                `<div style="font-size: 0.75rem; color: var(--text-muted);">
                    Butuh ${dailyTarget - todayCount} lagi
                <\/div>`
            }
        <\/div>
        `;
        }

        async function loadTargetSettings() {
        try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'load_settings',
                user: currentUser
            })
        });

        const result = await response.json();

        if (result.success && result.settings) {
            return {
                success_rate: parseInt(result.settings.target_success) || 90,
                return_rate: parseInt(result.settings.target_return) || 5,
                daily_target: parseInt(result.settings.target_daily) || 100
            };
        }
        } catch (error) {
        console.error('Error loading target settings:', error);
        }

        // Fallback to defaults
        return {
        success_rate: 90,
        return_rate: 5,
        daily_target: 100
        };
        }


        function createTopEkspedisiRanking() {
        const container = document.getElementById('topExpedisiWidget');

        if (!container) return;

        // Hitung data ekspedisi dari semua data (bulan ini)
        const courierCount = {};
        [...trackingData.resiData, ...trackingData.deliveredData, ...trackingData.returnsData].forEach(item => {
        // Filter bulan Juli 2025 (sesuai data lu)
        if (item.tanggal && item.tanggal.includes('Juli 2025')) {
            const courier = item.ekspedisi || 'Unknown';
            courierCount[courier] = (courierCount[courier] || 0) + 1;
        }
        });

        // Convert ke array dan sort
        const rankingData = Object.entries(courierCount)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5); // Top 5

        const totalPengiriman = rankingData.reduce((sum, item) => sum + item.count, 0);

        if (rankingData.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">Belum ada data ekspedisi bulan ini<\/div>';
        return;
        }

        // Generate ranking HTML
        const rankingClasses = ['gold', 'silver', 'bronze', '', ''];

        container.innerHTML = `
        <div class="ekspedisi-ranking">
            ${rankingData.map((item, index) => {
                const percentage = Math.round((item.count / totalPengiriman) * 100);
                return `
                    <div class="ranking-item">
                        <div class="ranking-number ${rankingClasses[index]}">${index + 1}<\/div>
                        <div class="ranking-info">
                            <div class="ekspedisi-name">${item.name}<\/div>
                            <div class="ekspedisi-count">${item.count} pengiriman<\/div>
                        <\/div>
                        <div class="ranking-percentage">${percentage}%<\/div>
                    <\/div>
                `;
            }).join('')}
        <\/div>
        `;
        }


        function createChartJS() {
        const ctx = document.getElementById('dashboardChart');

        if (!ctx) return;

        // Destroy existing chart first
        if (window.myChart) {
        window.myChart.destroy();
        window.myChart = null;
        }

        // Rest of the code same...
        window.myChart = new Chart(ctx, {
        // ... chart config
        });
        }

        function switchChart(type) {
        // Remove active class from all buttons
        document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));

        // Add active class to clicked button
        event.target.classList.add('active');

        // BETTER CHART DESTROY
        const ctx = document.getElementById('dashboardChart');
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
        existingChart.destroy();
        }

        // Create new chart based on type
        if (type === 'daily') {
        createDailyChart();
        } else if (type === 'weekly') {
        createWeeklyChart();
        } else {
        createCourierChart();
        }
        }

        function createCourierChart() {
        const ctx = document.getElementById('dashboardChart');

        // Data real dari trackingData
        const courierCount = {};
        [...trackingData.resiData, ...trackingData.deliveredData, ...trackingData.returnsData].forEach(item => {
        const courier = item.ekspedisi || 'Unknown';
        courierCount[courier] = (courierCount[courier] || 0) + 1;
        });

        const labels = Object.keys(courierCount);
        const data = Object.values(courierCount);

        window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Jumlah Pengiriman',
                data: data,
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(16, 185, 129, 0.8)', 
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(139, 92, 246, 0.8)'
                ],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
        });
        }

        function createDailyChart() {
        const ctx = document.getElementById('dashboardChart');

        // Destroy existing chart
        if (window.myChart) {
        window.myChart.destroy();
        window.myChart = null;
        }

        // Generate data 7 hari terakhir (dummy data dulu)
        const labels = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
        const data = [12, 19, 8, 15, 22, 11, 16]; // Dummy data

        window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Pengiriman Harian',
                data: data,
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
        });
        }    

        function createWeeklyChart() {
        const ctx = document.getElementById('dashboardChart');

        // Destroy existing chart
        if (window.myChart) {
        window.myChart.destroy();
        window.myChart = null;
        }

        // Generate data 6 minggu terakhir (dummy data)
        const labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'];
        const data = [45, 52, 38, 61, 73, 49]; // Dummy data

        window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Pengiriman Mingguan',
                data: data,
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: 'rgb(16, 185, 129)',
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
        });
        }

        // ===== PRODUCT MODAL FUNCTIONS =====
        function openAddProduct() {
        document.getElementById('addProductModal').style.display = 'flex';
        document.getElementById('productSKU').focus();
        }

        function closeAddProduct() {
        document.getElementById('addProductModal').style.display = 'none';
        // Clear form
        document.getElementById('productSKU').value = '';
        document.getElementById('productName').value = '';
        document.getElementById('productStock').value = '';
        document.getElementById('productPrice').value = '';

        // Reset mode
        window.editMode = false;
        window.editingId = null;  // ‚Üê GANTI: dari editingSKU ke editingId
        document.querySelector('.modal-title').textContent = 'üì¶ Tambah Produk Baru';
        document.querySelector('#addProductModal .btn-primary').textContent = 'Simpan Produk';
        }

        async function saveNewProduct() {
        // Get form data
        const sku = document.getElementById('productSKU').value.trim();
        const nama_barang = document.getElementById('productName').value.trim();
        const unit = document.getElementById('productUnit').value;
        const stok_awal = parseInt(document.getElementById('productStock').value) || 0;
        const harga = parseFloat(document.getElementById('productPrice').value) || 0;

        // Validation
        if (!sku || !nama_barang) {
        showToast('‚ùå SKU dan Nama Barang wajib diisi!', 'error');
        return;
        }

        const isEditMode = window.editMode || false;
        showToast(isEditMode ? 'üîÑ Mengupdate produk...' : 'üîÑ Menyimpan produk...', 'info');

        try {
        const requestData = {
            action: isEditMode ? 'update_product' : 'save_product',
            sku: sku,
            nama_barang: nama_barang,
            unit: unit,
            stok_awal: stok_awal,
            harga: harga,
            user: currentUser,
            device: currentDevice
        };

        // Tambahin ID untuk edit mode
        if (isEditMode && window.editingId) {
            requestData.id = window.editingId;  // ‚Üê GANTI: kirim id, bukan original_sku
        }

        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });

        const result = await response.json();
        if (result.success) {
            showToast(isEditMode ? '‚úÖ Produk berhasil diupdate!' : '‚úÖ Produk berhasil disimpan!', 'success');
            closeAddProduct();
            loadMasterProducts(); // Refresh table
        } else {
            showToast('‚ùå Error: ' + result.message, 'error');
        }
        } catch (error) {
        showToast('‚ùå Error: ' + error.message, 'error');
        }
        }


        // Function untuk populate dropdown produk di movement tab
        function populateProductDropdown() {
        const dropdown = document.getElementById('movementProduct');
        if (!dropdown) return;

        dropdown.innerHTML = '<option value="">Pilih Produk<\/option>';
        trackingData.productsData.forEach(product => {
        dropdown.innerHTML += `<option value="${product.sku}">${product.sku} - ${product.nama_barang}<\/option>`;
        });
        }

        // Function untuk load movement history
        async function loadMovementHistory() {
        try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_all',
                user: currentUser,
                device: currentDevice
            })
        });

        const result = await response.json();
        if (result.success) {
            updateMovementHistoryTable(result.movementsData || []);
            updateMovementLastUpdatedInfo();
        }
        } catch (error) {
        console.error('Error loading movement history:', error);
        }
        }

        function updateMovementHistoryTable(movements) {
        const tbody = document.getElementById('movementHistoryBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (movements.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">Belum ada movement.<\/td><\/tr>';
        return;
        }

        movements.forEach((movement) => {
        const row = document.createElement('tr');
        row.innerHTML = `
        <td>${movement.movement_date}<\/td>
        <td style="font-family: monospace; font-weight: 600;">${movement.sku}<\/td>
        <td>${movement.nama_barang || 'N/A'}<\/td>
        <td><span class="status-badge ${movement.type === 'in' ? 'status-delivered' : 'status-return'}">${movement.type.toUpperCase()}<\/span><\/td>
        <td>${movement.qty}<\/td>
        <td>${movement.notes || '-'}<\/td>
        <td>${movement.user || movement.created_by || 'System'}<\/td>
        <td>
            <button class="btn btn-sm btn-danger" onclick="deleteMovement('${movement.sku}')" title="Hapus">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                <\/svg>
            <\/button>
        <\/td>
        `;
        tbody.appendChild(row);
        });
        }

        // Function untuk update inventory reports
        function updateInventoryReports() {
        // Update stats di report tab
        const totalProducts = trackingData.productsData.length;
        let lowStockCount = 0;
        let totalValue = 0;

        trackingData.productsData.forEach(product => {
        const movements = trackingData.movementsData ? trackingData.movementsData.filter(m => m.sku === product.sku) : [];
        const stockIn = movements.filter(m => m.type === 'in').reduce((sum, m) => sum + parseInt(m.qty || 0), 0);
        const stockOut = movements.filter(m => m.type === 'out').reduce((sum, m) => sum + parseInt(m.qty || 0), 0);
        const currentStock = parseInt(product.stok_awal || 0) + stockIn - stockOut;

        if (currentStock <= 5) lowStockCount++;
        totalValue += currentStock * (product.harga || 0);
        });

        const reportTotalProducts = document.getElementById('reportTotalProducts');
        const reportTotalValue = document.getElementById('reportTotalValue');
        const reportLowStock = document.getElementById('reportLowStock');

        if (reportTotalProducts) reportTotalProducts.textContent = totalProducts;
        if (reportTotalValue) reportTotalValue.textContent = 'Rp ' + formatNumber(totalValue);
        if (reportLowStock) reportLowStock.textContent = lowStockCount;

        // Update semua komponen report
        updateLaporanStock();
        updateFastMovingItems();      // ‚Üê TAMBAHIN INI
        updateLowStockAlert();        // ‚Üê TAMBAHIN INI  
        updateMovementCount();        // ‚Üê TAMBAHIN INI
        updateLaporanLastUpdatedInfo();
        }



        async function loadMasterProducts() {
        try {
        const response = await fetch('database.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'load_all',
                user: currentUser,
                device: currentDevice
            })
        });

        const result = await response.json();
        if (result.success) {
            trackingData.productsData = result.productsData || [];
            
            updateMasterProductTable(result.productsData);
            populateProductDropdown();
            updateInventoryReports();
            
            // ‚úÖ TAMBAHIN INI
            updateLastUpdatedInfo();
        }
        } catch (error) {
        console.error('Error loading products:', error);
        }
        }


        function updateMasterProductTable(products) {
        const tbody = document.getElementById('masterProductTableBody');
        tbody.innerHTML = '';

        if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 2rem;">Belum ada produk.<\/td><\/tr>';
        return;
        }

        products.forEach((product) => {
        const row = document.createElement('tr');

        // Create cells one by one (lebih aman)
        const skuCell = document.createElement('td');
        skuCell.style.fontFamily = 'monospace';
        skuCell.style.fontWeight = '600';
        skuCell.textContent = product.sku;

        const namaCell = document.createElement('td');
        namaCell.textContent = product.nama_barang;

        const unitCell = document.createElement('td');
        unitCell.textContent = product.unit;

        const stokCell = document.createElement('td');
        stokCell.textContent = product.stok_awal;

        const hargaCell = document.createElement('td');
        hargaCell.textContent = 'Rp ' + formatNumber(product.harga || 0);

        const actionCell = document.createElement('td');
        actionCell.innerHTML = `
            <div class="action-buttons">
                <button class="btn btn-sm btn-secondary" onclick="editProduct(${product.id})" title="Edit">Edit<\/button>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})" title="Hapus">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                    <\/svg>
                <\/button>
            <\/div>
        `;

        row.appendChild(skuCell);
        row.appendChild(namaCell);
        row.appendChild(unitCell);
        row.appendChild(stokCell);
        row.appendChild(hargaCell);
        row.appendChild(actionCell);

        tbody.appendChild(row);
        });
        }
        </SCRIPT>
      </MAIN>
    </DIV>
  </BODY>
</HTML>
